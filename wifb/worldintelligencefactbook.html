<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark"/>
  <title>World Intelligence Factbook</title>
  <meta name="description" content="World Intelligence Factbook — offline-first country profiles with terminal-grade navigation and silent public series refresh."/>
  <style>
    :root{
      --bg:#061018;
      --panel:#0b1622;
      --panel2:#0f2133;
      --border:#1a324b;
      --text:#e7eef7;
      --muted:#9fb3c9;
      --accent:#ff8a00;
      --accent2:#3ddc97;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(255,138,0,.08), transparent 55%),
        radial-gradient(900px 600px at 82% 10%, rgba(61,220,151,.06), transparent 60%),
        linear-gradient(180deg, #061019 0%, #050c13 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:rgba(255,138,0,.92); text-decoration:none}
    a:hover{text-decoration:underline}

    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(6,16,24,.72);
      border-bottom:1px solid rgba(26,50,75,.85);
    }
    .topbar-inner{
      max-width: 1560px;
      margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width: 320px;}
    .logo{
      width:44px; height:44px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,138,0,.95), rgba(255,138,0,.15));
      border:1px solid rgba(255,138,0,.35);
      box-shadow: 0 14px 40px rgba(255,138,0,.15);
      display:grid; place-items:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.3px; line-height:1.05}
    .brand .sub{margin-top:4px; font-family:var(--mono); font-size:11px; color:var(--muted)}

    .cmd{
      flex:1;
      display:flex; gap:10px; align-items:center; justify-content:center;
      max-width: 820px;
    }
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.85);
      background: rgba(11,22,34,.78);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
      width: 100%;
      max-width: 560px;
    }
    .pill label{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      letter-spacing:.25px;
      white-space:nowrap;
    }
    .pill input{
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-family:var(--mono);
      font-size:12px;
      width:100%;
    }
    .chip{
      font-family:var(--mono);
      font-size:11px;
      color: rgba(255,255,255,.78);
      border:1px solid rgba(26,50,75,.85);
      background: rgba(15,33,51,.72);
      padding:9px 11px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:hover{border-color: rgba(255,138,0,.45)}
    .kbd{
      font-family:var(--mono);
      font-size:10px;
      color: rgba(255,255,255,.75);
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      padding:4px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .rightmeta{
      display:flex; align-items:center; gap:10px;
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      white-space:nowrap;
      min-width: 340px;
      justify-content:flex-end;
    }

    .wrap{max-width:1560px; margin:0 auto; padding:14px;}
    .grid{
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      .rightmeta{display:none}
      .brand{min-width:auto}
      .cmd{justify-content:flex-start}
    }

    .panel{
      border:1px solid rgba(26,50,75,.85);
      background: rgba(11,22,34,.78);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: linear-gradient(180deg, rgba(15,33,51,.55), rgba(11,22,34,.35));
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .panel-h h2{margin:0; font-size:13px; letter-spacing:.2px}
    .hint{color:var(--muted); font-family:var(--mono); font-size:11px; line-height:1.35; margin-top:6px;}
    .panel-b{padding:12px;}

    .seg{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .seg .s{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      font-family:var(--mono);
      font-size:11px;
      cursor:pointer;
      user-select:none;
      color: rgba(255,255,255,.78);
    }
    .seg .s.active{
      border-color: rgba(255,138,0,.55);
      background: rgba(255,138,0,.08);
      color: rgba(255,138,0,.95);
    }

    .list{
      display:flex; flex-direction:column; gap:8px;
      max-height: calc(100vh - 270px);
      overflow:auto;
      padding-right:4px;
      margin-top:10px;
    }
    .row{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(15,33,51,.35);
      border-radius: 14px;
      padding:10px 10px;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .row:hover{border-color: rgba(255,138,0,.35); transform: translateY(-1px)}
    .row.active{
      border-color: rgba(255,138,0,.55);
      background: rgba(255,138,0,.08);
    }
    .row .name{font-size:12px; letter-spacing:.2px; line-height:1.2}
    .row .meta{font-family:var(--mono); font-size:11px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .tag{
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.75);
    }
    .tag.accent{border-color: rgba(255,138,0,.35); color: rgba(255,138,0,.95); background: rgba(255,138,0,.06)}

    .hero{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: radial-gradient(1000px 500px at 15% 0%, rgba(255,138,0,.09), transparent 50%),
                  radial-gradient(900px 450px at 85% 10%, rgba(61,220,151,.06), transparent 55%),
                  linear-gradient(180deg, rgba(15,33,51,.5), rgba(11,22,34,.25));
    }
    .hero-top{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .hero h3{margin:0; font-size:18px; letter-spacing:.3px}
    .subline{font-family:var(--mono); color:var(--muted); font-size:11px; line-height:1.35; margin-top:6px}
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
    }
    .btn:hover{border-color: rgba(255,138,0,.45)}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 560px){ .kpis{grid-template-columns: 1fr} }
    .kpi{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      border-radius: 16px;
      padding:10px 10px;
      min-height:64px;
    }
    .kpi .k{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .kpi .v{margin-top:6px; font-size:12px; line-height:1.25}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: rgba(11,22,34,.65);
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      color: rgba(255,255,255,.8);
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .tab.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .content{
      padding:12px;
      display:grid;
      grid-template-columns: 1.22fr .78fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){ .content{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.30);
      border-radius: 16px;
      overflow:hidden;
    }
    .card-h{
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.55);
      background: rgba(7,16,24,.45);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-h b{font-size:12px; letter-spacing:.2px}
    .card-h span{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .card-b{padding:10px 12px}

    .notice{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      padding:10px 12px;
      border-radius: 16px;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.45;
      color: rgba(255,255,255,.85);
    }
    .notice.accent{
      border-color: rgba(255,138,0,.35);
      background: rgba(255,138,0,.08);
    }
    .small{font-family:var(--mono); font-size:10px; color: var(--muted); line-height:1.4}
    .loading{display:inline-flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; color: var(--muted);}
    .spin{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,138,0,.9);
      animation: rot .9s linear infinite;
    }
    @keyframes rot{to{transform: rotate(360deg)}}

    .viewerWrap{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.35);
      border-radius: 16px;
      overflow:hidden;
    }
    .viewerTop{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.55);
      background: rgba(7,16,24,.45);
      flex-wrap:wrap;
    }
    .viewerTop .mini{
      font-family:var(--mono);
      font-size:11px;
      color: rgba(255,255,255,.82);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .mini b{color: rgba(255,138,0,.95)}
    iframe{
      width:100%;
      height: min(78vh, 860px);
      border:0;
      background: #000;
    }

    .cp-backdrop{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding: 80px 14px 14px;
    }
    .cp{
      width: min(900px, 100%);
      border:1px solid rgba(26,50,75,.9);
      border-radius: 18px;
      background: rgba(11,22,34,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .cp-top{
      padding:12px;
      border-bottom:1px solid rgba(26,50,75,.65);
      display:flex; gap:10px; align-items:center;
    }
    .cp-top span{font-family:var(--mono); font-size:11px; color: var(--muted)}
    .cp-top input{
      border:none; outline:none; background:transparent;
      color:var(--text); font-family:var(--mono); font-size:12px;
      width:100%;
    }
    .cp-list{max-height: 440px; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:8px}
    .cp-item{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      border-radius: 14px;
      padding:10px 10px;
      cursor:pointer;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .cp-item:hover{border-color: rgba(255,138,0,.35)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">WIB</div>
        <div>
          <h1>World Intelligence Factbook</h1>
          <div class="sub">offline reference library • your hosted sources • silent public series refresh</div>
        </div>
      </div>

      <div class="cmd">
        <div class="pill" title="Search entities. Enter opens best match.">
          <label>FIND</label>
          <input id="q" placeholder="type: germany / gm / japan / …   (Ctrl+K palette)"/>
        </div>
        <div class="chip" id="cmdBtn" title="Command palette">
          <span>COMMAND</span>
          <span class="kbd">Ctrl K</span>
        </div>
      </div>

      <div class="rightmeta">
        <span class="muted">entities:</span> <span id="count">0</span>
        <span class="muted">|</span>
        <span id="status">loading wifbindex.html…</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Navigator</h2>
            <div class="hint">
              Sources are loaded locally from this site. Regions are taken from the index selector where present.
              Scenario lenses reorder recommended section jumps (content remains canonical).
            </div>
            <div class="seg" id="lenses"></div>
          </div>
          <button class="btn" id="reload">reload</button>
        </div>
        <div class="panel-b">
          <div class="seg" id="regions"></div>
          <div class="list" id="list"></div>
          <div class="small" style="margin-top:10px">
            Structure expected at root: <span class="muted">geos/</span>, <span class="muted">fields/</span>, <span class="muted">stylesheets/</span>, <span class="muted">javascripts/</span>, <span class="muted">docs/</span>, <span class="muted">appendix/</span>, …
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hero">
          <div class="hero-top">
            <div>
              <h3 id="title">Select an entity</h3>
              <div class="subline" id="subline">Fast search → open source page → use section jumps (lens-ordered).</div>
            </div>
            <div class="actions">
              <button class="btn" id="copyLink">copy link</button>
              <button class="btn" id="openPage">open page</button>
            </div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="k">CODE</div><div class="v" id="k_code">—</div></div>
            <div class="kpi"><div class="k">REGION</div><div class="v" id="k_region">—</div></div>
            <div class="kpi"><div class="k">ISO (extracted)</div><div class="v" id="k_iso">—</div></div>
            <div class="kpi"><div class="k">CURRENT SNAPSHOT</div><div class="v" id="k_now">—</div></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="read">READ</div>
          <div class="tab" data-tab="sections">SECTIONS</div>
          <div class="tab" data-tab="search">IN-PAGE SEARCH</div>
        </div>

        <div class="content">
          <div class="card">
            <div class="card-h">
              <b id="mainTitle">Country profile</b>
              <span id="mainMeta">—</span>
            </div>
            <div class="card-b" id="main">
              <div class="notice accent">
                This is the front door. The underlying source pages are rendered below using your local site structure.
                Select a country; the page loads with all local assets.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <b>Quick navigation</b>
              <span>lens-ordered</span>
            </div>
            <div class="card-b">
              <div class="notice">
                <b>Keyboard</b><br/>
                • <span class="muted">/</span> focus FIND<br/>
                • <span class="muted">Enter</span> open best match<br/>
                • <span class="muted">Ctrl+K</span> command palette<br/>
                • <span class="muted">Esc</span> close palette
              </div>
              <div style="margin-top:12px" id="secNav"></div>
              <div style="margin-top:12px" id="pageSearchBox"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Command palette -->
  <div class="cp-backdrop" id="cpBack">
    <div class="cp" role="dialog" aria-modal="true" aria-label="Command palette">
      <div class="cp-top">
        <span>CMD</span>
        <input id="cpQ" placeholder="type a country, region, or command: 'lens macro', 'open germany' …"/>
        <span class="kbd">Esc</span>
      </div>
      <div class="cp-list" id="cpList"></div>
    </div>
  </div>

<script>
(() => {
  // ====== Configuration ======
  // Everything is hosted in the same root as this file.
  // The index selector page is named wifbindex.html (at root).
  const INDEX_PAGE = "wifbindex.html";

  // Lens ordering (reorders section jump suggestions only)
  const LENS_ORDER = {
    "Core": ["Introduction","Government","Economy","People and Society","Geography","Energy","Communications","Transportation","Military and Security","Transnational Issues"],
    "GeoRisk": ["Military and Security","Transnational Issues","Government","Energy","Economy","Transportation","Communications","People and Society","Geography","Introduction"],
    "Macro": ["Economy","Energy","Government","Transportation","Communications","People and Society","Geography","Transnational Issues","Military and Security","Introduction"],
    "Infrastructure": ["Transportation","Communications","Energy","Government","Economy","People and Society","Geography","Introduction","Transnational Issues","Military and Security"]
  };

  // Silent public series refresh (no errors shown; blank if unavailable)
  // ISO codes are extracted from the underlying source page text when possible.
  const WB = {
    base: "https://api.worldbank.org/v2/country",
    indicators: [
      { key: "NY.GDP.MKTP.CD", label: "GDP", fmt: v => fmtNum(v) },
      { key: "FP.CPI.TOTL.ZG", label: "Infl", fmt: v => `${fmtNum(v)}%` },
      { key: "SP.POP.TOTL",    label: "Pop", fmt: v => fmtNum(v) }
    ],
    yearMax: 2026
  };

  // ====== State ======
  const state = {
    lens: "Core",
    region: "",
    tab: "read",
    entities: [],      // { code, name, href, regionLabel }
    active: null,      // same
    activeHtml: "",
    activeIso: null    // {a2, a3}
  };

  // ====== DOM ======
  const $ = s => document.querySelector(s);
  const el = {
    q: $("#q"),
    count: $("#count"),
    status: $("#status"),

    lenses: $("#lenses"),
    regions: $("#regions"),
    list: $("#list"),

    title: $("#title"),
    subline: $("#subline"),
    k_code: $("#k_code"),
    k_region: $("#k_region"),
    k_iso: $("#k_iso"),
    k_now: $("#k_now"),

    mainTitle: $("#mainTitle"),
    mainMeta: $("#mainMeta"),
    main: $("#main"),
    secNav: $("#secNav"),
    pageSearchBox: $("#pageSearchBox"),

    reload: $("#reload"),
    copyLink: $("#copyLink"),
    openPage: $("#openPage"),

    tabs: document.querySelectorAll(".tab[data-tab]"),

    cmdBtn: $("#cmdBtn"),
    cpBack: $("#cpBack"),
    cpQ: $("#cpQ"),
    cpList: $("#cpList"),
  };

  // ====== Helpers ======
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtNum(x){
    if (x === null || x === undefined) return "—";
    const n = Number(String(x).replace(/,/g,""));
    if (!isFinite(n)) return String(x);
    return n.toLocaleString(undefined);
  }

  function deepLink(code){
    const u = new URL(location.href);
    u.searchParams.set("c", code);
    return u.toString();
  }

  function setTab(tab){
    state.tab = tab;
    el.tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === tab));
    if (state.active) renderActive();
  }

  function lensOrderedSectionNames(names){
    const pref = LENS_ORDER[state.lens] || LENS_ORDER.Core;
    const set = new Set(names);
    const top = pref.filter(x => set.has(x));
    const rest = names.filter(x => !top.includes(x));
    return [...top, ...rest];
  }

  async function fetchText(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }

  // Normalize hrefs to be project-site safe (relative paths, no leading "/")
  function normalizeHref(v){
    if (!v) return "";
    if (v.startsWith("http")) return v;
    return v.replace(/^\.\//, "").replace(/^\//, "");
  }

  // ====== Index parsing ======
  function parseEntitiesFromIndex(html){
    const doc = new DOMParser().parseFromString(html, "text/html");

    const selects = Array.from(doc.querySelectorAll("select"));
    const sel = selects.find(s => s.querySelector('option[value*="geos/"]')) || selects[0];
    if (!sel) return [];

    const out = [];
    const children = Array.from(sel.children).filter(n => n.tagName === "OPTGROUP" || n.tagName === "OPTION");

    for (const node of children){
      if (node.tagName === "OPTGROUP"){
        const label = node.getAttribute("label") || "";
        for (const opt of Array.from(node.querySelectorAll("option"))){
          const v = opt.getAttribute("value") || "";
          if (!v.includes("geos/")) continue;
          const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
          if (!code) continue;
          out.push({
            code,
            name: (opt.textContent || "").trim() || code.toUpperCase(),
            href: normalizeHref(v),
            regionLabel: label || ""
          });
        }
      } else {
        const v = node.getAttribute("value") || "";
        if (!v.includes("geos/")) continue;
        const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
        if (!code) continue;
        out.push({
          code,
          name: (node.textContent || "").trim() || code.toUpperCase(),
          href: normalizeHref(v),
          regionLabel: ""
        });
      }
    }

    const seen = new Set();
    const clean = out.filter(x => {
      if (seen.has(x.code)) return false;
      seen.add(x.code);
      return true;
    });

    clean.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    return clean;
  }

  // ====== ISO extraction from source page text ======
  function extractISOFromHtml(countryHtml){
    const doc = new DOMParser().parseFromString(countryHtml, "text/html");
    const text = doc.body?.innerText || "";

    const isoLine = text.match(/ISO\s*3166\s*country\s*codes?\s*:\s*([^\n\r]+)/i)?.[1] || null;
    if (!isoLine) return null;

    const a2 = isoLine.match(/Alpha-?2\s*:\s*([A-Z]{2})/i)?.[1]?.toUpperCase() || null;
    const a3 = isoLine.match(/Alpha-?3\s*:\s*([A-Z]{3})/i)?.[1]?.toUpperCase() || null;
    if (!a2 && !a3) return null;
    return { a2, a3 };
  }

  // ====== Silent public snapshot ======
  async function wbLatest(iso3, indicator){
    const url = `${WB.base}/${encodeURIComponent(iso3)}/indicator/${encodeURIComponent(indicator)}?format=json&per_page=20000`;
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const data = Array.isArray(j) ? j[1] : null;
    if (!Array.isArray(data)) return null;

    const rows = data
      .filter(d => d && d.value !== null && d.date && Number(d.date) <= WB.yearMax)
      .sort((a,b) => Number(b.date) - Number(a.date));
    if (!rows.length) return null;
    return { year: Number(rows[0].date), value: rows[0].value };
  }

  async function silentSnapshot(iso){
    try{
      if (!iso?.a3) return null;
      const parts = [];
      for (const ind of WB.indicators){
        const last = await wbLatest(iso.a3, ind.key);
        if (last) parts.push(`${ind.label} ${last.year}: ${ind.fmt(last.value)}`);
      }
      return parts.length ? parts.join(" • ") : null;
    } catch {
      return null;
    }
  }

  // ====== Rendering ======
  function renderLenses(){
    const lenses = ["Core","GeoRisk","Macro","Infrastructure"];
    el.lenses.innerHTML = lenses.map(l => `
      <div class="s ${l===state.lens?"active":""}" data-lens="${escapeHtml(l)}">LENS: ${escapeHtml(l)}</div>
    `).join("");
    el.lenses.querySelectorAll("[data-lens]").forEach(b => {
      b.addEventListener("click", () => {
        state.lens = b.getAttribute("data-lens");
        renderLenses();
        if (state.active) renderActive();
      });
    });
  }

  function renderRegions(){
    const labels = Array.from(new Set(state.entities.map(e => e.regionLabel).filter(Boolean))).sort();
    const all = [{k:"", t:"all"}].concat(labels.map(x => ({k:x, t:x})));
    el.regions.innerHTML = all.map(x => `
      <div class="s ${x.k===state.region?"active":""}" data-region="${escapeHtml(x.k)}">${escapeHtml(x.t)}</div>
    `).join("");
    el.regions.querySelectorAll("[data-region]").forEach(b => {
      b.addEventListener("click", () => {
        state.region = b.getAttribute("data-region") || "";
        renderRegions();
        renderList();
      });
    });
  }

  function renderList(){
    const q = (el.q.value || "").trim().toLowerCase();
    const reg = state.region || "";
    const rows = state.entities
      .filter(e => {
        if (reg && e.regionLabel !== reg) return false;
        if (!q) return true;
        return (e.name||"").toLowerCase().includes(q) || (e.code||"").toLowerCase().includes(q);
      })
      .slice(0, 950);

    el.list.innerHTML = rows.length ? rows.map(e => {
      const active = state.active?.code === e.code ? "active" : "";
      return `
        <div class="row ${active}" data-code="${escapeHtml(e.code)}">
          <div>
            <div class="name">${escapeHtml(e.name)}</div>
            <div class="meta">
              <span class="tag">${escapeHtml(e.code)}</span>
              <span class="tag">${escapeHtml(e.regionLabel || "—")}</span>
            </div>
          </div>
          <div class="meta"><span class="tag accent">OPEN</span></div>
        </div>
      `;
    }).join("") : `<div class="notice accent">No matches. Clear region filter or broaden query.</div>`;

    el.list.querySelectorAll(".row").forEach(r => {
      r.addEventListener("click", () => selectCountry(r.getAttribute("data-code")));
    });
  }

  function renderSectionNavFromHtml(countryHtml){
    const doc = new DOMParser().parseFromString(countryHtml, "text/html");

    const anchors = Array.from(doc.querySelectorAll('a[href^="#"]'))
      .map(a => ({ href: a.getAttribute("href"), text: (a.textContent || "").trim() }))
      .filter(x => x.href && x.text && x.text.length <= 40);

    const known = ["Introduction","Geography","People and Society","Government","Economy","Energy","Communications","Transportation","Military and Security","Transnational Issues"];
    const found = [];
    for (const k of known){
      const hit = anchors.find(a => a.text.toLowerCase() === k.toLowerCase());
      if (hit) found.push({ name: k, href: hit.href });
    }

    const orderedNames = lensOrderedSectionNames(found.map(x => x.name));
    const ordered = orderedNames.map(n => found.find(x => x.name === n)).filter(Boolean);

    el.secNav.innerHTML = `
      <div class="notice">
        <b>Section jumps</b><br/>
        Ordered by lens: <span class="muted">${escapeHtml(state.lens)}</span>
      </div>
      <div class="seg" style="margin-top:10px">
        ${ordered.map(s => `<div class="s" data-jump="${escapeHtml(s.href)}">${escapeHtml(s.name)}</div>`).join("")}
      </div>
      <div class="small" style="margin-top:10px">
        Jumps scroll inside the embedded page.
      </div>
    `;

    el.secNav.querySelectorAll("[data-jump]").forEach(b => {
      b.addEventListener("click", () => {
        const href = b.getAttribute("data-jump");
        const frame = document.querySelector("iframe#wifbFrame");
        if (!frame || !state.active) return;
        try{
          const base = state.active.href.split("#")[0];
          frame.src = base + href;
        } catch {}
      });
    });
  }

  function renderInPageSearch(countryHtml){
    const doc = new DOMParser().parseFromString(countryHtml, "text/html");
    const text = doc.body?.innerText || "";

    el.pageSearchBox.innerHTML = `
      <div class="notice">
        <b>In-page search</b><br/>
        Searches the page text (fast). Empty means “no matches”.
      </div>
      <div style="margin-top:10px">
        <input id="inQ" style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(26,50,75,.75); background: rgba(7,16,24,.55); color: var(--text); font-family: var(--mono); font-size:12px; outline:none" placeholder="e.g. 'unemployment', 'railways', 'religion', 'border disputes'"/>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-h"><b>Matches</b><span id="inMeta">—</span></div>
        <div class="card-b" id="inRes"><div class="notice">No query yet.</div></div>
      </div>
    `;

    const input = $("#inQ");
    const meta = $("#inMeta");
    const out = $("#inRes");

    const lines = text.split("\n").map(x => x.trim()).filter(Boolean);

    input.addEventListener("input", () => {
      const q = (input.value || "").trim().toLowerCase();
      if (!q){
        meta.textContent = "—";
        out.innerHTML = `<div class="notice">No query yet.</div>`;
        return;
      }
      const hits = [];
      for (let i=0; i<lines.length; i++){
        if (lines[i].toLowerCase().includes(q)){
          hits.push(lines[i]);
          if (hits.length >= 80) break;
        }
      }
      meta.textContent = `${hits.length} matches (showing up to 80)`;
      out.innerHTML = hits.length
        ? hits.map(t => `<div class="notice" style="margin-bottom:8px">${escapeHtml(t)}</div>`).join("")
        : `<div class="notice accent">No matches for '${escapeHtml(q)}'.</div>`;
    });
  }

  function renderActive(){
    if (!state.active) return;

    el.mainTitle.textContent = "Country profile";
    el.mainMeta.textContent = `source: ${state.active.href}`;

    if (state.tab === "read"){
      el.main.innerHTML = `
        <div class="viewerWrap">
          <div class="viewerTop">
            <div class="mini">
              <span>OPEN:</span>
              <b>${escapeHtml(state.active.name)}</b>
              <span class="tag">${escapeHtml(state.active.code)}</span>
              <span class="tag">${escapeHtml(state.active.regionLabel || "—")}</span>
            </div>
            <div class="mini">
              <span class="kbd">Lens</span>
              <span>${escapeHtml(state.lens)}</span>
            </div>
          </div>
          <iframe id="wifbFrame" src="${escapeHtml(state.active.href)}"></iframe>
        </div>
      `;
      renderSectionNavFromHtml(state.activeHtml || "");
      el.pageSearchBox.innerHTML = `<div class="notice">Switch to IN-PAGE SEARCH to interrogate the full text.</div>`;
      return;
    }

    if (state.tab === "sections"){
      el.main.innerHTML = `
        <div class="notice accent">
          Sections are navigation. Use the jump pills on the right, or open the embedded page and scroll.
        </div>
        <div class="notice" style="margin-top:10px">
          You can also use <span class="muted">Ctrl+K</span> and type “lens macro” to reorder.
        </div>
      `;
      renderSectionNavFromHtml(state.activeHtml || "");
      el.pageSearchBox.innerHTML = `<div class="notice">Switch to IN-PAGE SEARCH for full-text retrieval.</div>`;
      return;
    }

    if (state.tab === "search"){
      el.main.innerHTML = `
        <div class="notice accent">
          In-page search operates on the rendered page text. It is fast and deterministic.
        </div>
      `;
      renderSectionNavFromHtml(state.activeHtml || "");
      renderInPageSearch(state.activeHtml || "");
      return;
    }
  }

  async function selectCountry(code){
    const e = state.entities.find(x => x.code === code);
    if (!e) return;

    state.active = e;
    renderList();

    el.title.textContent = e.name;
    el.subline.textContent = `code=${e.code} • region=${e.regionLabel || "—"} • lens=${state.lens}`;
    el.k_code.textContent = e.code;
    el.k_region.textContent = e.regionLabel || "—";
    el.k_iso.textContent = "—";
    el.k_now.textContent = "—";

    try{
      const html = await fetchText(e.href);
      state.activeHtml = html;

      const iso = extractISOFromHtml(html);
      state.activeIso = iso;
      el.k_iso.textContent = iso ? `${iso.a2 || "—"} / ${iso.a3 || "—"}` : "—";

      const snap = await silentSnapshot(iso);
      el.k_now.textContent = snap || "—";
    } catch {
      state.activeHtml = "";
      state.activeIso = null;
      el.k_iso.textContent = "—";
      el.k_now.textContent = "—";
    }

    renderActive();
    history.replaceState(null, "", deepLink(e.code));
  }

  // ====== Command palette ======
  function openCP(){ el.cpBack.style.display = "flex"; el.cpQ.value = ""; renderCP(""); el.cpQ.focus(); }
  function closeCP(){ el.cpBack.style.display = "none"; }

  function renderCP(q){
    const needle = (q||"").trim().toLowerCase();

    const commands = [
      { t: "Lens: Core", a: ()=>{state.lens="Core"; renderLenses(); if(state.active) renderActive(); closeCP();} },
      { t: "Lens: GeoRisk", a: ()=>{state.lens="GeoRisk"; renderLenses(); if(state.active) renderActive(); closeCP();} },
      { t: "Lens: Macro", a: ()=>{state.lens="Macro"; renderLenses(); if(state.active) renderActive(); closeCP();} },
      { t: "Lens: Infrastructure", a: ()=>{state.lens="Infrastructure"; renderLenses(); if(state.active) renderActive(); closeCP();} },
      { t: "Tab: Read", a: ()=>{setTab("read"); closeCP();} },
      { t: "Tab: Sections", a: ()=>{setTab("sections"); closeCP();} },
      { t: "Tab: In-page search", a: ()=>{setTab("search"); closeCP();} },
      { t: "Reload index", a: ()=>{boot(); closeCP();} },
    ];

    const countries = state.entities
      .filter(e => !needle || e.name.toLowerCase().includes(needle) || e.code.toLowerCase().includes(needle) || (e.regionLabel||"").toLowerCase().includes(needle))
      .slice(0, 28)
      .map(e => ({ t:`Open: ${e.name} (${e.code})`, a: ()=>{selectCountry(e.code); closeCP();} }));

    let pool = commands.concat(countries);

    if (needle.startsWith("open ")){
      const k = needle.replace(/^open\s+/,"").trim();
      const best = state.entities.find(e => e.name.toLowerCase().includes(k)) || state.entities.find(e => e.code.toLowerCase() === k);
      if (best) pool = [{ t:`Open: ${best.name} (${best.code})`, a: ()=>{selectCountry(best.code); closeCP();} }].concat(commands);
    }
    if (needle.startsWith("lens ")){
      const k = needle.replace(/^lens\s+/,"").trim();
      const map = { core:"Core", georisk:"GeoRisk", macro:"Macro", infrastructure:"Infrastructure" };
      const hit = map[k];
      if (hit) pool = [{ t:`Lens: ${hit}`, a: ()=>{state.lens=hit; renderLenses(); if(state.active) renderActive(); closeCP();} }].concat(commands);
    }

    el.cpList.innerHTML = pool.length ? pool.map((x,i)=>`
      <div class="cp-item" data-i="${i}">
        <div>${escapeHtml(x.t)}</div>
        <div class="kbd">Enter</div>
      </div>
    `).join("") : `<div class="notice accent">No matches.</div>`;

    el.cpList.querySelectorAll(".cp-item").forEach(it => {
      it.addEventListener("click", () => pool[Number(it.getAttribute("data-i"))]?.a?.());
    });

    el.cpQ.onkeydown = (ev) => {
      if (ev.key === "Escape"){ closeCP(); return; }
      if (ev.key === "Enter"){ pool[0]?.a?.(); return; }
    };
  }

  // ====== Boot ======
  async function boot(){
    el.status.textContent = `loading ${INDEX_PAGE}…`;
    el.list.innerHTML = `<div class="loading"><span class="spin"></span><span>Loading index…</span></div>`;

    try{
      const html = await fetchText(INDEX_PAGE);
      state.entities = parseEntitiesFromIndex(html);

      el.count.textContent = String(state.entities.length);
      el.status.textContent = `source: ${INDEX_PAGE}`;

      renderLenses();
      renderRegions();
      renderList();

      const code = new URL(location.href).searchParams.get("c");
      if (code) selectCountry(code.toLowerCase());
    } catch {
      el.status.textContent = `missing ${INDEX_PAGE}`;
      el.list.innerHTML = `
        <div class="notice accent">
          Could not load <span class="muted">${escapeHtml(INDEX_PAGE)}</span>.<br/><br/>
          Ensure <span class="muted">wifbindex.html</span> is present in the same directory as this page, and that
          <span class="muted">geos/</span> is accessible.
        </div>
      `;
    }
  }

  // ====== Wiring ======
  renderLenses();

  el.reload.addEventListener("click", boot);

  el.q.addEventListener("input", renderList);
  el.q.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter"){
      const q = (el.q.value||"").trim().toLowerCase();
      if (!q) return;
      const best =
        state.entities.find(e => e.code.toLowerCase() === q) ||
        state.entities.find(e => e.name.toLowerCase().startsWith(q)) ||
        state.entities.find(e => e.name.toLowerCase().includes(q));
      if (best) selectCountry(best.code);
    }
  });

  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.getAttribute("data-tab"))));

  el.copyLink.addEventListener("click", async () => {
    if (!state.active) return;
    const link = deepLink(state.active.code);
    try{
      await navigator.clipboard.writeText(link);
      el.copyLink.textContent = "copied";
      setTimeout(()=> el.copyLink.textContent = "copy link", 900);
    } catch { alert(link); }
  });

  el.openPage.addEventListener("click", () => {
    if (!state.active) return;
    window.open(state.active.href, "_blank");
  });

  window.addEventListener("keydown", (ev) => {
    if (ev.key === "/" && !ev.ctrlKey && !ev.metaKey && !ev.altKey){
      ev.preventDefault();
      el.q.focus();
    }
    if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === "k"){
      ev.preventDefault();
      openCP();
    }
    if (ev.key === "Escape"){
      if (el.cpBack.style.display === "flex") closeCP();
    }
  });

  el.cmdBtn.addEventListener("click", openCP);
  el.cpBack.addEventListener("click", (ev) => { if (ev.target === el.cpBack) closeCP(); });
  el.cpQ.addEventListener("input", () => renderCP(el.cpQ.value));

  boot();
})();
</script>
</body>
</html>
