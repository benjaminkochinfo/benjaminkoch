<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark"/>
  <title>World Intelligence Factbook</title>
  <meta name="description" content="World Intelligence Factbook — redesigned country intelligence library with source-text retrieval and silent current-series refresh."/>
  <style>
    :root{
      --bg:#061018;
      --panel:#0b1622;
      --panel2:#0f2133;
      --border:#1a324b;
      --text:#e7eef7;
      --muted:#9fb3c9;
      --accent:#ff8a00;
      --accent2:#3ddc97;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(255,138,0,.08), transparent 55%),
        radial-gradient(900px 600px at 82% 10%, rgba(61,220,151,.06), transparent 60%),
        linear-gradient(180deg, #061019 0%, #050c13 100%);
      color:var(--text);
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(6,16,24,.72);
      border-bottom:1px solid rgba(26,50,75,.85);
    }
    .topbar-inner{
      max-width: 1560px;
      margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:44px; height:44px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,138,0,.95), rgba(255,138,0,.15));
      border:1px solid rgba(255,138,0,.35);
      box-shadow: 0 14px 40px rgba(255,138,0,.15);
      display:grid; place-items:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.3px; line-height:1.05}
    .brand .sub{margin-top:4px; font-family:var(--mono); font-size:11px; color:var(--muted)}
    .meta{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
      white-space:nowrap;
    }

    .wrap{max-width:1560px; margin:0 auto; padding:14px;}
    .grid{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid rgba(26,50,75,.85);
      background: rgba(11,22,34,.78);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: linear-gradient(180deg, rgba(15,33,51,.55), rgba(11,22,34,.35));
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .panel-h h2{margin:0; font-size:13px; letter-spacing:.2px}
    .hint{color:var(--muted); font-family:var(--mono); font-size:11px; line-height:1.35; margin-top:6px;}
    .panel-b{padding:12px;}

    label.small{
      font-family:var(--mono);
      font-size:10px;
      color: var(--muted);
      display:block;
      margin:0 0 6px 2px;
    }
    select, input{
      width:100%;
      border:1px solid rgba(26,50,75,.85);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:12px;
    }
    input::placeholder{color: rgba(159,179,201,.75)}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .row2{grid-template-columns:1fr} }

    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:9px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .btn:hover{border-color: rgba(255,138,0,.45)}

    .hero{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: radial-gradient(1000px 500px at 15% 0%, rgba(255,138,0,.09), transparent 50%),
                  radial-gradient(900px 450px at 85% 10%, rgba(61,220,151,.06), transparent 55%),
                  linear-gradient(180deg, rgba(15,33,51,.5), rgba(11,22,34,.25));
    }
    .hero-top{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .hero h3{margin:0; font-size:18px; letter-spacing:.3px}
    .subline{font-family:var(--mono); color:var(--muted); font-size:11px; line-height:1.35; margin-top:6px}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 560px){ .kpis{grid-template-columns: 1fr} }
    .kpi{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      border-radius: 16px;
      padding:10px 10px;
      min-height:64px;
    }
    .kpi .k{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .kpi .v{margin-top:6px; font-size:12px; line-height:1.25}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: rgba(11,22,34,.65);
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      color: rgba(255,255,255,.8);
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .tab.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .content{
      padding:12px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){ .content{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.30);
      border-radius: 16px;
      overflow:hidden;
    }
    .card-h{
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.55);
      background: rgba(7,16,24,.45);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card-h b{font-size:12px; letter-spacing:.2px}
    .card-h span{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .card-b{padding:10px 12px}

    .pillrow{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px}
    .pill{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .pill:hover{border-color: rgba(255,138,0,.45)}
    .pill.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .kv{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:10px 14px;
      padding:8px 0;
      border-bottom:1px dashed rgba(26,50,75,.45);
    }
    .kv:last-child{border-bottom:none}
    @media (max-width: 720px){ .kv{grid-template-columns:1fr} }
    .kv .k{font-family:var(--mono); font-size:11px; color: rgba(255,255,255,.78); line-height:1.35;}
    .kv .v{font-size:12px; color: rgba(231,238,247,.95); line-height:1.45; white-space:pre-wrap;}

    .notice{
      border:1px solid rgba(255,138,0,.35);
      background: rgba(255,138,0,.08);
      padding:10px 12px;
      border-radius: 16px;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.45;
      color: rgba(255,255,255,.85);
    }
    .flagBox{
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.35);
      border-radius: 16px;
      padding:12px;
      min-height:160px;
    }
    .flagBox img{
      max-width:100%;
      height:auto;
      border-radius: 12px;
      border:1px solid rgba(26,50,75,.65);
    }

    .loading{display:inline-flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; color: var(--muted);}
    .spin{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,138,0,.9);
      animation: rot .9s linear infinite;
    }
    @keyframes rot{to{transform: rotate(360deg)}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">WIB</div>
        <div>
          <h1>World Intelligence Factbook</h1>
          <div class="sub">Drop-down navigation • structured fields • generated summaries • silent comparisons</div>
        </div>
      </div>
      <div class="meta">
        <span id="status">loading…</span>
        <span class="muted">|</span>
        <span class="muted">entities:</span> <span id="count">0</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: dropdown navigator -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Navigator</h2>
            <div class="hint">Choose region and entity. Everything is rendered inside this redesigned layer.</div>
          </div>
          <div class="btns">
            <button class="btn" id="reload">reload</button>
            <button class="btn" id="copyLink">copy link</button>
          </div>
        </div>
        <div class="panel-b">
          <div class="row2">
            <div>
              <label class="small">Region</label>
              <select id="region"><option value="">All</option></select>
            </div>
            <div>
              <label class="small">Search</label>
              <input id="q" placeholder="Type country name or code…"/>
            </div>
          </div>

          <div style="margin-top:10px">
            <label class="small">Entity</label>
            <select id="country"><option value="">Select…</option></select>
          </div>

          <div style="margin-top:10px" class="notice" id="navNote">
            Select an entity to render its structured profile, travel-relevant fields, flag description, and comparison view.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hero">
          <div class="hero-top">
            <div>
              <h3 id="title">Select an entity</h3>
              <div class="subline" id="subline">Facts are extracted from the underlying profile page and rendered into a modern layout.</div>
            </div>
            <div class="btns">
              <button class="btn" id="clearCache">clear cache</button>
            </div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="k">CODE</div><div class="v" id="k_code">—</div></div>
            <div class="kpi"><div class="k">REGION</div><div class="v" id="k_region">—</div></div>
            <div class="kpi"><div class="k">PROFILE DEPTH</div><div class="v" id="k_depth">—</div></div>
            <div class="kpi"><div class="k">CURRENT SNAPSHOT</div><div class="v" id="k_now">—</div></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="profile">PROFILE</div>
          <div class="tab" data-tab="travel">TRAVEL</div>
          <div class="tab" data-tab="flags">FLAGS</div>
          <div class="tab" data-tab="compare">COMPARE</div>
        </div>

        <div class="content">
          <div class="card">
            <div class="card-h">
              <b id="mainTitle">Profile</b>
              <span id="mainMeta">—</span>
            </div>
            <div class="card-b" id="main">
              <div class="notice">Select an entity to render its structured facts.</div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <b id="sideTitle">Summary</b>
              <span id="sideMeta">—</span>
            </div>
            <div class="card-b" id="side">
              <div class="notice">A concise overview will appear here.</div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

<script>
(() => {
  // ===== hidden structure (no UI exposure) =====
  const ARCH = { root: "wifb", index: "wifb/wifbindex.html" };

  // ===== silent public time-series =====
  const WB = {
    base: "https://api.worldbank.org/v2/country",
    indicators: [
      { key: "NY.GDP.MKTP.CD", label: "GDP", fmt: v => fmtNum(v) },
      { key: "FP.CPI.TOTL.ZG", label: "Infl", fmt: v => `${fmtNum(v)}%` },
      { key: "SP.POP.TOTL", label: "Pop", fmt: v => fmtNum(v) }
    ],
    yearMax: 2026
  };

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const el = {
    status: $("#status"),
    count: $("#count"),

    reload: $("#reload"),
    copyLink: $("#copyLink"),
    clearCache: $("#clearCache"),

    region: $("#region"),
    q: $("#q"),
    country: $("#country"),

    title: $("#title"),
    subline: $("#subline"),

    k_code: $("#k_code"),
    k_region: $("#k_region"),
    k_depth: $("#k_depth"),
    k_now: $("#k_now"),

    mainTitle: $("#mainTitle"),
    mainMeta: $("#mainMeta"),
    main: $("#main"),

    sideTitle: $("#sideTitle"),
    sideMeta: $("#sideMeta"),
    side: $("#side"),

    tabs: document.querySelectorAll(".tab[data-tab]")
  };

  // ===== state =====
  const state = {
    entities: [],       // {code, name, regionLabel, href}
    active: null,
    activeDoc: null,
    activeStruct: null,
    activeIso: null,
    tab: "profile",
    activeSection: ""
  };

  // ===== utils =====
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtNum(x){
    if (x === null || x === undefined) return "—";
    const s = String(x);
    const n = Number(s.replace(/,/g,""));
    if (!isFinite(n)) return s;
    return n.toLocaleString(undefined);
  }
  function deepLink(code){
    const u = new URL(location.href);
    u.searchParams.set("c", code);
    return u.toString();
  }
  async function fetchText(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }
  function normalizeHref(v){
    if (!v) return "";
    if (v.startsWith("http")) return v;
    return v.replace(/^\.\//,"").replace(/^\//,"");
  }
  function cleanText(s){
    return (s || "")
      .replace(/\u00A0/g, " ")
      .replace(/[ \t]+\n/g, "\n")
      .replace(/\n{3,}/g, "\n\n")
      .trim();
  }

  // ===== index -> entities =====
  function parseEntitiesFromIndex(html){
    const doc = new DOMParser().parseFromString(html, "text/html");
    const selects = Array.from(doc.querySelectorAll("select"));
    const sel = selects.find(s => s.querySelector('option[value*="geos/"]')) || selects[0];
    if (!sel) return [];

    const out = [];
    const nodes = Array.from(sel.children).filter(n => n.tagName === "OPTGROUP" || n.tagName === "OPTION");

    for (const node of nodes){
      if (node.tagName === "OPTGROUP"){
        const label = (node.getAttribute("label") || "").trim();
        for (const opt of Array.from(node.querySelectorAll("option"))){
          const v = (opt.getAttribute("value") || "").trim();
          if (!v.includes("geos/")) continue;
          const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
          if (!code) continue;
          out.push({
            code,
            name: (opt.textContent || "").trim() || code.toUpperCase(),
            regionLabel: label || "",
            href: `${ARCH.root}/` + normalizeHref(v)
          });
        }
      } else {
        const v = (node.getAttribute("value") || "").trim();
        if (!v.includes("geos/")) continue;
        const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
        if (!code) continue;
        out.push({
          code,
          name: (node.textContent || "").trim() || code.toUpperCase(),
          regionLabel: "",
          href: `${ARCH.root}/` + normalizeHref(v)
        });
      }
    }

    const seen = new Set();
    const clean = out.filter(x => { if (seen.has(x.code)) return false; seen.add(x.code); return true; });
    clean.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    return clean;
  }

  // ===== extraction =====
  function extractISOFromDoc(doc){
    const text = doc.body?.innerText || "";
    const isoLine = text.match(/ISO\s*3166\s*country\s*codes?\s*:\s*([^\n\r]+)/i)?.[1] || null;
    if (!isoLine) return null;
    const a3 = isoLine.match(/Alpha-?3\s*:\s*([A-Z]{3})/i)?.[1]?.toUpperCase() || null;
    const a2 = isoLine.match(/Alpha-?2\s*:\s*([A-Z]{2})/i)?.[1]?.toUpperCase() || null;
    if (!a2 && !a3) return null;
    return { a2, a3 };
  }

  function dedupeFacts(facts){
    const seen = new Set();
    const out = [];
    for (const f of facts || []){
      const k = (f.k || "").trim();
      const v = (f.v || "").trim();
      if (!k || !v) continue;
      const key = (k.toLowerCase() + "::" + v.toLowerCase()).slice(0, 900);
      if (seen.has(key)) continue;
      seen.add(key);
      out.push({ k, v });
      if (out.length >= 1200) break;
    }
    return out;
  }

  function extractKeyValueTables(root){
    const facts = [];
    for (const t of Array.from(root.querySelectorAll("table"))){
      const rows = Array.from(t.querySelectorAll("tr"));
      for (const r of rows){
        const cells = Array.from(r.querySelectorAll("th,td"));
        if (cells.length < 2) continue;
        const k = cleanText(cells[0].innerText);
        const v = cleanText(cells.slice(1).map(c => c.innerText).join(" | "));
        if (!k || !v) continue;
        if (k.length > 120) continue;
        facts.push({ k, v });
      }
    }
    return facts;
  }

  function extractDefinitionLists(root){
    const facts = [];
    for (const dl of Array.from(root.querySelectorAll("dl"))){
      for (const dt of Array.from(dl.querySelectorAll("dt"))){
        const dd = dt.nextElementSibling && dt.nextElementSibling.tagName.toLowerCase() === "dd" ? dt.nextElementSibling : null;
        if (!dd) continue;
        const k = cleanText(dt.innerText);
        const v = cleanText(dd.innerText);
        if (k && v) facts.push({ k, v });
      }
    }
    return facts;
  }

  function extractLabeledBlocks(root){
    const facts = [];
    const text = cleanText(root.innerText || "");
    const lines = text.split("\n").map(x => x.trim()).filter(Boolean);
    for (const ln of lines){
      const m = ln.match(/^([A-Za-z][A-Za-z0-9 \-\/(),.%]{2,80})\s*:\s*(.{2,})$/);
      if (!m) continue;
      const k = m[1].trim();
      const v = m[2].trim();
      if (!k || !v) continue;
      facts.push({ k, v });
    }
    return facts;
  }

  function buildSectionsFromDoc(doc){
    const body = doc.body;
    const headings = Array.from(body.querySelectorAll("h1,h2,h3"));
    if (!headings.length){
      const allFacts = dedupeFacts([
        ...extractKeyValueTables(body),
        ...extractDefinitionLists(body),
        ...extractLabeledBlocks(body)
      ]);
      return { sections: new Map([["Overview", { facts: allFacts, text: cleanText(body.innerText||"") }]]), allFacts };
    }

    const sections = new Map();
    let allFacts = [];
    for (let i=0;i<headings.length;i++){
      const h = headings[i];
      const name = cleanText(h.innerText || "");
      if (!name) continue;

      const nodes = [];
      let cur = h.nextElementSibling;
      while (cur && !/^(h1|h2|h3)$/i.test(cur.tagName)){
        nodes.push(cur);
        cur = cur.nextElementSibling;
      }

      const chunk = document.createElement("div");
      for (const n of nodes) chunk.appendChild(n.cloneNode(true));

      const facts = dedupeFacts([
        ...extractKeyValueTables(chunk),
        ...extractDefinitionLists(chunk),
        ...extractLabeledBlocks(chunk)
      ]);

      const ps = Array.from(chunk.querySelectorAll("p,li"));
      const text = cleanText(ps.slice(0, 8).map(p => p.innerText).join("\n\n"));

      if (!sections.has(name)) sections.set(name, { facts, text });
      allFacts = allFacts.concat(facts);
    }

    allFacts = dedupeFacts(allFacts);
    if (allFacts.length < 12){
      const global = dedupeFacts([
        ...allFacts,
        ...extractKeyValueTables(body),
        ...extractDefinitionLists(body),
        ...extractLabeledBlocks(body)
      ]);
      if (!sections.has("Overview")) sections.set("Overview", { facts: global, text: "" });
      return { sections, allFacts: global };
    }
    return { sections, allFacts };
  }

  function extractFlagFromDoc(doc, pageHref){
    const imgs = Array.from(doc.querySelectorAll("img"));
    const scored = imgs.map(img => {
      const src = img.getAttribute("src") || "";
      const alt = (img.getAttribute("alt") || "").toLowerCase();
      const t = (src + " " + alt).toLowerCase();
      let score = 0;
      if (t.includes("flag")) score += 5;
      if (t.includes("smallflag") || t.includes("flag_")) score += 3;
      if (t.includes("seal") || t.includes("map")) score -= 1;
      if (src.match(/\.(svg|png|jpg|jpeg|gif)$/i)) score += 1;
      return { src, alt: img.getAttribute("alt") || "Flag", score };
    }).sort((a,b)=>b.score-a.score);

    const best = scored.find(x => x.score >= 4);
    if (!best?.src) return null;

    try{
      const base = new URL(pageHref, location.href);
      return { alt: best.alt, src: new URL(best.src, base).toString() };
    } catch {
      return null;
    }
  }

  function guessSummary(struct){
    const pref = ["Introduction","Background","Overview","Geography","People and Society","Government","Economy"];
    let t = "";
    for (const p of pref){
      const hit = Array.from(struct.sections.entries()).find(([n]) => n.toLowerCase() === p.toLowerCase());
      if (hit && hit[1].text){ t = hit[1].text; break; }
    }
    if (!t){
      const any = Array.from(struct.sections.values()).map(s => s.text).find(Boolean);
      t = any || "";
    }
    const picks = pickFacts(struct.allFacts, ["Capital","Population","Area","Government type","Currency","Languages","Religions","GDP"]);
    const ribbon = picks.length ? ("\n\n" + picks.map(p => `• ${p.k}: ${p.v}`).join("\n")) : "";
    return cleanText((t ? t.split("\n\n").slice(0,2).join("\n\n") : "") + ribbon);
  }

  function pickFacts(allFacts, keys){
    const out = [];
    const lk = keys.map(k => k.toLowerCase());
    for (const k of lk){
      const hit = allFacts.find(f => (f.k||"").toLowerCase().includes(k));
      if (hit) out.push(hit);
      if (out.length >= 8) break;
    }
    return out;
  }

  function travelFacts(struct){
    const tokens = ["travel","visa","passport","entry","health","vaccin","customs","safety","security","crime","airport","ports","transport","road","rail","driving","emergency","medical"];
    const hits = [];
    for (const f of struct.allFacts){
      const t = (f.k + " " + f.v).toLowerCase();
      if (tokens.some(x => t.includes(x))) hits.push(f);
      if (hits.length >= 260) break;
    }
    return hits;
  }

  // ===== comparisons (silent) =====
  async function wbLatest(iso3, indicator){
    const url = `${WB.base}/${encodeURIComponent(iso3)}/indicator/${encodeURIComponent(indicator)}?format=json&per_page=20000`;
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const data = Array.isArray(j) ? j[1] : null;
    if (!Array.isArray(data)) return null;
    const rows = data
      .filter(d => d && d.value !== null && d.date && Number(d.date) <= WB.yearMax)
      .sort((a,b) => Number(b.date) - Number(a.date));
    if (!rows.length) return null;
    return { year: Number(rows[0].date), value: rows[0].value };
  }

  async function silentSnapshot(iso){
    try{
      if (!iso?.a3) return null;
      const parts = [];
      for (const ind of WB.indicators){
        const last = await wbLatest(iso.a3, ind.key);
        if (last) parts.push(`${ind.label} ${last.year}: ${ind.fmt(last.value)}`);
      }
      return parts.length ? parts.join(" • ") : null;
    } catch { return null; }
  }

  function getIsoCache(){
    try{ return JSON.parse(localStorage.getItem("wib_iso_cache_v1") || "{}"); } catch { return {}; }
  }
  function setIsoCache(map){ localStorage.setItem("wib_iso_cache_v1", JSON.stringify(map || {})); }

  async function buildComparisonForActive(){
    if (!state.activeIso?.a3) return null;
    const cache = getIsoCache();
    cache[state.active.code] = state.activeIso.a3;
    setIsoCache(cache);

    const entries = Object.entries(cache).slice(0, 120);
    const result = [];

    for (const ind of WB.indicators){
      const batch = await Promise.all(entries.map(async ([code, iso3]) => {
        const last = await wbLatest(iso3, ind.key);
        if (!last) return null;
        return { code, year:last.year, value:last.value };
      }));
      const rows = batch.filter(Boolean);
      rows.sort((a,b) => b.value - a.value);

      const activeRow = rows.find(r => r.code === state.active.code) || null;
      const rank = activeRow ? (rows.indexOf(activeRow)+1) : null;

      result.push({
        label: ind.label,
        year: activeRow?.year || rows[0]?.year || null,
        rank,
        total: rows.length,
        top: rows.slice(0,8),
        bottom: rows.slice(-8).reverse()
      });
    }
    return result;
  }

  // ===== UI rendering =====
  function renderRegions(){
    const labels = Array.from(new Set(state.entities.map(e => e.regionLabel).filter(Boolean))).sort();
    el.region.innerHTML = `<option value="">All</option>` + labels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
  }

  function renderCountries(){
    const q = (el.q.value||"").trim().toLowerCase();
    const reg = el.region.value || "";
    const rows = state.entities.filter(e => {
      if (reg && e.regionLabel !== reg) return false;
      if (!q) return true;
      return e.name.toLowerCase().includes(q) || e.code.toLowerCase().includes(q);
    });

    el.country.innerHTML =
      `<option value="">Select…</option>` +
      rows.slice(0, 2500).map(e => `<option value="${escapeHtml(e.code)}">${escapeHtml(e.name)} (${escapeHtml(e.code)})</option>`).join("");
  }

  function setTab(tab){
    state.tab = tab;
    el.tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab")===tab));
    renderActiveView();
  }

  function renderKV(facts){
    const f = (facts || []).slice(0, 420);
    if (!f.length) return `<div class="notice">No fields detected for this view.</div>`;
    return f.map(x => `
      <div class="kv">
        <div class="k">${escapeHtml(x.k)}</div>
        <div class="v">${escapeHtml(x.v)}</div>
      </div>
    `).join("");
  }

  function renderSectionBrowser(struct){
    const names = Array.from(struct.sections.keys()).slice(0, 80);
    const activeName = (state.activeSection && struct.sections.has(state.activeSection))
      ? state.activeSection
      : (names.includes("Introduction") ? "Introduction" : (names[0] || "Overview"));

    state.activeSection = activeName;

    const pills = names.map(n => `<div class="pill ${n===activeName ? "active":""}" data-sec="${escapeHtml(n)}">${escapeHtml(n)}</div>`).join("");
    const sec = struct.sections.get(activeName) || { facts: [], text: "" };
    const intro = sec.text ? `<div class="notice" style="margin-bottom:10px">${escapeHtml(sec.text)}</div>` : "";

    el.main.innerHTML = `<div class="pillrow">${pills}</div>${intro}${renderKV(sec.facts)}`;
    el.main.querySelectorAll("[data-sec]").forEach(p => {
      p.addEventListener("click", () => { state.activeSection = p.getAttribute("data-sec"); renderActiveView(); });
    });
  }

  async function renderActiveView(){
    if (!state.activeStruct){
      el.mainTitle.textContent = "Profile";
      el.mainMeta.textContent = "—";
      el.main.innerHTML = `<div class="notice">Select an entity to render its structured facts.</div>`;
      el.sideTitle.textContent = "Summary";
      el.sideMeta.textContent = "—";
      el.side.innerHTML = `<div class="notice">A concise overview will appear here.</div>`;
      return;
    }

    const struct = state.activeStruct;

    if (state.tab === "profile"){
      el.mainTitle.textContent = "Profile";
      el.mainMeta.textContent = "Sections";
      renderSectionBrowser(struct);
      el.sideTitle.textContent = "Summary";
      el.sideMeta.textContent = "Generated";
      el.side.innerHTML = `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(state._summary || "")}</div>`;
      return;
    }

    if (state.tab === "travel"){
      el.mainTitle.textContent = "Travel";
      el.mainMeta.textContent = "Extracted";
      el.main.innerHTML = renderKV(travelFacts(struct));
      el.sideTitle.textContent = "Highlights";
      el.sideMeta.textContent = "Extracted";
      const picks = pickFacts(struct.allFacts, ["Visa", "Entry", "Health", "Safety", "Airports", "Ports", "Roadways", "Railways"]);
      el.side.innerHTML = picks.length
        ? `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(picks.map(p => `• ${p.k}: ${p.v}`).join("\n"))}</div>`
        : `<div class="notice">No travel highlights detected.</div>`;
      return;
    }

    if (state.tab === "flags"){
      el.mainTitle.textContent = "Flag";
      el.mainMeta.textContent = "Detected";
      const f = state._flag || null;
      el.main.innerHTML = f?.src
        ? `<div class="flagBox"><img src="${escapeHtml(f.src)}" alt="${escapeHtml(f.alt||"Flag")}"/></div>`
        : `<div class="notice">No flag image detected.</div>`;

      el.sideTitle.textContent = "Description";
      el.sideMeta.textContent = "Extracted";
      const desc = pickFacts(struct.allFacts, ["Flag description","National symbol","National anthem"]);
      el.side.innerHTML = desc.length
        ? `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(desc.map(d => `• ${d.k}: ${d.v}`).join("\n"))}</div>`
        : `<div class="notice">No description detected.</div>`;
      return;
    }

    if (state.tab === "compare"){
      el.mainTitle.textContent = "Compare";
      el.mainMeta.textContent = "Computed";
      el.main.innerHTML = `<div class="loading"><span class="spin"></span><span>Computing…</span></div>`;

      const cmp = await buildComparisonForActive();
      if (!cmp){
        el.main.innerHTML = `<div class="notice">Comparisons are not available for this entity yet.</div>`;
        el.sideTitle.textContent = "Coverage";
        el.sideMeta.textContent = "—";
        el.side.innerHTML = `<div class="notice">This view strengthens as you browse more entities.</div>`;
        return;
      }

      el.main.innerHTML = cmp.map(c => {
        const rankLine = c.rank ? `Rank: ${c.rank}/${c.total} • Year: ${c.year || "—"}` : `Year: ${c.year || "—"}`;
        const top = (c.top||[]).map(r => `• ${r.code.toUpperCase()} — ${fmtNum(r.value)}`).join("\n") || "—";
        const bot = (c.bottom||[]).map(r => `• ${r.code.toUpperCase()} — ${fmtNum(r.value)}`).join("\n") || "—";
        return `
          <div class="notice" style="margin-bottom:10px"><b>${escapeHtml(c.label)}</b><br/><span class="muted">${escapeHtml(rankLine)}</span></div>
          <div class="kv"><div class="k">Top</div><div class="v">${escapeHtml(top)}</div></div>
          <div class="kv"><div class="k">Bottom</div><div class="v">${escapeHtml(bot)}</div></div>
          <div style="height:12px"></div>
        `;
      }).join("");

      el.sideTitle.textContent = "Note";
      el.sideMeta.textContent = "Adaptive";
      el.side.innerHTML = `<div class="notice">Comparisons strengthen automatically as the coverage cache builds.</div>`;
      return;
    }
  }

  // ===== selection =====
  async function selectCountry(code){
    const e = state.entities.find(x => x.code === code);
    state.active = e || null;

    if (!state.active){
      el.title.textContent = "Select an entity";
      el.subline.textContent = "Facts are extracted and rendered into a modern layout.";
      el.k_code.textContent = "—";
      el.k_region.textContent = "—";
      el.k_depth.textContent = "—";
      el.k_now.textContent = "—";
      state.activeDoc = null;
      state.activeStruct = null;
      state.activeIso = null;
      state._flag = null;
      state._summary = "";
      renderActiveView();
      return;
    }

    el.title.textContent = state.active.name;
    el.subline.textContent = `Entity code: ${state.active.code} • Region: ${state.active.regionLabel || "—"}`;
    el.k_code.textContent = state.active.code;
    el.k_region.textContent = state.active.regionLabel || "—";
    el.k_depth.textContent = "…";
    el.k_now.textContent = "—";

    el.mainTitle.textContent = "Profile";
    el.mainMeta.textContent = "Loading…";
    el.main.innerHTML = `<div class="loading"><span class="spin"></span><span>Rendering…</span></div>`;
    el.sideTitle.textContent = "Summary";
    el.sideMeta.textContent = "Loading…";
    el.side.innerHTML = `<div class="loading"><span class="spin"></span><span>Preparing…</span></div>`;

    try{
      const html = await fetchText(state.active.href);
      const doc = new DOMParser().parseFromString(html, "text/html");
      state.activeDoc = doc;

      const struct = buildSectionsFromDoc(doc);
      state.activeStruct = struct;

      const iso = extractISOFromDoc(doc);
      state.activeIso = iso;

      if (iso?.a3){
        const cache = getIsoCache();
        cache[state.active.code] = iso.a3;
        setIsoCache(cache);
      }

      state._flag = extractFlagFromDoc(doc, state.active.href);
      state._summary = guessSummary(struct);

      const depth = { sec: struct.sections.size, facts: struct.allFacts.length };
      el.k_depth.textContent = `${depth.sec} sections • ${depth.facts.toLocaleString()} fields`;

      const snap = await silentSnapshot(iso);
      el.k_now.textContent = snap || "—";

      history.replaceState(null, "", deepLink(state.active.code));
      renderActiveView();
    } catch {
      state.activeDoc = null;
      state.activeStruct = null;
      state.activeIso = null;
      state._flag = null;
      state._summary = "";

      el.k_depth.textContent = "—";
      el.k_now.textContent = "—";
      el.mainMeta.textContent = "—";
      el.sideMeta.textContent = "—";
      el.main.innerHTML = `<div class="notice">This entity could not be rendered at the moment.</div>`;
      el.side.innerHTML = `<div class="notice">No summary available.</div>`;
    }
  }

  // ===== boot =====
  async function boot(){
    el.status.textContent = "loading…";
    el.count.textContent = "0";

    // reset dropdown
    el.country.innerHTML = `<option value="">Select…</option>`;

    try{
      const idxHtml = await fetchText(ARCH.index);
      state.entities = parseEntitiesFromIndex(idxHtml);
      el.count.textContent = String(state.entities.length);
      el.status.textContent = "ready";

      renderRegions();
      renderCountries();

      const deep = new URL(location.href).searchParams.get("c");
      if (deep){
        el.country.value = deep.toLowerCase();
        selectCountry(deep.toLowerCase());
      } else {
        selectCountry("");
      }
    } catch {
      el.status.textContent = "unavailable";
      el.country.innerHTML = `<option value="">Unavailable</option>`;
    }
  }

  // ===== events =====
  el.reload.addEventListener("click", boot);

  el.region.addEventListener("change", () => { renderCountries(); el.country.value=""; selectCountry(""); });
  el.q.addEventListener("input", () => { renderCountries(); });

  el.country.addEventListener("change", () => selectCountry(el.country.value || ""));

  el.copyLink.addEventListener("click", async () => {
    if (!state.active) return;
    const link = deepLink(state.active.code);
    try{
      await navigator.clipboard.writeText(link);
      el.copyLink.textContent = "copied";
      setTimeout(()=> el.copyLink.textContent = "copy link", 900);
    } catch { alert(link); }
  });

  el.clearCache.addEventListener("click", () => {
    localStorage.removeItem("wib_iso_cache_v1");
    el.clearCache.textContent = "cleared";
    setTimeout(()=> el.clearCache.textContent = "clear cache", 900);
  });

  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.getAttribute("data-tab"))));

  // start
  boot();
})();
</script>
</body>
</html>
