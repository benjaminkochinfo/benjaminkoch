<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark"/>
  <title>World Intelligence Factbook</title>
  <meta name="description" content="World Intelligence Factbook — redesigned country intelligence library with validated source text and silent public series refresh."/>
  <style>
    :root{
      --bg:#061018;
      --panel:#0b1622;
      --panel2:#0f2133;
      --border:#1a324b;
      --text:#e7eef7;
      --muted:#9fb3c9;
      --accent:#ff8a00;
      --accent2:#3ddc97;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(255,138,0,.08), transparent 55%),
        radial-gradient(900px 600px at 82% 10%, rgba(61,220,151,.06), transparent 60%),
        linear-gradient(180deg, #061019 0%, #050c13 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:rgba(255,138,0,.92); text-decoration:none}
    a:hover{text-decoration:underline}

    /* Top */
    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(6,16,24,.72);
      border-bottom:1px solid rgba(26,50,75,.85);
    }
    .topbar-inner{
      max-width: 1560px;
      margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:44px; height:44px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,138,0,.95), rgba(255,138,0,.15));
      border:1px solid rgba(255,138,0,.35);
      box-shadow: 0 14px 40px rgba(255,138,0,.15);
      display:grid; place-items:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.3px; line-height:1.05}
    .brand .sub{margin-top:4px; font-family:var(--mono); font-size:11px; color:var(--muted)}
    .meta{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
      white-space:nowrap;
    }

    /* Layout */
    .wrap{max-width:1560px; margin:0 auto; padding:14px;}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    /* Panels */
    .panel{
      border:1px solid rgba(26,50,75,.85);
      background: rgba(11,22,34,.78);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: linear-gradient(180deg, rgba(15,33,51,.55), rgba(11,22,34,.35));
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .panel-h h2{margin:0; font-size:13px; letter-spacing:.2px}
    .hint{color:var(--muted); font-family:var(--mono); font-size:11px; line-height:1.35; margin-top:6px;}
    .panel-b{padding:12px;}

    /* Filters */
    label.small{
      font-family:var(--mono);
      font-size:10px;
      color: var(--muted);
      display:block;
      margin:0 0 6px 2px;
    }
    select, input{
      width:100%;
      border:1px solid rgba(26,50,75,.85);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:12px;
    }
    input::placeholder{color: rgba(159,179,201,.75)}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .row2{grid-template-columns:1fr} }

    /* Country list */
    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: calc(100vh - 320px);
      overflow:auto;
      padding-right:4px;
    }
    .row{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(15,33,51,.35);
      border-radius: 14px;
      padding:10px 10px;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .row:hover{border-color: rgba(255,138,0,.35); transform: translateY(-1px)}
    .row.active{
      border-color: rgba(255,138,0,.55);
      background: rgba(255,138,0,.08);
    }
    .name{font-size:12px; letter-spacing:.2px; line-height:1.2}
    .submeta{font-family:var(--mono); font-size:11px; color:var(--muted); display:flex; gap:10px; align-items:center}
    .tag{
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.75);
      font-family:var(--mono);
      font-size:10px;
      white-space:nowrap;
    }

    /* Right: overview */
    .hero{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: radial-gradient(1000px 500px at 15% 0%, rgba(255,138,0,.09), transparent 50%),
                  radial-gradient(900px 450px at 85% 10%, rgba(61,220,151,.06), transparent 55%),
                  linear-gradient(180deg, rgba(15,33,51,.5), rgba(11,22,34,.25));
    }
    .hero-top{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .hero h3{margin:0; font-size:18px; letter-spacing:.3px}
    .subline{font-family:var(--mono); color:var(--muted); font-size:11px; line-height:1.35; margin-top:6px}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:9px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .btn:hover{border-color: rgba(255,138,0,.45)}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 560px){ .kpis{grid-template-columns: 1fr} }
    .kpi{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      border-radius: 16px;
      padding:10px 10px;
      min-height:64px;
    }
    .kpi .k{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .kpi .v{margin-top:6px; font-size:12px; line-height:1.25}

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: rgba(11,22,34,.65);
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      color: rgba(255,255,255,.8);
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .tab.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    /* Content */
    .content{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .box{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.30);
      border-radius: 16px;
      overflow:hidden;
    }
    .box-h{
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.55);
      background: rgba(7,16,24,.45);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .box-h b{font-size:12px; letter-spacing:.2px}
    .box-h span{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .box-b{padding:10px 12px}

    .notice{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      padding:10px 12px;
      border-radius: 16px;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.45;
      color: rgba(255,255,255,.85);
    }
    .notice.accent{
      border-color: rgba(255,138,0,.35);
      background: rgba(255,138,0,.08);
    }

    .facts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 900px){ .facts{grid-template-columns:1fr} }
    .fact{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.45);
      border-radius: 14px;
      padding:10px 12px;
      min-height:64px;
    }
    .fact .k{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .fact .v{margin-top:6px; font-size:12px; line-height:1.35; white-space:pre-wrap}

    .sectionList{display:flex; flex-wrap:wrap; gap:8px;}
    .pill{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .pill:hover{border-color: rgba(255,138,0,.45)}
    .pill.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .text{font-size:12px; line-height:1.65; white-space:pre-wrap; color: rgba(231,238,247,.92)}
    .muted{color:var(--muted)}
    .loading{display:inline-flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; color: var(--muted);}
    .spin{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,138,0,.9);
      animation: rot .9s linear infinite;
    }
    @keyframes rot{to{transform: rotate(360deg)}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">WIB</div>
        <div>
          <h1>World Intelligence Factbook</h1>
          <div class="sub">Revamped country intelligence • source-text validated • silent public series refresh</div>
        </div>
      </div>
      <div class="meta">
        <span id="status">loading…</span>
        <span class="muted">|</span>
        <span class="muted">entities:</span> <span id="count">0</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Navigator</h2>
            <div class="hint">
              Search and filter. Content is rendered into the redesigned layout from local pages under <span class="muted">/wifb/</span>.
            </div>
          </div>
          <div class="btns">
            <button class="btn" id="reload">reload</button>
          </div>
        </div>
        <div class="panel-b">
          <div class="row2">
            <div>
              <label class="small">Region</label>
              <select id="region">
                <option value="">All regions</option>
              </select>
            </div>
            <div>
              <label class="small">Search</label>
              <input id="q" placeholder="Type country name or code (e.g., Germany / gm)"/>
            </div>
          </div>
          <div class="list" id="list"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hero">
          <div class="hero-top">
            <div>
              <h3 id="title">Select an entity</h3>
              <div class="subline" id="subline">The redesigned view renders facts from local source text. Public series values appear where available.</div>
            </div>
            <div class="btns">
              <button class="btn" id="copyLink">copy link</button>
              <button class="btn" id="openSource">open source</button>
            </div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="k">CODE</div><div class="v" id="k_code">—</div></div>
            <div class="kpi"><div class="k">REGION</div><div class="v" id="k_region">—</div></div>
            <div class="kpi"><div class="k">ISO (extracted)</div><div class="v" id="k_iso">—</div></div>
            <div class="kpi"><div class="k">CURRENT SNAPSHOT</div><div class="v" id="k_now">—</div></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="overview">OVERVIEW</div>
          <div class="tab" data-tab="sections">SECTIONS</div>
          <div class="tab" data-tab="search">SEARCH IN TEXT</div>
        </div>

        <div class="content">
          <div class="box">
            <div class="box-h">
              <b>Key facts (rendered)</b>
              <span id="factsMeta">—</span>
            </div>
            <div class="box-b">
              <div id="facts" class="facts">
                <div class="notice">Select an entity to render key facts.</div>
              </div>
            </div>
          </div>

          <div class="box">
            <div class="box-h">
              <b>Sections</b>
              <span class="muted">click to view</span>
            </div>
            <div class="box-b">
              <div id="secPills" class="sectionList"></div>
              <div style="margin-top:12px" class="text" id="secText"><span class="muted">Select an entity, then choose a section.</span></div>
            </div>
          </div>

          <div class="box">
            <div class="box-h">
              <b>Search results</b>
              <span id="searchMeta">—</span>
            </div>
            <div class="box-b">
              <label class="small">Query</label>
              <input id="inQ" placeholder="e.g. unemployment, railways, religion, border disputes"/>
              <div style="margin-top:10px" id="searchRes" class="text"><span class="muted">Type a query to search within the local source text.</span></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  // ====== Structure (your current setup) ======
  const ARCHIVE_ROOT = "wifb";
  const INDEX_PAGE   = `${ARCHIVE_ROOT}/wifbindex.html`;
  const GEO_ROOT     = `${ARCHIVE_ROOT}/geos`;

  // ====== Public series snapshot (silent) ======
  const WB = {
    base: "https://api.worldbank.org/v2/country",
    indicators: [
      { key: "NY.GDP.MKTP.CD", label: "GDP", fmt: v => fmtNum(v) },
      { key: "FP.CPI.TOTL.ZG", label: "Infl", fmt: v => `${fmtNum(v)}%` },
      { key: "SP.POP.TOTL",    label: "Pop", fmt: v => fmtNum(v) }
    ],
    yearMax: 2026
  };

  // ====== DOM ======
  const $ = s => document.querySelector(s);
  const el = {
    status: $("#status"),
    count: $("#count"),
    reload: $("#reload"),
    region: $("#region"),
    q: $("#q"),
    list: $("#list"),

    title: $("#title"),
    subline: $("#subline"),
    copyLink: $("#copyLink"),
    openSource: $("#openSource"),

    k_code: $("#k_code"),
    k_region: $("#k_region"),
    k_iso: $("#k_iso"),
    k_now: $("#k_now"),

    facts: $("#facts"),
    factsMeta: $("#factsMeta"),

    secPills: $("#secPills"),
    secText: $("#secText"),

    inQ: $("#inQ"),
    searchRes: $("#searchRes"),
    searchMeta: $("#searchMeta"),

    tabs: document.querySelectorAll(".tab[data-tab]")
  };

  // ====== State ======
  const state = {
    entities: [],   // { code, name, href, regionLabel }
    active: null,
    activeHtml: "",
    activeTextLines: [],
    activeSections: new Map(), // name -> text
    activeIso: null,
    tab: "overview",
    activeSection: ""
  };

  // ====== Helpers ======
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtNum(x){
    if (x === null || x === undefined) return "—";
    const n = Number(String(x).replace(/,/g,""));
    if (!isFinite(n)) return String(x);
    return n.toLocaleString(undefined);
  }
  function deepLink(code){
    const u = new URL(location.href);
    u.searchParams.set("c", code);
    return u.toString();
  }
  async function fetchText(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }
  function normalizeHref(v){
    // project-site safe: keep relative paths
    if (!v) return "";
    if (v.startsWith("http")) return v;
    return v.replace(/^\.\//,"").replace(/^\//,"");
  }

  // ====== Index parsing (hidden source) ======
  function parseEntitiesFromIndex(html){
    const doc = new DOMParser().parseFromString(html, "text/html");
    const selects = Array.from(doc.querySelectorAll("select"));
    const sel = selects.find(s => s.querySelector('option[value*="geos/"]')) || selects[0];
    if (!sel) return [];

    const out = [];
    const nodes = Array.from(sel.children).filter(n => n.tagName === "OPTGROUP" || n.tagName === "OPTION");

    for (const node of nodes){
      if (node.tagName === "OPTGROUP"){
        const label = node.getAttribute("label") || "";
        for (const opt of Array.from(node.querySelectorAll("option"))){
          const v = opt.getAttribute("value") || "";
          if (!v.includes("geos/")) continue;
          const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
          if (!code) continue;
          out.push({
            code,
            name: (opt.textContent || "").trim() || code.toUpperCase(),
            href: `${ARCHIVE_ROOT}/` + normalizeHref(v),
            regionLabel: label || ""
          });
        }
      } else {
        const v = node.getAttribute("value") || "";
        if (!v.includes("geos/")) continue;
        const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
        if (!code) continue;
        out.push({
          code,
          name: (node.textContent || "").trim() || code.toUpperCase(),
          href: `${ARCHIVE_ROOT}/` + normalizeHref(v),
          regionLabel: ""
        });
      }
    }

    const seen = new Set();
    const clean = out.filter(x => { if (seen.has(x.code)) return false; seen.add(x.code); return true; });
    clean.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    return clean;
  }

  // ====== Parse source page into sections + key facts ======
  const MAJOR = ["Introduction","Geography","People and Society","Government","Economy","Energy","Communications","Transportation","Military and Security","Transnational Issues"];

  function extractISOFromHtml(countryHtml){
    const doc = new DOMParser().parseFromString(countryHtml, "text/html");
    const text = doc.body?.innerText || "";
    const isoLine = text.match(/ISO\s*3166\s*country\s*codes?\s*:\s*([^\n\r]+)/i)?.[1] || null;
    if (!isoLine) return null;
    const a2 = isoLine.match(/Alpha-?2\s*:\s*([A-Z]{2})/i)?.[1]?.toUpperCase() || null;
    const a3 = isoLine.match(/Alpha-?3\s*:\s*([A-Z]{3})/i)?.[1]?.toUpperCase() || null;
    if (!a2 && !a3) return null;
    return { a2, a3 };
  }

  function toTextLines(html){
    const doc = new DOMParser().parseFromString(html, "text/html");
    const txt = (doc.body?.innerText || "");
    return txt.split("\n").map(x => x.trim()).filter(Boolean);
  }

  function sliceSections(lines){
    // Heuristic: find exact-line headings matching MAJOR; slice until next heading
    const idxs = [];
    for (let i=0;i<lines.length;i++){
      const s = lines[i];
      const hit = MAJOR.find(m => m.toLowerCase() === s.toLowerCase());
      if (hit) idxs.push({ name: hit, i });
    }
    const map = new Map();
    if (!idxs.length){
      map.set("Overview", lines.slice(0, Math.min(120, lines.length)).join("\n"));
      return map;
    }
    for (let k=0;k<idxs.length;k++){
      const start = idxs[k].i;
      const end = (k+1<idxs.length) ? idxs[k+1].i : lines.length;
      const body = lines.slice(start+1, end).join("\n");
      map.set(idxs[k].name, body);
    }
    return map;
  }

  function pickFieldValue(lines, labelRegex, maxScan=900){
    // looks for "Label: value" in flattened text
    const scan = lines.slice(0, Math.min(maxScan, lines.length));
    for (const ln of scan){
      if (labelRegex.test(ln)){
        const parts = ln.split(":");
        if (parts.length >= 2){
          return parts.slice(1).join(":").trim();
        }
      }
    }
    return null;
  }

  function renderFactsFromLines(lines){
    // A small, stable set of “key facts” derived from the local source text.
    // (No claims if missing.)
    const facts = [];

    const cap = v => (v && v.length > 280) ? v.slice(0, 277) + "…" : v;

    // These labels are common; if not present, they remain blank.
    const area = pickFieldValue(lines, /^Area\s*:/i);
    const pop  = pickFieldValue(lines, /^Population\s*:/i);
    const capital = pickFieldValue(lines, /^Capital\s*:/i);
    const gdp = pickFieldValue(lines, /^GDP\s*-\s*(?:purchasing\s*power\s*parity|official\s*exchange\s*rate)\s*:/i);
    const govt = pickFieldValue(lines, /^Government\s*type\s*:/i);
    const lang = pickFieldValue(lines, /^Languages\s*:/i);
    const rel  = pickFieldValue(lines, /^Religions\s*:/i);
    const curr = pickFieldValue(lines, /^Currency\s*:/i);

    pushIf("Capital", capital);
    pushIf("Population (source)", pop);
    pushIf("Area (source)", area);
    pushIf("Government type", govt);
    pushIf("GDP (source)", gdp);
    pushIf("Currency", curr);
    pushIf("Languages", lang);
    pushIf("Religions", rel);

    // Fallback if nothing detected
    if (!facts.length){
      facts.push({ k:"Source text", v:"Key facts are derived from the local page text. For this entity, standard labels were not detected with high confidence." });
    }

    el.facts.innerHTML = facts.map(f => `
      <div class="fact">
        <div class="k">${escapeHtml(f.k)}</div>
        <div class="v">${escapeHtml(cap(f.v))}</div>
      </div>
    `).join("");

    function pushIf(k,v){ if (v && v.length) facts.push({k, v}); }
  }

  // ====== Silent public snapshot ======
  async function wbLatest(iso3, indicator){
    const url = `${WB.base}/${encodeURIComponent(iso3)}/indicator/${encodeURIComponent(indicator)}?format=json&per_page=20000`;
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const data = Array.isArray(j) ? j[1] : null;
    if (!Array.isArray(data)) return null;

    const rows = data
      .filter(d => d && d.value !== null && d.date && Number(d.date) <= WB.yearMax)
      .sort((a,b) => Number(b.date) - Number(a.date));
    if (!rows.length) return null;
    return { year: Number(rows[0].date), value: rows[0].value };
  }

  async function silentSnapshot(iso){
    try{
      if (!iso?.a3) return null;
      const parts = [];
      for (const ind of WB.indicators){
        const last = await wbLatest(iso.a3, ind.key);
        if (last) parts.push(`${ind.label} ${last.year}: ${ind.fmt(last.value)}`);
      }
      return parts.length ? parts.join(" • ") : null;
    } catch {
      return null;
    }
  }

  // ====== UI render ======
  function renderRegions(){
    const labels = Array.from(new Set(state.entities.map(e => e.regionLabel).filter(Boolean))).sort();
    el.region.innerHTML = `<option value="">All regions</option>` + labels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
  }

  function renderList(){
    const q = (el.q.value||"").trim().toLowerCase();
    const reg = el.region.value || "";
    const rows = state.entities.filter(e => {
      if (reg && e.regionLabel !== reg) return false;
      if (!q) return true;
      return e.name.toLowerCase().includes(q) || e.code.toLowerCase().includes(q);
    }).slice(0, 800);

    el.list.innerHTML = rows.length ? rows.map(e => `
      <div class="row ${state.active?.code===e.code ? "active":""}" data-code="${escapeHtml(e.code)}">
        <div>
          <div class="name">${escapeHtml(e.name)}</div>
          <div class="submeta">
            <span class="tag">${escapeHtml(e.code)}</span>
            <span class="tag">${escapeHtml(e.regionLabel || "—")}</span>
          </div>
        </div>
        <div class="tag" style="border-color:rgba(255,138,0,.35); color:rgba(255,138,0,.95); background:rgba(255,138,0,.06)">OPEN</div>
      </div>
    `).join("") : `<div class="notice accent">No matches.</div>`;

    el.list.querySelectorAll(".row").forEach(r => {
      r.addEventListener("click", () => selectCountry(r.getAttribute("data-code")));
    });
  }

  function setTab(tab){
    state.tab = tab;
    el.tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab")===tab));
    // show/hide boxes
    // Always visible, but we focus the relevant area:
    if (tab==="overview"){
      el.secText.scrollIntoView({block:"nearest"});
    } else if (tab==="sections"){
      el.secText.scrollIntoView({block:"nearest"});
    } else if (tab==="search"){
      el.inQ.focus();
    }
  }

  function renderSectionPills(sectionNames){
    const names = sectionNames.length ? sectionNames : ["Overview"];
    el.secPills.innerHTML = names.map(n => `
      <div class="pill ${state.activeSection===n ? "active":""}" data-sec="${escapeHtml(n)}">${escapeHtml(n)}</div>
    `).join("");

    el.secPills.querySelectorAll("[data-sec]").forEach(p => {
      p.addEventListener("click", () => {
        state.activeSection = p.getAttribute("data-sec");
        el.secPills.querySelectorAll(".pill").forEach(x => x.classList.toggle("active", x.getAttribute("data-sec")===state.activeSection));
        const txt = state.activeSections.get(state.activeSection) || "";
        el.secText.textContent = txt || "—";
      });
    });
  }

  // ====== Selection ======
  async function selectCountry(code){
    const e = state.entities.find(x => x.code === code);
    state.active = e || null;
    renderList();

    if (!state.active){
      el.title.textContent = "Select an entity";
      el.subline.textContent = "The redesigned view renders facts from local source text. Public series values appear where available.";
      el.k_code.textContent = "—";
      el.k_region.textContent = "—";
      el.k_iso.textContent = "—";
      el.k_now.textContent = "—";
      el.factsMeta.textContent = "—";
      el.facts.innerHTML = `<div class="notice">Select an entity to render key facts.</div>`;
      el.secPills.innerHTML = "";
      el.secText.innerHTML = `<span class="muted">Select an entity, then choose a section.</span>`;
      el.searchMeta.textContent = "—";
      el.searchRes.innerHTML = `<span class="muted">Type a query to search within the local source text.</span>`;
      return;
    }

    el.title.textContent = state.active.name;
    el.subline.textContent = `code=${state.active.code} • region=${state.active.regionLabel || "—"}`;
    el.k_code.textContent = state.active.code;
    el.k_region.textContent = state.active.regionLabel || "—";
    el.k_iso.textContent = "—";
    el.k_now.textContent = "—";
    el.factsMeta.textContent = `loading…`;

    // load + parse local source page
    try{
      const html = await fetchText(state.active.href);
      state.activeHtml = html;
      const lines = toTextLines(html);
      state.activeTextLines = lines;
      state.activeSections = sliceSections(lines);

      // key facts
      renderFactsFromLines(lines);
      el.factsMeta.textContent = `rendered from: ${state.active.href}`;

      // sections
      const secNames = Array.from(state.activeSections.keys()).filter(Boolean);
      state.activeSection = secNames.includes("Introduction") ? "Introduction" : (secNames[0] || "Overview");
      renderSectionPills(secNames);
      el.secText.textContent = state.activeSections.get(state.activeSection) || "—";

      // iso + snapshot (silent)
      const iso = extractISOFromHtml(html);
      state.activeIso = iso;
      el.k_iso.textContent = iso ? `${iso.a2 || "—"} / ${iso.a3 || "—"}` : "—";

      const snap = await silentSnapshot(iso);
      el.k_now.textContent = snap || "—";

      // reset search UI
      el.inQ.value = "";
      el.searchMeta.textContent = "—";
      el.searchRes.innerHTML = `<span class="muted">Type a query to search within the local source text.</span>`;

      // deep link
      history.replaceState(null, "", deepLink(state.active.code));
    } catch {
      // no visible error
      el.factsMeta.textContent = "—";
      el.facts.innerHTML = `<div class="notice accent">Unable to render this entity from the local source page.</div>`;
      el.secPills.innerHTML = "";
      el.secText.textContent = "—";
      el.k_iso.textContent = "—";
      el.k_now.textContent = "—";
    }
  }

  // ====== Search inside source text ======
  function runSearch(){
    if (!state.active || !state.activeTextLines.length){
      el.searchMeta.textContent = "—";
      el.searchRes.innerHTML = `<span class="muted">Select an entity first.</span>`;
      return;
    }
    const q = (el.inQ.value||"").trim().toLowerCase();
    if (!q){
      el.searchMeta.textContent = "—";
      el.searchRes.innerHTML = `<span class="muted">Type a query to search within the local source text.</span>`;
      return;
    }
    const lines = state.activeTextLines;
    const hits = [];
    for (let i=0;i<lines.length;i++){
      if (lines[i].toLowerCase().includes(q)){
        hits.push(lines[i]);
        if (hits.length >= 80) break;
      }
    }
    el.searchMeta.textContent = `${hits.length} matches (showing up to 80)`;
    el.searchRes.innerHTML = hits.length
      ? hits.map(t => `<div class="notice" style="margin-bottom:8px">${escapeHtml(t)}</div>`).join("")
      : `<div class="notice accent">No matches.</div>`;
  }

  // ====== Boot ======
  async function boot(){
    el.status.textContent = "loading index…";
    el.count.textContent = "0";
    el.list.innerHTML = `<div class="loading"><span class="spin"></span><span>Loading…</span></div>`;

    try{
      const html = await fetchText(INDEX_PAGE);
      state.entities = parseEntitiesFromIndex(html);
      el.count.textContent = String(state.entities.length);
      el.status.textContent = "ready";

      renderRegions();
      renderList();

      const code = new URL(location.href).searchParams.get("c");
      if (code){
        await selectCountry(code.toLowerCase());
      } else {
        await selectCountry("");
      }
    } catch {
      el.status.textContent = "index unavailable";
      el.list.innerHTML = `
        <div class="notice accent">
          Could not load the local index needed to build the entity list.<br/><br/>
          Ensure <span class="muted">/wifb/wifbindex.html</span> exists and is readable via GitHub Pages.
        </div>
      `;
    }
  }

  // ====== Wiring ======
  el.reload.addEventListener("click", boot);
  el.region.addEventListener("change", renderList);
  el.q.addEventListener("input", renderList);

  el.copyLink.addEventListener("click", async () => {
    if (!state.active) return;
    const link = deepLink(state.active.code);
    try{
      await navigator.clipboard.writeText(link);
      el.copyLink.textContent = "copied";
      setTimeout(()=> el.copyLink.textContent = "copy link", 900);
    } catch { alert(link); }
  });

  el.openSource.addEventListener("click", () => {
    if (!state.active) return;
    window.open(state.active.href, "_blank");
  });

  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.getAttribute("data-tab"))));

  el.inQ.addEventListener("input", runSearch);
  el.inQ.addEventListener("keydown", (ev) => { if (ev.key === "Enter") runSearch(); });

  // Start
  boot();
})();
</script>
</body>
</html>
