<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="color-scheme" content="dark"/>
  <title>World Intelligence Factbook</title>
  <meta name="description" content="World Intelligence Factbook — redesigned country intelligence library with maximal sectioning and structured field extraction."/>
  <style>
    :root{
      --bg:#061018;
      --panel:#0b1622;
      --panel2:#0f2133;
      --border:#1a324b;
      --text:#e7eef7;
      --muted:#9fb3c9;
      --accent:#ff8a00;
      --accent2:#3ddc97;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 18% 0%, rgba(255,138,0,.08), transparent 55%),
        radial-gradient(900px 600px at 82% 10%, rgba(61,220,151,.06), transparent 60%),
        linear-gradient(180deg, #061019 0%, #050c13 100%);
      color:var(--text);
      overflow-x:hidden;
    }

    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(6,16,24,.72);
      border-bottom:1px solid rgba(26,50,75,.85);
    }
    .topbar-inner{
      max-width: 1560px;
      margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px;
      align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:44px; height:44px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,138,0,.95), rgba(255,138,0,.15));
      border:1px solid rgba(255,138,0,.35);
      box-shadow: 0 14px 40px rgba(255,138,0,.15);
      display:grid; place-items:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.3px; line-height:1.05}
    .brand .sub{margin-top:4px; font-family:var(--mono); font-size:11px; color:var(--muted)}
    .meta{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
      white-space:nowrap;
    }

    .wrap{max-width:1560px; margin:0 auto; padding:14px;}
    .grid{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid rgba(26,50,75,.85);
      background: rgba(11,22,34,.78);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: linear-gradient(180deg, rgba(15,33,51,.55), rgba(11,22,34,.35));
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .panel-h h2{margin:0; font-size:13px; letter-spacing:.2px}
    .hint{color:var(--muted); font-family:var(--mono); font-size:11px; line-height:1.35; margin-top:6px;}
    .panel-b{padding:12px;}

    label.small{
      font-family:var(--mono);
      font-size:10px;
      color: var(--muted);
      display:block;
      margin:0 0 6px 2px;
    }
    select, input{
      width:100%;
      border:1px solid rgba(26,50,75,.85);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:12px;
    }
    input::placeholder{color: rgba(159,179,201,.75)}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .row2{grid-template-columns:1fr} }

    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:9px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .btn:hover{border-color: rgba(255,138,0,.45)}

    .hero{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: radial-gradient(1000px 500px at 15% 0%, rgba(255,138,0,.09), transparent 50%),
                  radial-gradient(900px 450px at 85% 10%, rgba(61,220,151,.06), transparent 55%),
                  linear-gradient(180deg, rgba(15,33,51,.5), rgba(11,22,34,.25));
    }
    .hero-top{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .hero h3{margin:0; font-size:18px; letter-spacing:.3px}
    .subline{font-family:var(--mono); color:var(--muted); font-size:11px; line-height:1.35; margin-top:6px}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 560px){ .kpis{grid-template-columns: 1fr} }
    .kpi{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      border-radius: 16px;
      padding:10px 10px;
      min-height:64px;
    }
    .kpi .k{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .kpi .v{margin-top:6px; font-size:12px; line-height:1.25}

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.65);
      background: rgba(11,22,34,.65);
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.35);
      color: rgba(255,255,255,.8);
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .tab.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .content{
      padding:12px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){ .content{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(15,33,51,.30);
      border-radius: 16px;
      overflow:hidden;
    }
    .card-h{
      padding:10px 12px;
      border-bottom:1px solid rgba(26,50,75,.55);
      background: rgba(7,16,24,.45);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card-h b{font-size:12px; letter-spacing:.2px}
    .card-h span{font-family:var(--mono); font-size:10px; color:var(--muted)}
    .card-b{padding:10px 12px}

    .pillrow{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px}
    .pill{
      border:1px solid rgba(26,50,75,.75);
      background: rgba(7,16,24,.55);
      color: rgba(255,255,255,.85);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      user-select:none;
    }
    .pill:hover{border-color: rgba(255,138,0,.45)}
    .pill.active{border-color: rgba(255,138,0,.55); background: rgba(255,138,0,.08); color: rgba(255,138,0,.95)}

    .kv{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:10px 14px;
      padding:8px 0;
      border-bottom:1px dashed rgba(26,50,75,.45);
    }
    .kv:last-child{border-bottom:none}
    @media (max-width: 720px){ .kv{grid-template-columns:1fr} }
    .kv .k{font-family:var(--mono); font-size:11px; color: rgba(255,255,255,.78); line-height:1.35;}
    .kv .v{font-size:12px; color: rgba(231,238,247,.95); line-height:1.45; white-space:pre-wrap;}

    .notice{
      border:1px solid rgba(255,138,0,.35);
      background: rgba(255,138,0,.08);
      padding:10px 12px;
      border-radius: 16px;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.45;
      color: rgba(255,255,255,.85);
    }
    .flagBox{
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.35);
      border-radius: 16px;
      padding:12px;
      min-height:160px;
    }
    .flagBox img{
      max-width:100%;
      height:auto;
      border-radius: 12px;
      border:1px solid rgba(26,50,75,.65);
    }

    .listbox{
      max-height: 560px;
      overflow:auto;
      border:1px solid rgba(26,50,75,.65);
      background: rgba(7,16,24,.35);
      border-radius: 14px;
      padding:8px;
    }
    .chiprow{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      border:1px solid rgba(26,50,75,.7);
      background: rgba(7,16,24,.55);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      font-family:var(--mono);
      font-size:11px;
      color: rgba(255,255,255,.85);
      user-select:none;
    }
    .chip:hover{border-color: rgba(255,138,0,.45)}
    .chip b{color: rgba(255,138,0,.95); font-weight:800}

    .loading{display:inline-flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; color: var(--muted);}
    .spin{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,138,0,.9);
      animation: rot .9s linear infinite;
    }
    @keyframes rot{to{transform: rotate(360deg)}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">WIB</div>
        <div>
          <h1>World Intelligence Factbook</h1>
          <div class="sub">Drop-down navigation • atlas-style sections • maximal extraction</div>
        </div>
      </div>
      <div class="meta">
        <span id="status">loading…</span>
        <span style="opacity:.5">|</span>
        <span style="opacity:.7">entities:</span> <span id="count">0</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Navigator</h2>
            <div class="hint">Region → Entity. After load: section chips (Economy, Religion, Government, …).</div>
          </div>
          <div class="btns">
            <button class="btn" id="reload">reload</button>
            <button class="btn" id="copyLink">copy link</button>
          </div>
        </div>
        <div class="panel-b">
          <div class="row2">
            <div>
              <label class="small">Region</label>
              <select id="region"><option value="">All</option></select>
            </div>
            <div>
              <label class="small">Search</label>
              <input id="q" placeholder="Type country name or code…"/>
            </div>
          </div>

          <div style="margin-top:10px">
            <label class="small">Entity</label>
            <select id="country"><option value="">Select…</option></select>
          </div>

          <div style="margin-top:10px">
            <label class="small">Section</label>
            <select id="section"><option value="">Select…</option></select>
          </div>

          <div style="margin-top:10px" class="notice">
            Use the section chips in PROFILE for fast browsing. The dropdown is a direct selector for the same section set.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hero">
          <div class="hero-top">
            <div>
              <h3 id="title">Select an entity</h3>
              <div class="subline" id="subline">Structured fields are extracted and routed into stable topic sections.</div>
            </div>
            <div class="btns">
              <button class="btn" id="clearCache">clear cache</button>
            </div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="k">CODE</div><div class="v" id="k_code">—</div></div>
            <div class="kpi"><div class="k">REGION</div><div class="v" id="k_region">—</div></div>
            <div class="kpi"><div class="k">SECTION DEPTH</div><div class="v" id="k_depth">—</div></div>
            <div class="kpi"><div class="k">CURRENT SNAPSHOT</div><div class="v" id="k_now">—</div></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="profile">PROFILE</div>
          <div class="tab" data-tab="travel">TRAVEL</div>
          <div class="tab" data-tab="flags">FLAGS</div>
          <div class="tab" data-tab="compare">COMPARE</div>
          <div class="tab" data-tab="region">REGION</div>
        </div>

        <div class="content">
          <div class="card">
            <div class="card-h">
              <b id="mainTitle">Profile</b>
              <span id="mainMeta">—</span>
            </div>
            <div class="card-b" id="main">
              <div class="notice">Select an entity to render topic sections and extracted fields.</div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <b id="sideTitle">Summary</b>
              <span id="sideMeta">—</span>
            </div>
            <div class="card-b" id="side">
              <div class="notice">A concise overview will appear here.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  // ===== archive structure (your hosted layout) =====
  const ARCH = { root: "wifb", index: "wifb/wifbindex.html" };

  // ===== silent public time-series (no provenance UI) =====
  const WB = {
    base: "https://api.worldbank.org/v2/country",
    // Compact KPI line (header "CURRENT SNAPSHOT")
    indicators: [
      { key: "NY.GDP.MKTP.CD", label: "GDP", fmt: v => fmtNum(v) },
      { key: "FP.CPI.TOTL.ZG", label: "Infl", fmt: v => `${fmtNum(v)}%` },
      { key: "SP.POP.TOTL", label: "Pop", fmt: v => fmtNum(v) }
    ],
    yearMax: 2026
  };

  const $ = s => document.querySelector(s);
  const el = {
    status: $("#status"),
    count: $("#count"),
    reload: $("#reload"),
    copyLink: $("#copyLink"),
    clearCache: $("#clearCache"),
    region: $("#region"),
    q: $("#q"),
    country: $("#country"),
    section: $("#section"),
    title: $("#title"),
    subline: $("#subline"),
    k_code: $("#k_code"),
    k_region: $("#k_region"),
    k_depth: $("#k_depth"),
    k_now: $("#k_now"),
    mainTitle: $("#mainTitle"),
    mainMeta: $("#mainMeta"),
    main: $("#main"),
    sideTitle: $("#sideTitle"),
    sideMeta: $("#sideMeta"),
    side: $("#side"),
    tabs: document.querySelectorAll(".tab[data-tab]")
  };

  const state = {
    library: { items: [], byGroup: new Map(), html: "" },
    entities: [],
    byRegion: new Map(),
    tab: "profile",
    active: null,
    activeDoc: null,
    activeStruct: null, // {sections: Map(name-> {facts,text}), allFacts:[]}
    activeIso: null,
    activeSection: "",
    summary: "",
    flag: null,
    regionHTML: ""
  };

  // ===== utils =====
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtNum(x){
    if (x === null || x === undefined) return "—";
    const s = String(x);
    const n = Number(s.replace(/,/g,""));
    if (!isFinite(n)) return s;
    return n.toLocaleString(undefined);
  }
  function deepLink(code){
    const u = new URL(location.href);
    u.searchParams.set("c", code);
    return u.toString();
  }
  async function fetchText(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }
  function normalizeHref(v){
    if (!v) return "";
    if (v.startsWith("http")) return v;
    return v.replace(/^\.\//,"").replace(/^\//,"");
  }
  function cleanText(s){
    return (s || "")
      .replace(/\u00A0/g, " ")
      .replace(/[ \t]+\n/g, "\n")
      .replace(/\n{3,}/g, "\n\n")
      .trim();
  }

  // ===== index parsing =====
  function parseEntitiesFromIndex(html){
    const doc = new DOMParser().parseFromString(html, "text/html");
    const selects = Array.from(doc.querySelectorAll("select"));
    const sel = selects.find(s => s.querySelector('option[value*="geos/"]')) || selects[0];
    if (!sel) return [];

    const out = [];
    const nodes = Array.from(sel.children).filter(n => n.tagName === "OPTGROUP" || n.tagName === "OPTION");

    for (const node of nodes){
      if (node.tagName === "OPTGROUP"){
        const label = (node.getAttribute("label") || "").trim();
        for (const opt of Array.from(node.querySelectorAll("option"))){
          const v = (opt.getAttribute("value") || "").trim();
          if (!v.includes("geos/")) continue;
          const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
          if (!code) continue;
          out.push({
            code,
            name: (opt.textContent || "").trim() || code.toUpperCase(),
            regionLabel: label || "",
            href: `${ARCH.root}/` + normalizeHref(v)
          });
        }
      } else {
        const v = (node.getAttribute("value") || "").trim();
        if (!v.includes("geos/")) continue;
        const code = (v.match(/geos\/([a-z0-9_-]+)\.html/i)?.[1] || "").toLowerCase();
        if (!code) continue;
        out.push({
          code,
          name: (node.textContent || "").trim() || code.toUpperCase(),
          regionLabel: "",
          href: `${ARCH.root}/` + normalizeHref(v)
        });
      }
    }

    const seen = new Set();
    const clean = out.filter(x => { if (seen.has(x.code)) return false; seen.add(x.code); return true; });
    clean.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    return clean;
  }

  function buildRegionIndex(){
    const m = new Map();
    for (const e of state.entities){
      const r = e.regionLabel || "—";
      if (!m.has(r)) m.set(r, []);
      m.get(r).push(e);
    }
    for (const [k,arr] of m.entries()){
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      m.set(k, arr);
    }
    state.byRegion = m;
  }

  
  // ===== library extraction from index (acts as redesigned front-end) =====
  function parseLibraryFromIndex(indexHtml){
    // Collect non-geo links (guides, comparisons, notes, rank-order, flags, etc.)
    const doc = new DOMParser().parseFromString(indexHtml, "text/html");
    const anchors = Array.from(doc.querySelectorAll("a[href]"));
    const items = [];

    for (const a of anchors){
      const hrefRaw = (a.getAttribute("href") || "").trim();
      if (!hrefRaw) continue;
      const href = normalizeHref(hrefRaw);
      // skip geos (country pages handled separately)
      if (href.includes("geos/")) continue;

      // keep only internal html assets within the archive tree
      if (!href.match(/\.html?$/i)) continue;

      // avoid self-link duplicates
      const title = cleanText(a.textContent || "") || href.split("/").pop();
      if (!title) continue;

      // infer group by path
      let group = "Reference";
      if (href.includes("rankorder") || href.includes("rank_order") || href.includes("rank-order")) group = "Rank order";
      else if (href.includes("docs") || href.includes("guide") || href.includes("reference") || href.includes("notes")) group = "Guides";
      else if (href.includes("fields") || href.includes("appendix")) group = "Appendices";
      else if (href.includes("flag") || href.includes("flags")) group = "Flags";
      else if (href.includes("maps") || href.includes("map")) group = "Maps";

      items.push({
        title,
        group,
        href: `${ARCH.root}/` + href
      });
    }

    // de-dup by href
    const seen = new Set();
    const dedup = [];
    for (const it of items){
      if (seen.has(it.href)) continue;
      seen.add(it.href);
      // filter out obvious nav chrome anchors with too-short titles
      if ((it.title || "").length < 3) continue;
      dedup.push(it);
    }

    // group
    const byGroup = new Map();
    for (const it of dedup){
      if (!byGroup.has(it.group)) byGroup.set(it.group, []);
      byGroup.get(it.group).push(it);
    }
    for (const [g, arr] of byGroup.entries()){
      arr.sort((a,b)=>a.title.localeCompare(b.title));
      byGroup.set(g, arr);
    }

    return { items: dedup, byGroup };
  }

  async function renderLibrary(){
    // Must have loaded index already; if not, show placeholder
    const lib = state.library;
    if (!lib.items?.length){
      return `<div class="notice">Library is not available yet.</div>`;
    }

    // Build chips by group and a list for active group
    const groups = Array.from(lib.byGroup.keys()).sort((a,b)=>a.localeCompare(b));
    const activeGroup = lib.activeGroup && lib.byGroup.has(lib.activeGroup) ? lib.activeGroup : (groups[0] || "Reference");
    lib.activeGroup = activeGroup;

    const chips = groups.map(g => `
      <div class="pill ${g===activeGroup ? "active":""}" data-libgroup="${escapeHtml(g)}">${escapeHtml(g)}</div>
    `).join("");

    const list = (lib.byGroup.get(activeGroup) || []).slice(0, 400).map(it => `
      <div class="chip" data-libopen="${escapeHtml(it.href)}" title="${escapeHtml(it.title)}">
        ${escapeHtml(it.title)}
      </div>
    `).join("");

    // If a page is open, render extracted sections (like country pages)
    let viewer = `<div class="notice">Select a library item to open it.</div>`;
    if (lib.open){
      if (lib.loading){
        viewer = `<div class="loading"><span class="spin"></span><span>Opening…</span></div>`;
      } else if (lib.openStruct){
        const names = Array.from(lib.openStruct.sections.keys()).slice(0, 60);
        const sec = lib.openSection && lib.openStruct.sections.has(lib.openSection) ? lib.openSection : (names[0] || "");
        lib.openSection = sec;

        const secChips = names.map(n => `
          <div class="pill ${n===sec ? "active":""}" data-libsec="${escapeHtml(n)}">${escapeHtml(n)}</div>
        `).join("");

        const pack = lib.openStruct.sections.get(sec) || { facts: [], text: "" };
        const intro = pack.text ? `<div class="notice" style="margin-bottom:10px">${escapeHtml(pack.text)}</div>` : "";
        viewer = `<div class="pillrow">${secChips}</div>${intro}${renderKV(pack.facts)}`;
      } else {
        viewer = `<div class="notice">This item could not be rendered.</div>`;
      }
    }

    return `
      <div class="notice" style="margin-bottom:10px">
        Library provides redesigned access to the archive’s reference pages (guides, rank order, flags, maps).
      </div>
      <div class="pillrow">${chips}</div>
      <div class="content" style="padding:0; grid-template-columns: .9fr 1.1fr;">
        <div class="card" style="margin:0;">
          <div class="card-h"><b>${escapeHtml(activeGroup)}</b><span>${(lib.byGroup.get(activeGroup)||[]).length} items</span></div>
          <div class="card-b"><div class="listbox"><div class="chiprow">${list || `<div class="notice">No items.</div>`}</div></div></div>
        </div>
        <div class="card" style="margin:0;">
          <div class="card-h"><b>${escapeHtml(lib.openTitle || "Viewer")}</b><span>${lib.open ? "open" : "—"}</span></div>
          <div class="card-b" id="libViewer">${viewer}</div>
        </div>
      </div>
    `;
  }

  async function openLibraryItem(href, title){
    state.library.open = href;
    state.library.openTitle = title || "Viewer";
    state.library.loading = true;
    state.library.openStruct = null;
    state.library.openSection = "";
    renderActiveView();

    try{
      const html = await fetchText(href);
      const doc = new DOMParser().parseFromString(html, "text/html");
      const struct = buildMaxSections(doc); // reuse same extractor
      state.library.openStruct = struct;
      state.library.loading = false;
      renderActiveView();
    } catch {
      state.library.loading = false;
      state.library.openStruct = null;
      renderActiveView();
    }
  }

  // ===== extraction primitives =====
  function dedupeFacts(facts){
    const seen = new Set();
    const out = [];
    for (const f of facts || []){
      const k = (f.k || "").trim();
      const v = (f.v || "").trim();
      if (!k || !v) continue;
      const key = (k.toLowerCase() + "::" + v.toLowerCase()).slice(0, 900);
      if (seen.has(key)) continue;
      seen.add(key);
      out.push({ k, v });
      if (out.length >= 6000) break;
    }
    return out;
  }

  function extractKeyValueTables(root){
    const facts = [];
    for (const t of Array.from(root.querySelectorAll("table"))){
      const rows = Array.from(t.querySelectorAll("tr"));
      for (const r of rows){
        const cells = Array.from(r.querySelectorAll("th,td"));
        if (cells.length < 2) continue;
        const k = cleanText(cells[0].innerText);
        const v = cleanText(cells.slice(1).map(c => c.innerText).join(" | "));
        if (!k || !v) continue;
        if (k.length > 200) continue;
        facts.push({ k, v });
      }
    }
    return facts;
  }

  function extractDefinitionLists(root){
    const facts = [];
    for (const dl of Array.from(root.querySelectorAll("dl"))){
      for (const dt of Array.from(dl.querySelectorAll("dt"))){
        const dd = dt.nextElementSibling && dt.nextElementSibling.tagName.toLowerCase() === "dd" ? dt.nextElementSibling : null;
        if (!dd) continue;
        const k = cleanText(dt.innerText);
        const v = cleanText(dd.innerText);
        if (k && v) facts.push({ k, v });
      }
    }
    return facts;
  }

  function extractLabeledBlocks(root){
    const facts = [];
    const text = cleanText(root.innerText || "");
    const lines = text.split("\n").map(x => x.trim()).filter(Boolean);
    for (const ln of lines){
      const m = ln.match(/^([A-Za-z][A-Za-z0-9 \-\/(),.%]{2,140})\s*:\s*(.{2,})$/);
      if (!m) continue;
      const k = m[1].trim();
      const v = m[2].trim();
      if (!k || !v) continue;
      facts.push({ k, v });
    }
    return facts;
  }

  function extractISOFromDoc(doc){
    const text = doc.body?.innerText || "";
    const isoLine = text.match(/ISO\s*3166\s*country\s*codes?\s*:\s*([^\n\r]+)/i)?.[1] || null;
    if (!isoLine) return null;
    const a3 = isoLine.match(/Alpha-?3\s*:\s*([A-Z]{3})/i)?.[1]?.toUpperCase() || null;
    const a2 = isoLine.match(/Alpha-?2\s*:\s*([A-Z]{2})/i)?.[1]?.toUpperCase() || null;
    if (!a2 && !a3) return null;
    return { a2, a3 };
  }

  function extractFlagFromDoc(doc, pageHref){
    const imgs = Array.from(doc.querySelectorAll("img"));
    const scored = imgs.map(img => {
      const src = img.getAttribute("src") || "";
      const alt = (img.getAttribute("alt") || "").toLowerCase();
      const t = (src + " " + alt).toLowerCase();
      let score = 0;
      if (t.includes("flag")) score += 6;
      if (t.includes("smallflag") || t.includes("flag_")) score += 3;
      if (t.includes("seal") || t.includes("map")) score -= 2;
      if (src.match(/\.(svg|png|jpg|jpeg|gif)$/i)) score += 1;
      return { src, alt: img.getAttribute("alt") || "Flag", score };
    }).sort((a,b)=>b.score-a.score);

    const best = scored.find(x => x.score >= 4);
    if (!best?.src) return null;

    try{
      const base = new URL(pageHref, location.href);
      return { alt: best.alt, src: new URL(best.src, base).toString() };
    } catch { return null; }
  }

  // ===== canonical Atlas-like topic routing =====
  function buildCanonicalSections(allFacts){
    const CANON = [
      "Overview",
      "Introduction",
      "Geography",
      "People and Society",
      "Religion",
      "Government",
      "Economy",
      "Energy",
      "Communications",
      "Transportation",
      "Military and Security",
      "Terrorism",
      "Transnational Issues",
      "All fields"
    ];

    const ROUTES = [
      ["Introduction", ["background","introduction","overview","brief","name","capital","flag description","national anthem","national symbol"]],
      ["Geography", ["geography","location","area","land","water","coastline","climate","terrain","natural resources","environment","hazards","elevation","land use","irrigated","urbanization","population distribution"]],
      ["People and Society", ["people","society","population","nationality","ethnic","language","age structure","dependency","sex ratio","education","literacy","health","mortality","life expectancy","fertility","hiv","obesity","sanitation","drinking water","physicians","hospital","migration","refugee","demographics"]],
      ["Religion", ["religion","religions","religious","faith","church","mosque","temple","catholic","protestant","orthodox","islam","muslim","sunni","shia","hindu","buddhist","jewish","judaism","atheist","none"]],
      ["Government", ["government","country name","constitution","legal","citizenship","suffrage","executive","legislative","judicial","political","elections","administrative","diplomatic","international organization","national holiday","law enforcement"]],
      ["Economy", ["economy","gdp","growth","inflation","cpi","unemployment","labor","poverty","budget","revenue","expenditures","debt","tax","banking","credit","investment","industry","agriculture","services","trade","exports","imports","reserves","exchange rate","currency","tourism","market","remittances"]],
      ["Energy", ["energy","electricity","oil","petroleum","gas","coal","refined","renewable","nuclear","power","consumption","production","pipelines"]],
      ["Communications", ["communications","telephone","mobile","internet","broadband","telecom","radio","television","tv","satellite","media"]],
      ["Transportation", ["transportation","airports","heliports","railways","roadways","waterways","merchant marine","ports","terminals","pipelines","civil aviation"]],
      ["Military and Security", ["military","security","armed forces","expenditures","service age","conscription","paramilitary","defense","weapons","peacekeeping"]],
      ["Terrorism", ["terrorism","terrorist","terror","extremist"]],
      ["Transnational Issues", ["transnational","disputes","refugees","trafficking","illicit","drugs","organized crime","international disputes","stateless persons","environmental agreements"]]
    ];

    const sections = new Map();
    for (const n of CANON) sections.set(n, { facts: [], text: "" });

    // Overview gets top facts separately later
    for (const f of allFacts){
      const blob = (f.k + " " + f.v).toLowerCase();

      let matchedAny = false;
      for (const [topic, keys] of ROUTES){
        if (keys.some(k => blob.includes(k))){
          sections.get(topic).facts.push(f);
          matchedAny = true;
        }
      }

      // keep everything accessible
      sections.get("All fields").facts.push(f);

      // if not matched anywhere, let it still show in People/Society (broad) to avoid “orphan” data
      if (!matchedAny) sections.get("People and Society").facts.push(f);
    }

    // de-dup and cap
    for (const [name, pack] of sections.entries()){
      pack.facts = dedupeFacts(pack.facts).slice(0, 2400);
      sections.set(name, pack);
    }

    return sections;
  }

  function pickTopFacts(allFacts){
    const pri = [
      "Capital","Population","Area","Government type","Independence","Nationality","Ethnic groups",
      "Languages","Religions","Currency","GDP","GDP -","Unemployment","Inflation","Exports","Imports"
    ].map(x=>x.toLowerCase());

    const picked = [];
    const used = new Set();

    for (const key of pri){
      const hit = allFacts.find(f => (f.k||"").toLowerCase().includes(key));
      if (hit){
        const id = (hit.k+"::"+hit.v).toLowerCase();
        if (!used.has(id)){
          used.add(id);
          picked.push(hit);
        }
      }
      if (picked.length >= 24) break;
    }

    for (const f of allFacts){
      const id = (f.k+"::"+f.v).toLowerCase();
      if (used.has(id)) continue;
      picked.push(f);
      if (picked.length >= 90) break;
    }
    return picked;
  }

  function extractHeadingsSections(doc){
    const body = doc.body;
    const heads = Array.from(body.querySelectorAll("h1,h2,h3,h4,h5,h6"));
    const sections = new Map();
    if (!heads.length) return sections;

    for (let i=0;i<heads.length;i++){
      const h = heads[i];
      const name = cleanText(h.innerText || "");
      if (!name || name.length > 120) continue;

      const nodes = [];
      let cur = h.nextElementSibling;
      while (cur && !/^(h1|h2|h3|h4|h5|h6)$/i.test(cur.tagName)){
        nodes.push(cur);
        cur = cur.nextElementSibling;
      }

      const chunk = document.createElement("div");
      for (const n of nodes) chunk.appendChild(n.cloneNode(true));

      const facts = dedupeFacts([
        ...extractKeyValueTables(chunk),
        ...extractDefinitionLists(chunk),
        ...extractLabeledBlocks(chunk)
      ]);

      const ps = Array.from(chunk.querySelectorAll("p,li"));
      const text = cleanText(ps.slice(0, 10).map(p => p.innerText).join("\n\n"));

      const prev = sections.get(name);
      if (prev){
        prev.facts = dedupeFacts(prev.facts.concat(facts));
        prev.text = cleanText([prev.text, text].filter(Boolean).join("\n\n"));
        sections.set(name, prev);
      } else {
        sections.set(name, { facts, text });
      }
    }

    return sections;
  }

  function buildMaxSections(doc){
    const body = doc.body;

    const globalFacts = dedupeFacts([
      ...extractKeyValueTables(body),
      ...extractDefinitionLists(body),
      ...extractLabeledBlocks(body)
    ]);

    // canonical “Atlas-style” sections from the full fact universe
    const canon = buildCanonicalSections(globalFacts);

    // merge real headings as extra sections; if a heading matches a canonical name, enrich it
    const headingSections = extractHeadingsSections(doc);
    for (const [n, pack] of headingSections.entries()){
      const name = (n || "").trim();
      if (!name) continue;

      if (canon.has(name)){
        const cur = canon.get(name);
        cur.facts = dedupeFacts(cur.facts.concat(pack.facts || [])).slice(0, 2400);
        cur.text = cleanText([cur.text, pack.text].filter(Boolean).join("\n\n"));
        canon.set(name, cur);
      } else {
        canon.set(name, {
          facts: dedupeFacts(pack.facts || []).slice(0, 2400),
          text: cleanText(pack.text || "")
        });
      }
    }

    // overview: top facts + first paragraph
    const firstText = cleanText((body.querySelector("p")?.innerText) || "");
    const ov = canon.get("Overview") || { facts: [], text: "" };
    ov.facts = dedupeFacts(ov.facts.concat(pickTopFacts(globalFacts))).slice(0, 2400);
    ov.text = ov.text || firstText;
    canon.set("Overview", ov);

    return { sections: canon, allFacts: globalFacts };
  }

  function pickFacts(allFacts, keys){
    const out = [];
    const lk = keys.map(k => k.toLowerCase());
    for (const k of lk){
      const hit = allFacts.find(f => (f.k||"").toLowerCase().includes(k));
      if (hit) out.push(hit);
      if (out.length >= 10) break;
    }
    return out;
  }

  function guessSummary(struct){
    const pref = ["Overview","Introduction","Geography","People and Society","Government","Economy"];
    let t = "";
    for (const p of pref){
      const hit = struct.sections.get(p);
      if (hit && hit.text){ t = hit.text; break; }
    }
    if (!t){
      const any = Array.from(struct.sections.values()).map(s => s.text).find(Boolean);
      t = any || "";
    }
    const picks = pickFacts(struct.allFacts, ["Capital","Population","Area","Government type","Currency","Languages","Religions","GDP"]);
    const ribbon = picks.length ? ("\n\n" + picks.map(p => `• ${p.k}: ${p.v}`).join("\n")) : "";
    return cleanText((t ? t.split("\n\n").slice(0,2).join("\n\n") : "") + ribbon);
  }

  function travelFacts(struct){
    const tokens = ["travel","visa","passport","entry","health","vaccin","customs","safety","security","crime","airport","ports","transport","road","rail","driving","emergency","medical"];
    const hits = [];
    for (const f of struct.allFacts){
      const t = (f.k + " " + f.v).toLowerCase();
      if (tokens.some(x => t.includes(x))) hits.push(f);
      if (hits.length >= 900) break;
    }
    return hits;
  }

  
  // ===== silent enrichment (no provenance UI, no error surfaces) =====
  const ENRICH = {
    enabled: true,
    // keep tight for reliability; can extend later
    ttlDays: 7,
    // Section-scoped indicator sets
    sectionIndicators: {
      "Economy": [
        { key:"NY.GDP.MKTP.CD", label:"GDP (current US$)" },
        { key:"NY.GDP.PCAP.CD", label:"GDP per capita (current US$)" },
        { key:"FP.CPI.TOTL.ZG", label:"Inflation (annual %)" },
        { key:"SL.UEM.TOTL.ZS", label:"Unemployment (%, ILO)" },
        { key:"GC.DOD.TOTL.GD.ZS", label:"General government gross debt (% of GDP)" },
        { key:"BN.CAB.XOKA.GD.ZS", label:"Current account balance (% of GDP)" },
        { key:"NE.EXP.GNFS.CD", label:"Exports of goods & services (current US$)" },
        { key:"NE.IMP.GNFS.CD", label:"Imports of goods & services (current US$)" }
      ],
      "People and Society": [
        { key:"SP.POP.TOTL", label:"Population" },
        { key:"SP.DYN.LE00.IN", label:"Life expectancy (years)" },
        { key:"SP.DYN.TFRT.IN", label:"Fertility rate (births per woman)" },
        { key:"SP.URB.TOTL.IN.ZS", label:"Urban population (% of total)" }
      ],
      "Energy": [
        { key:"EG.ELC.ACCS.ZS", label:"Access to electricity (% of population)" },
        { key:"EG.USE.PCAP.KG.OE", label:"Energy use (kg oil equivalent per capita)" },
        { key:"EN.ATM.CO2E.PC", label:"CO₂ emissions (t per capita)" }
      ],
      "Communications": [
        { key:"IT.NET.USER.ZS", label:"Internet users (% of population)" },
        { key:"IT.CEL.SETS.P2", label:"Mobile subscriptions (per 100 people)" }
      ]
    }
  };

  function enrichCacheKey(){ return "wib_enrich_cache_v1"; }
  function nowMs(){ return Date.now(); }
  function daysToMs(d){ return d*24*60*60*1000; }

  function getEnrichCache(){
    try{ return JSON.parse(localStorage.getItem(enrichCacheKey()) || "{}"); } catch { return {}; }
  }
  function setEnrichCache(v){
    try{ localStorage.setItem(enrichCacheKey(), JSON.stringify(v||{})); } catch {}
  }


  // ===== indicator-wide ranking cache (1 call per indicator) =====
  function indCacheKey(){ return "wib_indicator_cache_v1"; }
  function getIndCache(){ try{ return JSON.parse(localStorage.getItem(indCacheKey()) || "{}"); } catch { return {}; } }
  function setIndCache(v){ try{ localStorage.setItem(indCacheKey(), JSON.stringify(v||{})); } catch {} }

  async function ensureWBCountryIndex(){
    // Build a silent name->iso2 map for archive entity names
    if (state.wbNameToIso2) return;
    try{
      const url = `${WB.base}?format=json&per_page=400`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("idx");
      const j = await r.json();
      const data = Array.isArray(j) ? j[1] : null;
      const map = new Map();
      if (Array.isArray(data)){
        for (const c of data){
          const nm = (c?.name || "").toLowerCase().trim();
          const iso2 = (c?.id || "").toLowerCase().trim(); // WB uses iso2 as id
          if (nm && iso2 && iso2.length===2) map.set(nm, iso2);
          // also store alternative names if present
          const alt = (c?.iso2Code || "").toLowerCase().trim();
          if (nm && alt && alt.length===2) map.set(nm, alt);
        }
      }
      // add a few normalization passes for archive naming quirks
      const norm = (s) => s.toLowerCase()
        .replace(/\s+/g," ")
        .replace(/&/g,"and")
        .replace(/,.*$/,"")
        .trim();
      const map2 = new Map(map);
      for (const [k,v] of map.entries()){
        map2.set(norm(k), v);
      }
      state.wbNameToIso2 = map2;
    } catch {
      state.wbNameToIso2 = new Map();
    }
  }

  async function getIndicatorLatestByCountry(indicatorId, yearMax){
    await ensureWBCountryIndex();

    const cache = getIndCache();
    const key = `${indicatorId}::${yearMax}`;
    const ttl = daysToMs(ENRICH?.ttlDays || 7);

    if (cache[key] && cache[key].ts && (nowMs() - cache[key].ts) < ttl && Array.isArray(cache[key].rows)){
      return cache[key].rows;
    }

    // One call: indicator across all countries, many years
    const url = `https://api.worldbank.org/v2/indicator/${encodeURIComponent(indicatorId)}?format=json&per_page=20000`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("ind");
    const j = await r.json();
    const data = Array.isArray(j) ? j[1] : null;
    if (!Array.isArray(data)) throw new Error("ind2");

    // pick latest observation per iso2
    const best = new Map(); // iso2 -> {iso2,name,year,value}
    for (const row of data){
      if (!row) continue;
      const iso2 = (row?.country?.id || "").toLowerCase().trim(); // WB country id often iso2
      const name = (row?.country?.value || "").trim();
      const year = Number(row?.date);
      const value = row?.value;
      if (!iso2 || iso2.length!==2) continue;
      if (!isFinite(year) || year > yearMax) continue;
      if (value === null || value === undefined) continue;

      const cur = best.get(iso2);
      if (!cur || year > cur.year){
        best.set(iso2, { iso2, name, year, value });
      }
    }

    const rows = Array.from(best.values());
    cache[key] = { ts: nowMs(), rows };
    setIndCache(cache);
    return rows;
  }
  async function wbLatestSafe(iso3, indicator){
    try{ return await wbLatest(iso3, indicator); } catch { return null; }
  }

  
  async function imfLatestSafe(iso2, series){
    // Optional provider: may fail due to CORS; always silent.
    // Uses IMF DataMapper endpoint if accessible.
    // Returns {year, value} or null.
    try{
      // Example: https://www.imf.org/external/datamapper/api/v1/NGDPD/USA
      const url = `https://www.imf.org/external/datamapper/api/v1/${encodeURIComponent(series)}/${encodeURIComponent(iso2)}`;
      const r = await fetch(url);
      if (!r.ok) return null;
      const j = await r.json();
      // structure: { values: { SERIES: { ISO: { "2026": value, ... } } } }
      const vals = j?.values?.[series]?.[iso2];
      if (!vals) return null;
      const years = Object.keys(vals).map(y=>Number(y)).filter(y=>isFinite(y) && y<=WB.yearMax).sort((a,b)=>b-a);
      if (!years.length) return null;
      const y = years[0];
      const v = vals[String(y)];
      if (v===null || v===undefined) return null;
      return { year:y, value:v };
    } catch { return null; }
  }

async function fetchIndicatorBundle(iso3, indicatorKeys){
    if (!iso3 || !indicatorKeys?.length) return {};
    const cache = getEnrichCache();
    const entry = cache[iso3] || null;
    const fresh = entry && entry.ts && (nowMs() - entry.ts) < daysToMs(ENRICH.ttlDays);

    // If cached and covers all keys, reuse
    if (fresh && entry.data){
      const ok = indicatorKeys.every(k => entry.data[k]);
      if (ok) return entry.data;
    }

    // Merge: keep existing cached keys, refresh missing/expired
    const base = (entry && entry.data) ? entry.data : {};
    const missing = indicatorKeys.filter(k => !base[k] || !fresh);

    const fetched = await Promise.all(missing.map(async k => {
      const last = await wbLatestSafe(iso3, k);
      return [k, last];
    }));

    for (const [k,last] of fetched){
      if (last) base[k] = last;
    }

    cache[iso3] = { ts: nowMs(), data: base };
    setEnrichCache(cache);
    return base;
  }

  function formatLatestValue(x){
    if (!x) return null;
    const y = (x.year !== undefined && x.year !== null) ? String(x.year) : "";
    const v = (x.value !== undefined && x.value !== null) ? String(x.value) : "";
    if (!v) return null;
    // numeric formatting
    const n = Number(String(x.value).replace(/,/g,""));
    const vv = (isFinite(n) ? n.toLocaleString(undefined) : v);
    return (y ? `${vv} (${y})` : vv);
  }

  function prependFacts(sectionPack, facts){
    if (!sectionPack || !facts?.length) return;
    sectionPack.facts = dedupeFacts(facts.concat(sectionPack.facts || [])).slice(0, 2400);
  }

  async function enrichStructWithLatest(struct, iso){
    if (!ENRICH.enabled) return;
    if (!struct || !iso?.a3) return;

    // gather all requested keys across sections
    const secNames = Object.keys(ENRICH.sectionIndicators || {});
    const allKeys = [];
    for (const s of secNames){
      for (const it of (ENRICH.sectionIndicators[s] || [])){
        if (it?.key) allKeys.push(it.key);
      }
    }
    const uniqKeys = Array.from(new Set(allKeys));
    if (!uniqKeys.length) return;

    const bundle = await fetchIndicatorBundle(iso.a3, uniqKeys);
    if (!bundle || !Object.keys(bundle).length) return;

    // For each target section, add "Current quantitative snapshot" at the top (as facts)
    for (const sec of secNames){
      if (!struct.sections.has(sec)) continue;
      const pack = struct.sections.get(sec);

      const rows = [];
      for (const it of (ENRICH.sectionIndicators[sec] || [])){
        const last = bundle[it.key];
        const val = formatLatestValue(last);
        if (!val) continue;
        rows.push({ k: it.label, v: val });
      }
      if (!rows.length) continue;

      // snapshot header line (first)
      const header = { k: "Current quantitative snapshot", v: rows.map(r => `${r.k}: ${r.v}`).join(" • ") };
      prependFacts(pack, [header, ...rows]);
      struct.sections.set(sec, pack);
    }
  }

  // ===== comparisons (silent) =====
  async function wbLatest(iso3, indicator){
    const url = `${WB.base}/${encodeURIComponent(iso3)}/indicator/${encodeURIComponent(indicator)}?format=json&per_page=20000`;
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const data = Array.isArray(j) ? j[1] : null;
    if (!Array.isArray(data)) return null;
    const rows = data
      .filter(d => d && d.value !== null && d.date && Number(d.date) <= WB.yearMax)
      .sort((a,b) => Number(b.date) - Number(a.date));
    if (!rows.length) return null;
    return { year: Number(rows[0].date), value: rows[0].value };
  }

  async function silentSnapshot(iso){
    try{
      if (!iso?.a3) return null;
      const parts = [];
      for (const ind of WB.indicators){
        const last = await wbLatest(iso.a3, ind.key);
        if (last) parts.push(`${ind.label} ${last.year}: ${ind.fmt(last.value)}`);
      }
      return parts.length ? parts.join(" • ") : null;
    } catch { return null; }
  }

  function getIsoCache(){
    try{ return JSON.parse(localStorage.getItem("wib_iso_cache_v1") || "{}"); } catch { return {}; }
  }
  function setIsoCache(map){ localStorage.setItem("wib_iso_cache_v1", JSON.stringify(map || {})); }

  async function buildComparisonForActive(){
    if (!state.activeIso?.a3) return null;
    const cache = getIsoCache();
    cache[state.active.code] = state.activeIso.a3;
    setIsoCache(cache);

    const entries = Object.entries(cache).slice(0, 160);
    const result = [];

    for (const ind of WB.indicators){
      const batch = await Promise.all(entries.map(async ([code, iso3]) => {
        const last = await wbLatest(iso3, ind.key);
        if (!last) return null;
        return { code, year:last.year, value:last.value };
      }));
      const rows = batch.filter(Boolean);
      rows.sort((a,b) => b.value - a.value);

      const activeRow = rows.find(r => r.code === state.active.code) || null;
      const rank = activeRow ? (rows.indexOf(activeRow)+1) : null;

      result.push({
        label: ind.label,
        year: activeRow?.year || rows[0]?.year || null,
        rank,
        total: rows.length,
        top: rows.slice(0,8),
        bottom: rows.slice(-8).reverse()
      });
    }
    return result;
  }

  // ===== UI helpers =====
  function renderRegions(){
    const labels = Array.from(new Set(state.entities.map(e => e.regionLabel).filter(Boolean))).sort();
    el.region.innerHTML = `<option value="">All</option>` + labels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
  }

  function renderCountries(){
    const q = (el.q.value||"").trim().toLowerCase();
    const reg = el.region.value || "";
    const rows = state.entities.filter(e => {
      if (reg && e.regionLabel !== reg) return false;
      if (!q) return true;
      return e.name.toLowerCase().includes(q) || e.code.toLowerCase().includes(q);
    });

    el.country.innerHTML =
      `<option value="">Select…</option>` +
      rows.slice(0, 3500).map(e => `<option value="${escapeHtml(e.code)}">${escapeHtml(e.name)} (${escapeHtml(e.code)})</option>`).join("");

    renderRegionTab();
  }

  function renderSectionDropdown(){
    if (!state.activeStruct){
      el.section.innerHTML = `<option value="">Select…</option>`;
      return;
    }

    // preferred Atlas order
    const preferred = [
      "Overview",
      "Introduction","Geography","People and Society","Religion","Government","Economy",
      "Energy","Communications","Transportation","Military and Security","Terrorism","Transnational Issues",
      "All fields"
    ];

    const names = Array.from(state.activeStruct.sections.keys());
    const canonOrdered = preferred.filter(x => state.activeStruct.sections.has(x));
    const extra = names.filter(n => !preferred.includes(n)).sort((a,b)=>a.localeCompare(b));
    const ordered = canonOrdered.concat(extra).slice(0, 120);

    el.section.innerHTML =
      `<option value="">Select…</option>` +
      ordered.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

    if (!state.activeSection || !state.activeStruct.sections.has(state.activeSection)){
      state.activeSection = canonOrdered[0] || ordered[0] || "Overview";
    }
    el.section.value = state.activeSection;
  }

  function setTab(tab){
    state.tab = tab;
    el.tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab")===tab));
    renderActiveView();
  }

  function renderKV(facts){
    const f = (facts || []).slice(0, 2600);
    if (!f.length) return `<div class="notice">No fields detected for this section.</div>`;
    return f.map(x => `
      <div class="kv">
        <div class="k">${escapeHtml(x.k)}</div>
        <div class="v">${escapeHtml(x.v)}</div>
      </div>
    `).join("");
  }

  function renderRegionTab(){
    const reg = el.region.value || "";
    const regions = Array.from(state.byRegion.keys()).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    const chips = regions.filter(r => r !== "—").map(r => {
      const n = (state.byRegion.get(r)||[]).length;
      const active = (r === reg);
      return `<div class="chip" data-reg="${escapeHtml(r)}" style="${active ? "border-color:rgba(255,138,0,.55); background:rgba(255,138,0,.08)" : ""}">
        <b>${escapeHtml(r)}</b>&nbsp;<span style="opacity:.8">${n}</span>
      </div>`;
    }).join("");

    const rows = state.entities
      .filter(e => !reg || e.regionLabel === reg)
      .slice(0, 4000);

    const list = rows.map(e => `
      <div class="chip" data-open="${escapeHtml(e.code)}" title="${escapeHtml(e.name)}">
        ${escapeHtml(e.name)} <span style="opacity:.75">(${escapeHtml(e.code)})</span>
      </div>
    `).join("");

    state.regionHTML = `
      <div class="notice" style="margin-bottom:10px">
        Browse by region. Click a region chip to filter, then click an entity to open.
      </div>
      <div class="chiprow" style="margin-bottom:10px">${chips || `<div class="notice">No region groups available.</div>`}</div>
      <div class="listbox"><div class="chiprow">${list || `<div class="notice">No entities in this filter.</div>`}</div></div>
    `;
  }

  // ===== view rendering =====
  async function renderActiveView(){
    if (!state.activeStruct){
      el.mainTitle.textContent = "Profile";
      el.mainMeta.textContent = "—";
      el.main.innerHTML = `<div class="notice">Select an entity to render topic sections and extracted fields.</div>`;
      el.sideTitle.textContent = "Summary";
      el.sideMeta.textContent = "—";
      el.side.innerHTML = `<div class="notice">A concise overview will appear here.</div>`;
      return;
    }

    const struct = state.activeStruct;

    if (state.tab === "profile"){
      el.mainTitle.textContent = "Profile";
      el.mainMeta.textContent = "Sections";

      const preferred = [
        "Overview",
        "Introduction","Geography","People and Society","Religion","Government","Economy",
        "Energy","Communications","Transportation","Military and Security","Terrorism","Transnational Issues",
        "All fields"
      ];

      const names = Array.from(struct.sections.keys());
      const canonOrdered = preferred.filter(x => struct.sections.has(x));
      const extra = names.filter(n => !preferred.includes(n)).sort((a,b)=>a.localeCompare(b));
      const ordered = canonOrdered.concat(extra).slice(0, 80);

      if (!state.activeSection || !struct.sections.has(state.activeSection)){
        state.activeSection = canonOrdered[0] || ordered[0] || "Overview";
        el.section.value = state.activeSection;
      }

      const chips = ordered.map(n => `
        <div class="pill ${n===state.activeSection ? "active":""}" data-sec="${escapeHtml(n)}">${escapeHtml(n)}</div>
      `).join("");

      const pack = struct.sections.get(state.activeSection) || { facts: [], text: "" };
      const intro = pack.text ? `<div class="notice" style="margin-bottom:10px">${escapeHtml(pack.text)}</div>` : "";

      el.main.innerHTML = `<div class="pillrow">${chips}</div>${intro}${renderKV(pack.facts)}`;

      el.main.querySelectorAll("[data-sec]").forEach(b => {
        b.addEventListener("click", () => {
          state.activeSection = b.getAttribute("data-sec") || "";
          el.section.value = state.activeSection;
          renderActiveView();
        });
      });

      el.sideTitle.textContent = "Summary";
      el.sideMeta.textContent = "Generated";
      el.side.innerHTML = `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(state.summary || "")}</div>`;
      return;
    }

    if (state.tab === "travel"){
      el.mainTitle.textContent = "Travel";
      el.mainMeta.textContent = "Extracted";
      const tf = travelFacts(struct);
      el.main.innerHTML = tf.length ? renderKV(tf) : `<div class="notice">No travel-relevant fields were detected with high confidence.</div>`;

      el.sideTitle.textContent = "Highlights";
      el.sideMeta.textContent = "Extracted";
      const picks = pickFacts(struct.allFacts, ["Visa", "Entry", "Health", "Safety", "Airports", "Ports", "Roadways", "Railways"]);
      el.side.innerHTML = picks.length
        ? `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(picks.map(p => `• ${p.k}: ${p.v}`).join("\n"))}</div>`
        : `<div class="notice">No highlights detected.</div>`;
      return;
    }

    if (state.tab === "flags"){
      el.mainTitle.textContent = "Flag";
      el.mainMeta.textContent = "Detected";
      el.main.innerHTML = state.flag?.src
        ? `<div class="flagBox"><img src="${escapeHtml(state.flag.src)}" alt="${escapeHtml(state.flag.alt||"Flag")}"/></div>`
        : `<div class="notice">No flag image detected.</div>`;

      el.sideTitle.textContent = "Description";
      el.sideMeta.textContent = "Extracted";
      const desc = pickFacts(struct.allFacts, ["Flag description","National symbol","National anthem"]);
      el.side.innerHTML = desc.length
        ? `<div style="white-space:pre-wrap; font-size:12px; line-height:1.6">${escapeHtml(desc.map(d => `• ${d.k}: ${d.v}`).join("\n"))}</div>`
        : `<div class="notice">No description detected.</div>`;
      return;
    }

    if (state.tab === "compare"){
      el.mainTitle.textContent = "Compare";
      el.mainMeta.textContent = "Rankings";
      el.sideTitle.textContent = "Focus";
      el.sideMeta.textContent = "—";

      // Indicator catalog (extendable)
      const catalog = [
        { id:"NY.GDP.MKTP.CD", label:"GDP (current US$)", fmt: v => fmtNum(v) },
        { id:"NY.GDP.PCAP.CD", label:"GDP per capita (current US$)", fmt: v => fmtNum(v) },
        { id:"FP.CPI.TOTL.ZG", label:"Inflation (annual %)", fmt: v => `${fmtNum(v)}%` },
        { id:"SL.UEM.TOTL.ZS", label:"Unemployment (%, ILO)", fmt: v => `${fmtNum(v)}%` },
        { id:"SP.POP.TOTL", label:"Population", fmt: v => fmtNum(v) },
        { id:"IT.NET.USER.ZS", label:"Internet users (% of population)", fmt: v => `${fmtNum(v)}%` },
        { id:"EG.ELC.ACCS.ZS", label:"Access to electricity (% of population)", fmt: v => `${fmtNum(v)}%` },
        { id:"EN.ATM.CO2E.PC", label:"CO₂ emissions (t per capita)", fmt: v => fmtNum(v) }
      ];

      // selection state
      state.compare = state.compare || { indicator: catalog[0].id, yearMax: WB.yearMax, mode:"latest" };

      const sel = state.compare.indicator || catalog[0].id;
      const ind = catalog.find(x => x.id === sel) || catalog[0];

      // UI shell
      el.main.innerHTML = `
        <div class="notice" style="margin-bottom:10px">
          Rankings are computed from one indicator-wide pull and cached locally. If data is missing for a country, it is simply omitted.
        </div>
        <div class="row2" style="margin-bottom:10px">
          <div>
            <label class="small">Indicator</label>
            <select id="cmpIndicator">
              ${catalog.map(x => `<option value="${escapeHtml(x.id)}" ${x.id===ind.id?'selected':''}>${escapeHtml(x.label)}</option>`).join("")}
            </select>
          </div>
          <div>
            <label class="small">Year ceiling</label>
            <select id="cmpYearMax">
              ${[2026,2025,2024,2023,2022,2021,2020].map(y => `<option value="${y}" ${y===state.compare.yearMax?'selected':''}>${y}</option>`).join("")}
            </select>
          </div>
        </div>
        <div id="cmpBody"><div class="loading"><span class="spin"></span><span>Computing…</span></div></div>
      `;

      // bind selects
      const cmpIndicatorEl = document.getElementById("cmpIndicator");
      const cmpYearMaxEl = document.getElementById("cmpYearMax");
      if (cmpIndicatorEl){
        cmpIndicatorEl.addEventListener("change", () => {
          state.compare.indicator = cmpIndicatorEl.value;
          renderActiveView();
        });
      }
      if (cmpYearMaxEl){
        cmpYearMaxEl.addEventListener("change", () => {
          state.compare.yearMax = Number(cmpYearMaxEl.value) || WB.yearMax;
          renderActiveView();
        });
      }

      const body = document.getElementById("cmpBody");
      if (!body) return;

      // compute rankings
      try{
        const rows = await getIndicatorLatestByCountry(ind.id, state.compare.yearMax);
        // Map archive country names/codes to WB iso2 if available, by name matching (silent)
        const activeName = state.active?.name || "";
        const activeCode = state.active?.code || "";

        // convert to list with display name from archive list where possible
        const byIso2 = new Map(rows.map(r => [r.iso2, r]));
        const enriched = [];
        for (const e of state.entities){
          const iso2 = state.wbNameToIso2?.get((e.name||"").toLowerCase()) || null;
          const hit = iso2 ? byIso2.get(iso2) : null;
          if (hit){
            enriched.push({ name: e.name, code: e.code, iso2, year: hit.year, value: hit.value });
          }
        }

        // fallback: include any WB rows not mapped by name as "Other"
        const mappedIso2 = new Set(enriched.map(x=>x.iso2));
        const others = rows.filter(r => !mappedIso2.has(r.iso2)).slice(0, 2000).map(r => ({
          name: r.name, code: "", iso2: r.iso2, year:r.year, value:r.value
        }));

        const all = enriched.concat(others);

        all.sort((a,b)=> (b.value - a.value));

        const activeRow =
          all.find(x => x.code && x.code.toLowerCase()===activeCode.toLowerCase()) ||
          all.find(x => x.name && activeName && x.name.toLowerCase()===activeName.toLowerCase()) ||
          null;

        const rank = activeRow ? (all.indexOf(activeRow)+1) : null;

        const top = all.slice(0, 25);
        const bottom = all.slice(-25);

        const fmtV = v => ind.fmt(v);

        const renderTable = (title, arr, highlightIso2=null) => `
          <div class="notice" style="margin-bottom:10px"><b>${escapeHtml(title)}</b></div>
          <div class="listbox" style="padding:0">
            <div style="display:grid; grid-template-columns: 64px 1.3fr .7fr; gap:0; width:100%">
              <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.55); font-family:var(--mono); font-size:10px; color:var(--muted)">RANK</div>
              <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.55); font-family:var(--mono); font-size:10px; color:var(--muted)">ENTITY</div>
              <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.55); font-family:var(--mono); font-size:10px; color:var(--muted); text-align:right">VALUE</div>
              ${arr.map((x,i)=> {
                const rnk = title.startsWith("Bottom") ? (all.length - arr.length + i + 1) : (i+1);
                const isHi = highlightIso2 && x.iso2===highlightIso2;
                const bg = isHi ? "background: rgba(255,138,0,.08); border-left: 2px solid rgba(255,138,0,.9);" : "";
                const nm = (x.name || "").trim() + (x.code ? ` (${x.code})` : "");
                return `
                  <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.25); font-family:var(--mono); font-size:11px; ${bg}">${rnk}</div>
                  <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.25); font-size:12px; ${bg}">${escapeHtml(nm || x.iso2)}</div>
                  <div style="padding:10px 12px; border-bottom:1px solid rgba(26,50,75,.25); font-family:var(--mono); font-size:11px; text-align:right; ${bg}">${escapeHtml(fmtV(x.value))}<span style="opacity:.7"> (${escapeHtml(String(x.year))})</span></div>
                `;
              }).join("")}
            </div>
          </div>
        `;

        body.innerHTML = `
          <div class="notice" style="margin-bottom:10px">
            <b>${escapeHtml(ind.label)}</b><br/>
            <span style="opacity:.8">Coverage: ${all.length.toLocaleString()} entities • Latest year per entity ≤ ${state.compare.yearMax}</span>
          </div>
          ${renderTable("Top 25", top, activeRow?.iso2 || null)}
          <div style="height:12px"></div>
          ${renderTable("Bottom 25", bottom, activeRow?.iso2 || null)}
        `;

        // side panel
        if (activeRow){
          el.sideMeta.textContent = "Active rank";
          el.side.innerHTML = `
            <div class="notice" style="white-space:pre-wrap">
              Rank: ${rank}/${all.length}
              \nValue: ${fmtV(activeRow.value)} (${activeRow.year})
              \nIndicator: ${escapeHtml(ind.label)}
            </div>
          `;
        } else {
          el.sideMeta.textContent = "—";
          el.side.innerHTML = `<div class="notice">Select a country to highlight its position in rankings.</div>`;
        }

      } catch {
        body.innerHTML = `<div class="notice">Rankings are temporarily unavailable.</div>`;
        el.side.innerHTML = `<div class="notice">No focus available.</div>`;
      }
      return;
    }

    
    if (state.tab === "library"){
      el.mainTitle.textContent = "Library";
      el.mainMeta.textContent = "Archive";
      el.sideTitle.textContent = "Directory";
      el.sideMeta.textContent = "—";
      el.side.innerHTML = `<div class="notice">Use the library to access reference pages and rank-order style listings in the same redesigned layout.</div>`;

      el.main.innerHTML = await renderLibrary();

      // bind group chips and item opens
      el.main.querySelectorAll("[data-libgroup]").forEach(x => {
        x.addEventListener("click", () => {
          state.library.activeGroup = x.getAttribute("data-libgroup") || "Reference";
          renderActiveView();
        });
      });
      el.main.querySelectorAll("[data-libopen]").forEach(x => {
        x.addEventListener("click", () => {
          const href = x.getAttribute("data-libopen");
          const title = x.textContent?.trim() || "Viewer";
          if (!href) return;
          openLibraryItem(href, title);
        });
      });
      // bind section chips within viewer
      el.main.querySelectorAll("[data-libsec]").forEach(x => {
        x.addEventListener("click", () => {
          state.library.openSection = x.getAttribute("data-libsec") || "";
          renderActiveView();
        });
      });

      return;
    }

    if (state.tab === "region"){
      el.mainTitle.textContent = "Region directory";
      el.mainMeta.textContent = "Browse";
      el.main.innerHTML = state.regionHTML || `<div class="notice">No region directory available.</div>`;
      el.sideTitle.textContent = "Active";
      el.sideMeta.textContent = "—";
      el.side.innerHTML = `<div class="notice">Click a region chip to filter, then click an entity to open.</div>`;

      el.main.querySelectorAll("[data-reg]").forEach(x => {
        x.addEventListener("click", () => {
          el.region.value = x.getAttribute("data-reg") || "";
          renderCountries();
          setTab("region");
        });
      });
      el.main.querySelectorAll("[data-open]").forEach(x => {
        x.addEventListener("click", () => {
          const code = x.getAttribute("data-open");
          if (!code) return;
          el.country.value = code;
          selectCountry(code);
          setTab("profile");
        });
      });
      return;
    }
  }

  // ===== selection =====
  async function selectCountry(code){
    const e = state.entities.find(x => x.code === code);
    state.active = e || null;

    if (!state.active){
      el.title.textContent = "Select an entity";
      el.subline.textContent = "Structured fields are extracted and routed into stable topic sections.";
      el.k_code.textContent = "—";
      el.k_region.textContent = "—";
      el.k_depth.textContent = "—";
      el.k_now.textContent = "—";
      state.activeDoc = null;
      state.activeStruct = null;
      state.activeIso = null;
      state.summary = "";
      state.flag = null;
      state.activeSection = "";
      renderSectionDropdown();
      renderActiveView();
      return;
    }

    el.title.textContent = state.active.name;
    el.subline.textContent = `Entity code: ${state.active.code} • Region: ${state.active.regionLabel || "—"}`;
    el.k_code.textContent = state.active.code;
    el.k_region.textContent = state.active.regionLabel || "—";
    el.k_depth.textContent = "…";
    el.k_now.textContent = "—";

    el.mainTitle.textContent = "Profile";
    el.mainMeta.textContent = "Loading…";
    el.main.innerHTML = `<div class="loading"><span class="spin"></span><span>Rendering…</span></div>`;
    el.sideTitle.textContent = "Summary";
    el.sideMeta.textContent = "Loading…";
    el.side.innerHTML = `<div class="loading"><span class="spin"></span><span>Preparing…</span></div>`;

    try{
      const html = await fetchText(state.active.href);
      const doc = new DOMParser().parseFromString(html, "text/html");
      state.activeDoc = doc;

      const struct = buildMaxSections(doc);
      state.activeStruct = struct;

      const iso = extractISOFromDoc(doc);
      state.activeIso = iso;

      if (iso?.a3){
        const cache = getIsoCache();
        cache[state.active.code] = iso.a3;
        setIsoCache(cache);
      }

      state.flag = extractFlagFromDoc(doc, state.active.href);
      state.summary = guessSummary(struct);

      // default section
      const prefer = ["Overview","Introduction","Geography","People and Society","Religion","Government","Economy","All fields"];
      state.activeSection = prefer.find(x => struct.sections.has(x)) || Array.from(struct.sections.keys())[0] || "Overview";

      renderSectionDropdown();

      // KPIs
      const secCount = struct.sections.size;
      const factCount = struct.allFacts.length;
      el.k_depth.textContent = `${secCount} sections • ${factCount.toLocaleString()} fields`;

      await enrichStructWithLatest(struct, iso);

      const snap = await silentSnapshot(iso);
      el.k_now.textContent = snap || "—";

      history.replaceState(null, "", deepLink(state.active.code));
      renderActiveView();
    } catch {
      state.activeDoc = null;
      state.activeStruct = null;
      state.activeIso = null;
      state.summary = "";
      state.flag = null;

      el.k_depth.textContent = "—";
      el.k_now.textContent = "—";
      el.mainMeta.textContent = "—";
      el.sideMeta.textContent = "—";
      el.main.innerHTML = `<div class="notice">This entity could not be rendered at the moment.</div>`;
      el.side.innerHTML = `<div class="notice">No summary available.</div>`;
      renderSectionDropdown();
    }
  }

  // ===== boot =====
  async function boot(){
    el.status.textContent = "loading…";
    el.count.textContent = "0";
    el.country.innerHTML = `<option value="">Select…</option>`;
    el.section.innerHTML = `<option value="">Select…</option>`;

    try{
      const idxHtml = await fetchText(ARCH.index);
      // library front-end (guides/rankorder/flags/maps)
      state.library = parseLibraryFromIndex(idxHtml);

      state.entities = parseEntitiesFromIndex(idxHtml);
      buildRegionIndex();

      el.count.textContent = String(state.entities.length);
      el.status.textContent = "ready";

      renderRegions();
      renderCountries();

      const deep = new URL(location.href).searchParams.get("c");
      if (deep){
        el.country.value = deep.toLowerCase();
        await selectCountry(deep.toLowerCase());
      } else {
        await selectCountry("");
      }
    } catch {
      el.status.textContent = "unavailable";
      el.country.innerHTML = `<option value="">Unavailable</option>`;
      el.section.innerHTML = `<option value="">Unavailable</option>`;
    }
  }

  // ===== events =====
  el.reload.addEventListener("click", boot);

  el.region.addEventListener("change", () => {
    renderCountries();
    el.country.value = "";
    selectCountry("");
  });

  el.q.addEventListener("input", () => renderCountries());

  el.country.addEventListener("change", async () => {
    await selectCountry(el.country.value || "");
  });

  el.section.addEventListener("change", () => {
    const s = el.section.value || "";
    if (!state.activeStruct || !s) return;
    if (!state.activeStruct.sections.has(s)) return;
    state.activeSection = s;
    setTab("profile");
  });

  el.copyLink.addEventListener("click", async () => {
    if (!state.active) return;
    const link = deepLink(state.active.code);
    try{
      await navigator.clipboard.writeText(link);
      el.copyLink.textContent = "copied";
      setTimeout(()=> el.copyLink.textContent = "copy link", 900);
    } catch { alert(link); }
  });

  el.clearCache.addEventListener("click", () => {
    localStorage.removeItem("wib_iso_cache_v1");
    el.clearCache.textContent = "cleared";
    setTimeout(()=> el.clearCache.textContent = "clear cache", 900);
  });

  el.tabs.forEach(t => t.addEventListener("click", () => setTab(t.getAttribute("data-tab"))));

  // start
  boot();
})();
</script>
</body>
</html>
