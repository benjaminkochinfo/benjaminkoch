<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>WIB — World Intelligence Factbook</title>
  <style>
    :root{
      --bg:#070A12;
      --panel:#0B1020;
      --panel2:#0E1630;
      --card:#101B3A;
      --card2:#0D1733;
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --shadow2: 0 10px 26px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:12px;
      --accent:#F59E0B;
      --accent2:#7DD3FC;
      --ok:#22C55E;
      --warn:#FBBF24;
      --bad:#EF4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 18% 12%, rgba(245,158,11,.16), transparent 62%),
        radial-gradient(900px 520px at 75% 18%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(1000px 600px at 40% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, #070A12 0%, #050711 100%);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1440px;margin:0 auto;padding:18px 16px 26px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,27,58,.84), rgba(11,16,32,.84));
      border-radius:var(--radius);box-shadow:var(--shadow2);
      position:sticky;top:12px;z-index:50;backdrop-filter: blur(10px)
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .logo{
      width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:
        radial-gradient(70% 70% at 30% 30%, rgba(245,158,11,.35), transparent 55%),
        radial-gradient(70% 70% at 70% 70%, rgba(125,211,252,.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      font-family:var(--mono);font-weight:800;letter-spacing:.08em;color:var(--text)
    }
    .brand h1{margin:0;font-size:14px;letter-spacing:.08em;text-transform:uppercase;line-height:1.15}
    .brand .sub{margin-top:3px;font-size:12px;color:var(--muted);letter-spacing:.02em}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;flex:1}
    .pill{
      display:flex;align-items:center;gap:8px;border:1px solid var(--line);
      background: rgba(11,16,32,.62);border-radius:999px;padding:9px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25)
    }
    .pill .k{font-size:12px;color:var(--muted2);letter-spacing:.02em}
    .pill input,.pill select{background:transparent;border:none;outline:none;color:var(--text);font-size:13px;min-width:180px;font-family:var(--sans)}
    .pill select{min-width:220px}
    .pill input::placeholder{color: rgba(234,240,255,.45)}
    .btn{
      border:1px solid rgba(245,158,11,.34);background: rgba(245,158,11,.12);color:var(--text);
      border-radius:999px;padding:10px 12px;font-size:13px;cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:flex;align-items:center;gap:8px;user-select:none;white-space:nowrap
    }
    .btn:hover{background: rgba(245,158,11,.18);border-color: rgba(245,158,11,.48)}
    .btn:active{transform: translateY(1px)}
    .btn.secondary{border-color: rgba(125,211,252,.30);background: rgba(125,211,252,.10)}
    .btn.secondary:hover{border-color: rgba(125,211,252,.45);background: rgba(125,211,252,.14)}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}
    @media (max-width:1100px){
      .layout{grid-template-columns:1fr}
      .brand{min-width:unset}
      .controls{justify-content:stretch}
      .pill{flex:1}
      .pill input,.pill select{width:100%}
    }
    .panel{border:1px solid var(--line);background: rgba(11,16,32,.68);border-radius:var(--radius);box-shadow:var(--shadow2);overflow:hidden}
    .panel .ph{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;background: linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
    .panel .ph .title{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:rgba(234,240,255,.82)}
    .panel .ph .meta{font-size:12px;color:var(--muted2);font-family:var(--mono);white-space:nowrap}
    .panel .pb{padding:12px 14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}
    .chiprow{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);background: rgba(16,27,58,.44);padding:7px 10px;border-radius:999px;font-size:12px;color:var(--muted);cursor:pointer;user-select:none;transition: background .15s ease, border-color .15s ease}
    .chip:hover{background: rgba(16,27,58,.58);border-color: var(--line2)}
    .chip.active{border-color: rgba(245,158,11,.55);background: rgba(245,158,11,.12);color: rgba(234,240,255,.92)}
    .rows{max-height:58vh;overflow:auto;padding-right:4px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border:1px solid var(--line);border-radius:14px;background: rgba(16,27,58,.32);cursor:pointer;margin-bottom:8px;transition: border-color .15s ease, background .15s ease, transform .06s ease}
    .row:hover{border-color: var(--line2);background: rgba(16,27,58,.42)}
    .row:active{transform: translateY(1px)}
    .row.active{border-color: rgba(245,158,11,.55);background: rgba(245,158,11,.10)}
    .row .name{font-size:13px;font-weight:650}
    .row .meta{font-size:11px;color:var(--muted2);font-family:var(--mono);display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .tag{border:1px solid var(--line);padding:2px 7px;border-radius:999px;background: rgba(11,16,32,.55)}
    .tag.accent{border-color: rgba(245,158,11,.35);background: rgba(245,158,11,.10)}
    .main{padding:0;min-height:70vh}
    .hero{padding:14px 14px 12px;border-bottom:1px solid var(--line);display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start;background: radial-gradient(800px 240px at 15% 0%, rgba(245,158,11,.12), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
    .media{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;flex:1;min-width:280px}
    .flag{width:110px;height:74px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background: rgba(255,255,255,.03);overflow:hidden;display:grid;place-items:center;box-shadow: 0 14px 32px rgba(0,0,0,.40)}
    .flag img{width:100%;height:100%;object-fit:cover}
    .hero h2{margin:0;font-size:18px;letter-spacing:.02em}
    .hero .subline{margin-top:4px;color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hero .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-left:auto}
    .content{padding:12px 14px 18px}
    .notice{padding:12px 12px;border:1px dashed rgba(255,255,255,.18);border-radius:14px;color:var(--muted);background: rgba(11,16,32,.35);margin-bottom:12px;font-size:13px;line-height:1.45}
    .card{border:1px solid var(--line);border-radius:var(--radius);background: rgba(16,27,58,.30);box-shadow:var(--shadow2);overflow:hidden;margin-bottom:12px}
    .card .ch{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;background: linear-gradient(180deg, rgba(255,255,255,.05), transparent)}
    .card .ch b{font-size:13px}
    .card .ch span{font-size:12px;color:var(--muted2);font-family:var(--mono)}
    .card .cb{padding:10px 12px}
    .kv{display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .kv:last-child{border-bottom:none}
    @media (max-width:820px){.kv{grid-template-columns:1fr}}
    .kv .k{color:rgba(234,240,255,.86);font-size:12px;letter-spacing:.02em;font-weight:650}
    .kv .v{color:var(--muted);font-size:13px;line-height:1.55;white-space:pre-wrap}
    .accordion{border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;margin-bottom:12px;background: rgba(16,27,58,.24)}
    .acc-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 12px;cursor:pointer;user-select:none;border-bottom:1px solid var(--line);background: linear-gradient(180deg, rgba(255,255,255,.04), transparent)}
    .acc-head:hover{background: linear-gradient(180deg, rgba(255,255,255,.06), transparent)}
    .acc-head .t{font-size:13px;font-weight:750;letter-spacing:.02em}
    .acc-head .m{font-size:12px;color:var(--muted2);font-family:var(--mono);white-space:nowrap}
    .acc-body{display:none;padding:10px 12px 14px}
    .accordion.open .acc-body{display:block}
    .field{border:1px solid rgba(255,255,255,.10);border-radius:14px;background: rgba(11,16,32,.35);margin-top:10px;overflow:hidden}
    .field .fh{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;user-select:none}
    .field .fh:hover{background: rgba(255,255,255,.03)}
    .field .fh .fn{font-size:12px;font-weight:750;letter-spacing:.02em}
    .field .fh .fd{font-size:11px;color:var(--muted2);font-family:var(--mono)}
    .field .fb{display:none;padding:10px 10px 12px;color:var(--muted);line-height:1.55;font-size:13px}
    .field.open .fb{display:block}
    .field .fb p{margin:.35em 0}
    .field .fb ul{margin:.35em 0 .35em 1.1em}
    .field .fb table{width:100%;border-collapse:collapse;margin:.4em 0}
    .field .fb td,.field .fb th{border:1px solid rgba(255,255,255,.10);padding:6px 8px;font-size:12px;color:var(--muted);vertical-align:top}
    .field .fb .subfield-number{font-family:var(--mono);font-weight:800;color:rgba(234,240,255,.92)}
    .field .fb .subfield-date{color:var(--muted2);font-family:var(--mono);font-size:11px}
    .field .fb .subfield-name{color:rgba(234,240,255,.86);font-weight:700}
    .foot{margin-top:14px;color:rgba(234,240,255,.55);font-size:12px;text-align:center}
    .kbd{font-family:var(--mono);font-size:11px;padding:1px 6px;border:1px solid rgba(255,255,255,.14);border-bottom-color: rgba(255,255,255,.22);border-radius:8px;background: rgba(0,0,0,.25);color:rgba(234,240,255,.88);display:inline-block;transform: translateY(-1px)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">WIB</div>
        <div>
          <h1>World Intelligence Factbook</h1>
          <div class="sub">Fast retrieval • structured country profiles • offline-first</div>
        </div>
      </div>

      <div class="controls">
        <div class="pill" title="Search country list">
          <span class="k">SEARCH</span>
          <input id="q" placeholder="Type a country, code, or keyword…" autocomplete="off" />
        </div>

        <div class="pill" title="Country selector">
          <span class="k">COUNTRY</span>
          <select id="countrySelect" aria-label="Select a country">
            <option value="">Loading…</option>
          </select>
        </div>

        <button class="btn secondary" id="lensBtn" title="Scenario lens">
          <span style="font-family:var(--mono); font-weight:800">LENS</span>
          <span id="lensLabel" style="opacity:.9">Baseline</span>
        </button>

        <button class="btn" id="homeBtn" title="Go to start">
          <span style="font-family:var(--mono); font-weight:800">WIB</span>
          <span>Home</span>
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="ph">
          <div class="title">Navigator</div>
          <div class="meta"><span id="countMeta">—</span></div>
        </div>
        <div class="pb">
          <div class="grid2">
            <div class="pill" style="border-radius:14px; padding:10px 12px" title="Filter by region (learned as you open countries)">
              <span class="k">REGION</span>
              <select id="regionSelect" aria-label="Filter by region">
                <option value="">All regions</option>
                <option value="__unknown__">Unclassified (not opened yet)</option>
              </select>
            </div>
            <div class="pill" style="border-radius:14px; padding:10px 12px" title="Jump to section inside the selected country">
              <span class="k">SECTION</span>
              <select id="sectionSelect" aria-label="Select section">
                <option value="">—</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="chiprow" id="lensChips" aria-label="Scenario lenses">
            <div class="chip active" data-lens="baseline">Baseline</div>
            <div class="chip" data-lens="travel">Travel</div>
            <div class="chip" data-lens="macro">Macro</div>
            <div class="chip" data-lens="security">Security</div>
            <div class="chip" data-lens="infrastructure">Infrastructure</div>
          </div>

          <div style="height:12px"></div>

          <div class="rows" id="list"></div>
          <div class="foot">
            Tip: press <span class="kbd">/</span> to focus search • <span class="kbd">Esc</span> clears filters
          </div>
        </div>
      </div>

      <div class="panel main">
        <div class="hero" id="hero">
          <div class="media">
            <div class="flag" id="flagBox"><div style="font-family:var(--mono); color:var(--muted2); font-size:12px">—</div></div>
            <div>
              <h2 id="title">World Intelligence Factbook</h2>
              <div class="subline">
                <span id="subtitle">Select a country to load a full profile with structured sections.</span>
              </div>
              <div class="subline" style="margin-top:8px">
                <span class="tag" id="codeTag">—</span>
                <span class="tag" id="regionTag">—</span>
                <span class="tag" id="updatedTag">—</span>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn secondary" id="summaryBtn" disabled title="Open one-page summary">One‑page summary</button>
            <button class="btn secondary" id="travelBtn" disabled title="Open travel facts">Travel facts</button>
            <button class="btn secondary" id="mapBtn" disabled title="Open map">Map</button>
          </div>
        </div>

        <div class="content" id="main">
          <div class="notice">
            This interface is built for rapid, high-fidelity retrieval: search → select → navigate by section and field.
            The country profile is rendered from the locally hosted dataset under <span class="kbd">wifb/</span>.
          </div>

          <div class="card">
            <div class="ch"><b>Start</b><span>how to use</span></div>
            <div class="cb">
              <div class="kv"><div class="k">Country selection</div><div class="v">Use the COUNTRY dropdown (top) or the left list. The list supports instant search.</div></div>
              <div class="kv"><div class="k">Sections</div><div class="v">After loading a profile, choose a SECTION dropdown or scroll the accordions below.</div></div>
              <div class="kv"><div class="k">Scenario lens</div><div class="v">The LENS chips pre-open a disciplined subset of sections for the use‑case; it never alters the underlying facts.</div></div>
            </div>
          </div>

          <div id="profile"></div>
        </div>
      </div>
    </div>

    <div class="foot" style="margin-top:14px">
      WIB — World Intelligence Factbook • designed for responsiveness and structured browsing.
    </div>
  </div>

<script>
(() => {
  const CONFIG = {
    base: "./wifb",
    index: "./wifb/wifbindex.html",
    geosDir: "./wifb/geos",
    enrich: { enabled: true, wikipediaSummary: true }
  };

  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const qEl = $("#q");
  const listEl = $("#list");
  const countrySelect = $("#countrySelect");
  const regionSelect = $("#regionSelect");
  const sectionSelect = $("#sectionSelect");
  const countMeta = $("#countMeta");

  const titleEl = $("#title");
  const subtitleEl = $("#subtitle");
  const flagBox = $("#flagBox");
  const codeTag = $("#codeTag");
  const regionTag = $("#regionTag");
  const updatedTag = $("#updatedTag");

  const summaryBtn = $("#summaryBtn");
  const travelBtn = $("#travelBtn");
  const mapBtn = $("#mapBtn");

  const lensBtn = $("#lensBtn");
  const lensLabel = $("#lensLabel");
  const lensChips = $("#lensChips");
  const homeBtn = $("#homeBtn");

  const profileEl = $("#profile");

  let CATALOG = [];
  let REGION_BY_CODE = {};
  let ACTIVE = null;
  let ACTIVE_SECTIONS = [];
  let ACTIVE_LENS = "baseline";

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#39;");
  }

  function normalizePath(url){
    if (!url) return url;
    const u = String(url);
    if (/^(https?:|data:|blob:|mailto:|tel:)/i.test(u)) return u;
    if (u.startsWith("../")) return CONFIG.base + "/" + u.slice(3);
    if (u.startsWith("./")) return CONFIG.base + "/" + u.slice(2);
    if (u.startsWith("geos/")) return CONFIG.base + "/" + u;
    if (u.startsWith("attachments/") || u.startsWith("docs/") || u.startsWith("fields/") || u.startsWith("images/") || u.startsWith("stylesheets/") || u.startsWith("javascripts/") || u.startsWith("appendix/")) {
      return CONFIG.base + "/" + u;
    }
    return CONFIG.base + "/" + u.replace(/^\/+/, "");
  }

  async function safeText(url){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      return await r.text();
    }catch(e){ return null; }
  }
  async function safeJson(url){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      return await r.json();
    }catch(e){ return null; }
  }
  async function openAssetAsBlob(url){
    try{
      const r = await fetch(url, {cache:"force-cache"});
      if(!r.ok) throw new Error(r.status);
      const blob = await r.blob();
      const o = URL.createObjectURL(blob);
      window.open(o, "_blank", "noopener");
      setTimeout(()=>URL.revokeObjectURL(o), 60_000);
    }catch(e){}
  }
  function textFromNode(node){
    if(!node) return "";
    return (node.textContent || "").replace(/\s+/g," ").trim();
  }
  function parseRegionAndCountry(doc){
    const t = $("#geos_title", doc);
    if(!t) return {region:"", country:""};
    const country = textFromNode($(".countryName", t));
    const raw = (t.childNodes?.[0]?.textContent || "").trim();
    const region = raw.replace(/[:\s]+$/g,"").trim();
    return {region, country};
  }
  function parseLastUpdated(doc){
    const lm = $(".lastMod", doc);
    if (lm) return textFromNode(lm).replace(/^Page\s+last\s+updated\s+on\s+/i,"").trim();
    const meta = doc.querySelector('meta[name="LastModified"]');
    return meta?.getAttribute("content") || "";
  }
  function parseFlag(doc){
    const img = doc.querySelector(".flagBox img");
    if(!img) return null;
    return {src: normalizePath(img.getAttribute("src")), alt: img.getAttribute("alt") || ""};
  }
  function parseAttachments(codeUpper){
    return {
      travel: normalizePath(`attachments/travel/${codeUpper}-travel-facts.pdf`),
      summary: normalizePath(`attachments/summaries/${codeUpper}-summary.pdf`),
      map: normalizePath(`attachments/maps/${codeUpper}-map.jpg`)
    };
  }
  function rewriteLinksInElement(root){
    $$('a[href]', root).forEach(a => a.setAttribute('href', normalizePath(a.getAttribute('href'))));
    $$('[src]', root).forEach(x => x.setAttribute('src', normalizePath(x.getAttribute('src'))));
  }

  function extractSections(doc){
    const out = [];
    const anchors = $$("ul.expandcollapse > li[id$='-category-section-anchor']", doc);
    anchors.forEach(anchorLi => {
      const q = $(".question", anchorLi);
      const sectionTitle = q?.getAttribute("sectiontitle") || textFromNode(q).split("::")[0].trim() || "Section";
      const baseId = anchorLi.id.replace(/-anchor$/,"");
      const contentLi = doc.getElementById(baseId);
      if(!contentLi) return;

      const fields = [];
      const cats = $$("div.category[id^='field-anchor-']", contentLi);
      cats.forEach(cat => {
        const labelA = cat.querySelector(".btn-tooltip a");
        const label = textFromNode(labelA) || textFromNode(cat).replace(/:\s*$/,"");
        const fieldAnchorId = cat.id;

        let dataDiv = cat.nextElementSibling;
        while (dataDiv && !(dataDiv.id && dataDiv.id.startsWith("field-"))) dataDiv = dataDiv.nextElementSibling;
        if(!dataDiv) return;

        const clone = dataDiv.cloneNode(true);
        Array.from(clone.querySelectorAll('script')).forEach(s=>s.remove());
        rewriteLinksInElement(clone);
        const html = clone.innerHTML.trim();
        const dt = clone.querySelector('.subfield-date') ? textFromNode(clone.querySelector('.subfield-date')) : "";

        fields.push({label, anchor: fieldAnchorId, date: dt, html});
      });

      out.push({id: baseId, title: sectionTitle, fields});
    });
    return out;
  }

  function buildSectionSelect(sections){
    sectionSelect.innerHTML = `<option value="">All sections</option>` + sections.map(s => `<option value="${escapeHtml(s.id)}">${escapeHtml(s.title)}</option>`).join("");
  }

  function renderProfile(sections, opts={}){
    const openSectionId = opts.openSectionId || null;
    if (!sections || !sections.length){
      profileEl.innerHTML = `<div class="notice">No structured sections detected for this entity.</div>`;
      return;
    }

    const lensPlan = {
      baseline: [],
      travel: [/Introduction/i, /Geography/i, /People and Society/i, /Government/i],
      macro: [/Economy/i, /Energy/i, /Communications/i, /Transportation/i],
      security: [/Military and Security/i, /Transnational Issues/i, /Government/i],
      infrastructure: [/Communications/i, /Transportation/i, /Energy/i, /Government/i]
    };

    const shouldOpenByLens = (title) => {
      const patterns = lensPlan[ACTIVE_LENS] || [];
      if (!patterns.length) return false;
      return patterns.some(rx => rx.test(title));
    };

    const chosen = openSectionId ? sections.filter(s => s.id === openSectionId) : sections;

    profileEl.innerHTML = chosen.map(sec => {
      const open = openSectionId ? true : shouldOpenByLens(sec.title);
      const fieldCount = sec.fields?.length || 0;

      const fieldsHtml = (sec.fields || []).map(f => `
        <div class="field" data-field="${escapeHtml(f.anchor)}">
          <div class="fh" role="button" tabindex="0" aria-expanded="false">
            <div class="fn">${escapeHtml(f.label)}</div>
            <div class="fd">${escapeHtml(f.date || "")}</div>
          </div>
          <div class="fb">${f.html}</div>
        </div>
      `).join("");

      return `
        <div class="accordion ${open ? "open" : ""}" data-section="${escapeHtml(sec.id)}">
          <div class="acc-head" role="button" tabindex="0" aria-expanded="${open ? "true" : "false"}">
            <div class="t">${escapeHtml(sec.title)}</div>
            <div class="m">${fieldCount} fields</div>
          </div>
          <div class="acc-body">
            ${fieldsHtml || `<div class="notice">No fields available in this section.</div>`}
          </div>
        </div>
      `;
    }).join("");

    $$(".accordion .acc-head", profileEl).forEach(h => {
      h.addEventListener("click", () => {
        const acc = h.closest(".accordion");
        const open = acc.classList.toggle("open");
        h.setAttribute("aria-expanded", open ? "true" : "false");
      });
      h.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); h.click(); }
      });
    });

    $$(".field .fh", profileEl).forEach(h => {
      h.addEventListener("click", () => {
        const f = h.closest(".field");
        const open = f.classList.toggle("open");
        h.setAttribute("aria-expanded", open ? "true" : "false");
      });
      h.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); h.click(); }
      });
    });
  }

  function setHero({code, name, region, updated, flagSrc}){
    titleEl.textContent = name || "World Intelligence Factbook";
    subtitleEl.textContent = region || "—";
    codeTag.textContent = code ? code.toUpperCase() : "—";
    regionTag.textContent = region || "—";
    updatedTag.textContent = updated ? `Updated: ${updated}` : "—";
    flagBox.innerHTML = flagSrc
      ? `<img src="${escapeHtml(flagSrc)}" alt="${escapeHtml(name||"")}" loading="lazy" />`
      : `<div style="font-family:var(--mono); color:rgba(234,240,255,.55); font-size:12px">—</div>`;
  }

  function buildRegionFilter(){
    const regions = Array.from(new Set(Object.values(REGION_BY_CODE).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const current = regionSelect.value;
    regionSelect.innerHTML = `
      <option value="">All regions</option>
      <option value="__unknown__">Unclassified (not opened yet)</option>
      ${regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join("")}
    `;
    if ([...regionSelect.options].some(o => o.value === current)) regionSelect.value = current;
  }

  function renderCountryList(){
    const q = (qEl.value || "").trim().toLowerCase();
    const reg = regionSelect.value;

    const rows = CATALOG.filter(x => {
      if (reg){
        const r = REGION_BY_CODE[x.code] || "__unknown__";
        if (reg === "__unknown__") return !REGION_BY_CODE[x.code];
        if (r !== reg) return false;
      }
      if (!q) return true;
      return (x.name || "").toLowerCase().includes(q) || (x.code || "").toLowerCase().includes(q);
    });

    countMeta.textContent = `${rows.length} / ${CATALOG.length}`;

    listEl.innerHTML = rows.slice(0, 900).map(x => {
      const active = (ACTIVE?.code === x.code) ? "active" : "";
      const nm = x.name || x.code.toUpperCase();
      const r = REGION_BY_CODE[x.code] || "Unclassified";
      return `
        <div class="row ${active}" data-code="${escapeHtml(x.code)}">
          <div>
            <div class="name">${escapeHtml(nm)}</div>
            <div class="meta">
              <span class="tag">${escapeHtml(x.code.toUpperCase())}</span>
              <span class="tag">${escapeHtml(r)}</span>
            </div>
          </div>
          <div class="meta"><span class="tag accent">OPEN</span></div>
        </div>
      `;
    }).join("");

    $$(".row", listEl).forEach(el => {
      el.addEventListener("click", () => selectCountry(el.getAttribute("data-code"), {scroll:false}));
    });

    if (rows.length === 0){
      listEl.innerHTML = `<div class="notice">No matches. Try a broader query or clear the region filter.</div>`;
    }
  }

  function fillCountrySelect(){
    countrySelect.innerHTML = `<option value="">Select…</option>` +
      CATALOG.map(x => `<option value="${escapeHtml(x.code)}">${escapeHtml(x.name)} (${escapeHtml(x.code.toUpperCase())})</option>`).join("");
  }

  function setButtonsForCountry(code){
    const up = (code || "").toUpperCase();
    if (!up){
      summaryBtn.disabled = true; travelBtn.disabled = true; mapBtn.disabled = true;
      return;
    }
    const {summary, travel, map} = parseAttachments(up);
    summaryBtn.disabled = false;
    travelBtn.disabled = false;
    mapBtn.disabled = false;
    summaryBtn.onclick = () => openAssetAsBlob(summary);
    travelBtn.onclick = () => openAssetAsBlob(travel);
    mapBtn.onclick = () => openAssetAsBlob(map);
  }

  async function silentWikipediaSummary(countryName){
    try{
      if(!countryName) return null;
      const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(countryName)}`;
      const j = await safeJson(url);
      const txt = j?.extract;
      if(!txt) return null;
      return txt.length > 420 ? txt.slice(0, 420).trim() + "…" : txt.trim();
    }catch(e){ return null; }
  }

  async function selectCountry(code, opts={}){
    if (!code) return;
    const item = CATALOG.find(x => x.code === code);
    if (!item) return;
    ACTIVE = {code: item.code, name: item.name};

    countrySelect.value = item.code;
    renderCountryList();
    setHero({code:item.code, name:item.name, region: REGION_BY_CODE[item.code] || "", updated:"", flagSrc:null});
    setButtonsForCountry(item.code);
    sectionSelect.innerHTML = `<option value="">Loading…</option>`;

    const url = `${CONFIG.geosDir}/${item.code}.html`;
    const html = await safeText(url);
    if (!html){
      profileEl.innerHTML = `<div class="notice">Profile unavailable (missing file). Check that <span class="kbd">${escapeHtml(url)}</span> exists on your host.</div>`;
      return;
    }

    const doc = new DOMParser().parseFromString(html, "text/html");
    const {region, country} = parseRegionAndCountry(doc);
    const updated = parseLastUpdated(doc);
    const flag = parseFlag(doc);

    if (region) REGION_BY_CODE[item.code] = region;
    buildRegionFilter();

    const sections = extractSections(doc);
    ACTIVE_SECTIONS = sections;

    buildSectionSelect(sections);
    sectionSelect.value = "";

    setHero({
      code: item.code,
      name: country || item.name,
      region: region || REGION_BY_CODE[item.code] || "",
      updated,
      flagSrc: flag?.src || null
    });

    renderProfile(sections);

    if (CONFIG.enrich.enabled && CONFIG.enrich.wikipediaSummary){
      silentWikipediaSummary(country || item.name).then(sum => {
        if (!sum) return;
        if ($("#wikipediaCard")) return;
        const card = document.createElement("div");
        card.className = "card";
        card.id = "wikipediaCard";
        card.innerHTML = `<div class="ch"><b>Snapshot</b><span>public summary</span></div><div class="cb"><div class="notice" style="margin:0">${escapeHtml(sum)}</div></div>`;
        profileEl.prepend(card);
      });
    }

    if (opts.scroll !== false){
      window.scrollTo({top:0, behavior:"smooth"});
    }

    history.replaceState(null, "", "#" + item.code);
  }

  function setLens(lens){
    ACTIVE_LENS = lens;
    $$(".chip", lensChips).forEach(c => c.classList.toggle("active", c.getAttribute("data-lens") === lens));
    lensLabel.textContent = ({baseline:"Baseline",travel:"Travel",macro:"Macro",security:"Security",infrastructure:"Infrastructure"})[lens] || "Baseline";
    if (ACTIVE_SECTIONS && ACTIVE_SECTIONS.length){
      renderProfile(ACTIVE_SECTIONS, {openSectionId: sectionSelect.value || null});
    }
  }

  async function init(){
    const html = await safeText(CONFIG.index);
    if (!html){
      countrySelect.innerHTML = `<option value="">Missing index</option>`;
      listEl.innerHTML = `<div class="notice">Could not load <span class="kbd">${escapeHtml(CONFIG.index)}</span>. Ensure the file exists and the path is correct.</div>`;
      return;
    }
    const doc = new DOMParser().parseFromString(html, "text/html");
    const opts = $$("#search-place option", doc);

    const rows = [];
    for (const o of opts){
      const val = (o.getAttribute("value") || "").trim();
      const name = textFromNode(o);
      const m = val.match(/geos\\/([a-z0-9]{2})\\.html/i);
      if (!m) continue;
      rows.push({code: m[1].toLowerCase(), name, href: val});
    }

    const by = new Map();
    rows.forEach(r => { if(!by.has(r.code)) by.set(r.code, r); });
    CATALOG = Array.from(by.values()).filter(r => r.code && r.name).sort((a,b) => (a.name || "").localeCompare(b.name || ""));

    fillCountrySelect();
    renderCountryList();
    countMeta.textContent = `${CATALOG.length}`;

    qEl.addEventListener("input", renderCountryList);
    regionSelect.addEventListener("change", renderCountryList);

    countrySelect.addEventListener("change", () => {
      const code = countrySelect.value;
      if (code) selectCountry(code);
    });

    sectionSelect.addEventListener("change", () => {
      if (!ACTIVE_SECTIONS.length) return;
      renderProfile(ACTIVE_SECTIONS, {openSectionId: sectionSelect.value || null});
      if (sectionSelect.value){
        const el = profileEl.querySelector(`[data-section="${CSS.escape(sectionSelect.value)}"]`);
        if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
      }
    });

    $$(".chip", lensChips).forEach(ch => ch.addEventListener("click", () => setLens(ch.getAttribute("data-lens"))));

    lensBtn.addEventListener("click", () => {
      const order = ["baseline","travel","macro","security","infrastructure"];
      const i = order.indexOf(ACTIVE_LENS);
      setLens(order[(i+1) % order.length]);
    });

    homeBtn.addEventListener("click", () => {
      history.replaceState(null, "", "#");
      ACTIVE = null;
      ACTIVE_SECTIONS = [];
      countrySelect.value = "";
      sectionSelect.innerHTML = `<option value="">—</option>`;
      setButtonsForCountry("");
      setHero({code:"", name:"World Intelligence Factbook", region:"", updated:"", flagSrc:null});
      profileEl.innerHTML = "";
      window.scrollTo({top:0, behavior:"smooth"});
      renderCountryList();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement !== qEl){
        e.preventDefault();
        qEl.focus();
      }
      if (e.key === "Escape"){
        qEl.value = "";
        regionSelect.value = "";
        renderCountryList();
      }
    });

    const hash = (location.hash || "").replace("#","").trim().toLowerCase();
    if (hash && CATALOG.some(x => x.code === hash)){
      selectCountry(hash);
    }
  }

  init();
})();
</script>
</body>
</html>
