<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BK Macro · Indicator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
        content="Macro indicator dashboard with BK indices (KMRI, TPVI, GDFI, RSAC) and a ForumFlow-WSB crowd-flow strip.">
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <style>
    :root {
      --bg-dark: #020617;
      --bg-soft: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.25);
      --accent-2: #a855f7;
      --text-muted: #9ca3af;
      --border-soft: rgba(148,163,184,0.4);
      --radius-xl: 1.4rem;
    }

    * { scroll-behavior: smooth; }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #0f172a 0, #020617 40%, #000 75%, #020617 100%);
      color: #e5e7eb;
    }
    body.bk-fullscreen-open { overflow: hidden; }

    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #0ea5e9; }

    .navbar {
      background: linear-gradient(to right, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-bottom: 1px solid rgba(148,163,184,0.45);
      backdrop-filter: blur(16px);
    }

    .navbar-brand {
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: .8rem;
    }

    .nav-link { font-size: .85rem; }

    main { padding-top: 4.5rem; }

    .hero {
      padding: 2.75rem 0 2rem;
    }

    .hero-badge {
      font-size: .75rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), rgba(15,23,42,0.96));
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding-right: .75rem;
    }

    .hero-title {
      font-weight: 700;
      font-size: clamp(2.1rem, 3vw + 1rem, 3.1rem);
      letter-spacing: -.03em;
      margin-bottom: .5rem;
    }

    .hero-sub {
      color: var(--text-muted);
      max-width: 40rem;
      font-size: .95rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .35rem .8rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      font-size: .78rem;
      background: rgba(15,23,42,0.98);
      color: #e5e7eb;
    }

    .pill i { font-size: .9rem; color: var(--accent); }

    .section-label {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--text-muted);
      margin-bottom: .4rem;
    }

    .card-soft {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.04), rgba(15,23,42,0.98));
      border-radius: 1.2rem;
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow: 0 20px 60px rgba(0,0,0,0.85);
    }

    .card-soft .card-body { padding: 1.25rem 1.4rem; }

    .terminal-shell {
      position: relative;
      border-radius: .9rem;
      background: #020617;
      border: 1px solid rgba(15,23,42,0.95);
      box-shadow:
        inset 0 0 0 1px rgba(15,23,42,0.95),
        0 22px 60px rgba(0,0,0,0.95);
      overflow: hidden;
    }

    .terminal-shell.fullscreen {
      position: fixed;
      inset: 0;
      margin: 0;
      border-radius: 0;
      z-index: 2000;
      box-shadow: none;
      max-width: none;
    }

    .fullscreen-btn {
      position: absolute;
      top: 5px;
      right: 7px;
      z-index: 30;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.96);
      color: rgba(209,213,219,0.95);
      border-radius: 3px;
      padding: 2px 6px;
      font-size: .7rem;
      cursor: pointer;
    }
    .fullscreen-btn i { font-size: .8rem; }
    .terminal-shell.fullscreen .fullscreen-btn {
      background: #0f172a;
    }

    .terminal-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .4rem .7rem;
      background: linear-gradient(to right, #111827, #020617);
      border-bottom: 1px solid rgba(31,41,55,0.9);
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(209,213,219,0.96);
      white-space: nowrap;
    }

    .terminal-top-title { overflow: hidden; text-overflow: ellipsis; }
    .terminal-top-meta  { opacity: .9; }

    .terminal-fkeys {
      background: #020617;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding: .15rem .7rem .22rem;
      font-size: .6rem;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: rgba(156,163,175,0.9);
      display: flex;
      gap: .55rem;
    }

    .terminal-toolbar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .3rem;
      padding: .3rem .7rem .35rem;
      background: #020617;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      font-size: .65rem;
    }

    .toolbar-label {
      text-transform: uppercase;
      letter-spacing: .16em;
      color: rgba(148,163,184,0.9);
      margin-right: .2rem;
    }

    .toolbar-btn {
      border: 1px solid rgba(55,65,81,0.9);
      background: #020617;
      color: rgba(148,163,184,0.9);
      padding: .14rem .38rem;
      border-radius: 2px;
      font-size: .63rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      cursor: default;
    }

    .toolbar-btn.active-range {
      background: #f97316;
      border-color: #f97316;
      color: #020617;
      font-weight: 600;
    }

    .terminal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .25rem .7rem .3rem;
      background: #020617;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      font-size: .63rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(156,163,175,0.9);
    }

    .terminal-actions-left {
      display: flex;
      flex-wrap: wrap;
      gap: .3rem;
    }

    .terminal-action {
      border: 1px solid rgba(55,65,81,0.9);
      padding: .12rem .4rem;
      border-radius: 2px;
      background: #020617;
      color: rgba(209,213,219,0.9);
      cursor: pointer;
    }

    .terminal-action-icon {
      border: 1px solid rgba(55,65,81,0.9);
      padding: .1rem .25rem;
      border-radius: 2px;
      background: #020617;
      color: rgba(209,213,219,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
    }

    .terminal-body {
      position: relative;
      padding: .4rem .45rem .25rem;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #022c3a 100%);
    }

    .terminal-legend {
      position: absolute;
      top: .55rem;
      left: .55rem;
      padding: .3rem .48rem .34rem;
      background: rgba(15,23,42,0.94);
      border-radius: .3rem;
      border: 1px solid rgba(75,85,99,0.9);
      font-size: .66rem;
      color: rgba(209,213,219,0.96);
      z-index: 5;
      min-width: 160px;
    }

    .terminal-legend-title {
      text-transform: uppercase;
      letter-spacing: .14em;
      font-size: .6rem;
      margin-bottom: .16rem;
      color: rgba(156,163,175,0.95);
    }

    .legend-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .35rem;
      margin-bottom: .03rem;
    }

    .legend-left {
      display: flex;
      align-items: center;
      gap: .25rem;
    }

    .legend-color {
      width: 10px;
      height: 2px;
      border-radius: 999px;
    }

    .legend-val { font-variant-numeric: tabular-nums; }

    .terminal-chart {
      position: relative;
      height: 250px;
    }

    .terminal-shell.fullscreen .terminal-chart {
      height: calc(100vh - 135px) !important;
    }

    .terminal-chart canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .terminal-status {
      padding: .25rem .7rem .32rem;
      border-top: 1px solid rgba(31,41,55,0.9);
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(148,163,184,0.9);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.35);
      margin-right: .35rem;
      display: inline-block;
    }

    .status-label { opacity: .8; }
    .status-value { color: #e5e7eb; }

    .indicator-chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .3rem .7rem;
      border-radius: .75rem;
      border: 1px solid rgba(148,163,184,0.6);
      font-size: .72rem;
      background: rgba(15,23,42,0.98);
      color: var(--text-muted);
    }

    .indicator-chip i { color: var(--accent-2); }

    footer {
      border-top: 1px solid rgba(55,65,81,0.8);
      font-size: .8rem;
      color: var(--text-muted);
      padding: 1.3rem 0 1.5rem;
      background: rgba(3,7,18,0.97);
      margin-top: 2rem;
    }

    .chart-grid .chart-block {
      cursor: move;
      transition: opacity .15s ease;
    }
    .chart-grid .chart-block.dragging {
      opacity: .45;
    }

    @media (max-width: 991.98px) {
      .hero { padding-top: 2.3rem; }
    }

    @media (max-width: 575.98px) {
      .terminal-top-meta { display:none; }
      .terminal-fkeys { font-size: .54rem; }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#top">BK Macro · Indicator Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#dash">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#forumflow">ForumFlow-WSB</a></li>
        <li class="nav-item"><a class="nav-link" href="#indicators">Indicators</a></li>
        <li class="nav-item"><a class="nav-link" href="#extras">Multi-view</a></li>
        <li class="nav-item"><a class="nav-link" href="https://benjaminkoch.info/">Main site</a></li>
      </ul>
    </div>
  </div>
</nav>

<main id="top">
  <section id="dash" class="hero">
    <div class="container">
      <div class="row g-4 align-items-center">
        <div class="col-lg-7">
          <div class="hero-badge px-3 py-2 mb-3">
            <span>Research dashboard · projected indicators</span>
            <span style="width:4px;height:4px;border-radius:999px;background:#22c55e;"></span>
          </div>
          <h1 class="hero-title">Macro indicator dashboard with crowd-flow signal</h1>
          <p class="hero-sub mb-3">
            A research-grade, single-view dashboard that combines BK indicator families
            (KMRI, TPVI, GDFI, RSAC) with a ForumFlow-WSB crowd-flow strip across
            intraday, weekly and monthly horizons.
          </p>
          <p class="hero-sub mb-3">
            The layout is designed for projected indicator series and policy
            narratives – a structured way to observe how fundamental and
            crowd-driven dynamics interact over time.
          </p>
          <div class="d-flex flex-wrap gap-2 mb-3">
            <div class="pill">
              <i class="bi bi-diagram-3"></i>
              <span>KMRI · TPVI · GDFI · RSAC</span>
            </div>
            <div class="pill">
              <i class="bi bi-people"></i>
              <span>ForumFlow-WSB intraday / week / month</span>
            </div>
            <div class="pill">
              <i class="bi bi-columns-gap"></i>
              <span>Multi-chart view with overlays & volume</span>
            </div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="section-label mb-0" style="letter-spacing:.16em;">Scenario lens</span>
            <select id="scenarioSelect" class="form-select form-select-sm"
                    style="width:auto;min-width:260px;max-width:100%;background:#020617;color:#e5e7eb;border-color:#4b5563;">
              <option value="baseline">Baseline · neutral macro configuration</option>
              <option value="energy">Energy transition stress</option>
              <option value="easing">Policy easing bias</option>
              <option value="riskoff">Risk-off phase · fragmentation</option>
              <option value="tech">Tech upcycle · growth tilt</option>
            </select>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card-soft">
            <div class="card-body">
              <div class="section-label mb-1">Concept</div>
              <p class="small mb-2">
                Primary panel with benchmark overlays, a cross-indicator matrix,
                multi-view sector windows and a dedicated ForumFlow-WSB section.
              </p>
              <p class="small mb-1">
                <strong>ForumFlow-WSB crowd strip.</strong> A structured crowd-tone
                index on a −1 to +1 scale:
              </p>
              <ul class="small mb-1">
                <li>Intraday: short-horizon activity strip.</li>
                <li>Week: regime-style risk-on / risk-off profile.</li>
                <li>Month: structural bias of the current cycle.</li>
              </ul>
              <p class="small text-secondary mb-0">
                The page layout is built for real BK indicator time series and
                scenario-linked narratives.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN TERMINAL ROW -->
  <section class="pb-3">
    <div class="container">
      <div class="row g-4 chart-grid">
        <!-- Primary price / overlay / ForumFlow strip -->
        <div class="col-12 chart-block">
          <div class="terminal-shell">
            <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <div class="terminal-top">
              <span class="terminal-top-title" id="mainTitle">
                BK Macro Composite · Price + KMRI + ForumFlow-WSB strip
              </span>
              <span class="terminal-top-meta" id="mainMeta">
                Line · Overlay · Volume · Projected indicator layout
              </span>
            </div>
            <div class="terminal-fkeys">
              <span>F1 HELP</span><span>F2 CROWD</span><span>F3 KMRI</span><span>F4 TPVI</span>
              <span>F5 GDFI</span><span>F6 RSAC</span><span>F7 SCREEN</span><span>F8 EXPORT</span>
            </div>
            <div class="terminal-toolbar">
              <span class="toolbar-label">Asset</span>
              <select id="assetSelect" class="form-select form-select-sm"
                      style="width:auto;min-width:260px;background:#020617;color:#e5e7eb;border-color:#4b5563;">
                <!-- 10 asset-style themes -->
                <option value="BK Macro Composite">BK Macro Composite</option>
                <option value="BK Real Economy Basket">BK Real Economy Basket</option>
                <option value="BK Telecom & Infrastructure">BK Telecom & Infrastructure</option>
                <option value="BK Energy & Utilities">BK Energy & Utilities</option>
                <option value="BK Housing & Rents">BK Housing & Rents</option>
                <option value="BK Food & Essentials">BK Food & Essentials</option>
                <option value="BK Cost-of-Living Pressure">BK Cost-of-Living Pressure</option>
                <option value="BK Labour Income Momentum">BK Labour Income Momentum</option>
                <option value="BK Education & Skills Capital">BK Education & Skills Capital</option>
                <option value="BK Health & Care Demand">BK Health & Care Demand</option>
              </select>
              <span class="toolbar-label ms-2">Overlay</span>
              <select id="overlaySelect" class="form-select form-select-sm"
                      style="width:auto;min-width:270px;background:#020617;color:#e5e7eb;border-color:#4b5563;">
                <!-- 10 overlay-style themes -->
                <option value="BK Policy Volatility Gauge">BK Policy Volatility Gauge</option>
                <option value="BK Financial Conditions Index">BK Financial Conditions Index</option>
                <option value="BK Fragmentation Index">BK Fragmentation Index</option>
                <option value="BK Core Inflation Composite">BK Core Inflation Composite</option>
                <option value="BK Income vs. Prices Spread">BK Income vs. Prices Spread</option>
                <option value="BK Demographic Resilience Score">BK Demographic Resilience Score</option>
                <option value="BK Trade & Supply Chains Monitor">BK Trade & Supply Chains Monitor</option>
                <option value="BK Climate & Transition Risk">BK Climate & Transition Risk</option>
                <option value="BK Capital Investment Pulse">BK Capital Investment Pulse</option>
                <option value="BK Institutional Confidence Index">BK Institutional Confidence Index</option>
              </select>
              <span class="toolbar-label ms-2">Range</span>
              <button class="toolbar-btn main-range-btn" data-range="3M">3M</button>
              <button class="toolbar-btn main-range-btn active-range" data-range="6M">6M</button>
              <button class="toolbar-btn main-range-btn" data-range="1Y">1Y</button>
              <button class="toolbar-btn main-range-btn" data-range="5Y">5Y</button>
              <span class="toolbar-label ms-2">Theme</span>
              <span id="mainThemeLabel" style="font-size:.7rem;letter-spacing:.14em;">KMRI · Macro composite</span>
            </div>
            <div class="terminal-actions">
              <div class="terminal-actions-left">
                <span class="terminal-action">Track</span>
                <span class="terminal-action">Annotate</span>
                <span class="terminal-action">Narrative</span>
                <span class="terminal-action">Zoom</span>
                <span class="terminal-action">Compare</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span id="scenarioStatusLabel">Scenario: Baseline</span>
                <span class="terminal-action" id="popoutMainBtn">Popout</span>
                <span class="terminal-action-icon" title="Settings"><i class="bi bi-gear-fill"></i></span>
              </div>
            </div>
            <div class="terminal-body">
              <div class="terminal-legend">
                <div class="terminal-legend-title">Normalised lines</div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#facc15;"></span>
                    <span>Asset</span>
                  </div>
                  <span class="legend-val" id="legendAsset">0.00</span>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#38bdf8;"></span>
                    <span>Overlay</span>
                  </div>
                  <span class="legend-val" id="legendOverlay">0.00</span>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#a855f7;"></span>
                    <span>ForumFlow-WSB strip</span>
                  </div>
                  <span class="legend-val" id="legendStrip">0.00</span>
                </div>
              </div>
              <div class="terminal-chart" id="mainChartShell">
                <canvas id="mainChart"></canvas>
              </div>
            </div>
            <div class="terminal-status">
              <div class="d-flex align-items-center flex-wrap gap-2">
                <span class="status-dot"></span>
                <span class="status-label">Mode</span>
                <span class="status-value" id="statusMode">Indicator projection layout</span>
                <span class="status-label ms-2">KMRI</span>
                <span class="status-value" id="statusKMRI">0.00</span>
                <span class="status-label ms-2">TPVI</span>
                <span class="status-value" id="statusTPVI">0.00</span>
                <span class="status-label ms-2">GDFI</span>
                <span class="status-value" id="statusGDFI">0.00</span>
              </div>
              <div class="text-end">
                <span class="status-label me-1">Last update</span>
                <span class="status-value" id="statusUpdated"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- PRICE+VOLUME and CROSS-INDICATOR PANEL -->
        <div class="col-lg-7 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">Price · Volume micro-panel</span>
                <span class="indicator-chip">
                  <i class="bi bi-bar-chart-steps"></i>
                  <span>Line + histogram · dual axis</span>
                </span>
              </div>
              <div class="terminal-shell" style="box-shadow:none;border-radius:.8rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title" id="pvTitle">Asset vs volume</span>
                  <span class="terminal-top-meta">Close, normalised · relative volume</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Series</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#facc15;"></span>
                        <span>Price</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#38bdf8;"></span>
                        <span>Volume (bars)</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:210px;">
                    <canvas id="priceVolumeChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Last</span>
                    <span class="status-value" id="pvLast">0.00</span>
                    <span class="status-label ms-2">Volume</span>
                    <span class="status-value" id="pvVol">0</span>
                  </div>
                  <div>
                    <span class="status-label">Range</span>
                    <span class="status-value">20 latest points</span>
                  </div>
                </div>
              </div>
              <p class="small text-secondary mt-2 mb-0">
                Stylised closing levels and relative volume for the currently selected
                indicator-linked asset theme. Volumes are scaled for visual comparison.
              </p>
            </div>
          </div>
        </div>

        <div class="col-lg-5 chart-block">
          <div class="card-soft h-100" id="indicators">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">Cross-indicator matrix</span>
                <span class="indicator-chip">
                  <i class="bi bi-diagram-3"></i>
                  <span>KMRI · TPVI · GDFI composite</span>
                </span>
              </div>
              <div class="terminal-shell" style="box-shadow:none;border-radius:.8rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">BK indices · normalised 0–1</span>
                  <span class="terminal-top-meta">Quarterly stylised path</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">BK indices</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#22c55e;"></span>
                        <span>KMRI</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#f97316;"></span>
                        <span>TPVI</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#38bdf8;"></span>
                        <span>GDFI</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:210px;">
                    <canvas id="kmriChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">KMRI</span>
                    <span class="status-value" id="kmriLast">0.00</span>
                    <span class="status-label ms-2">TPVI</span>
                    <span class="status-value" id="tpviLast">0.00</span>
                    <span class="status-label ms-2">GDFI</span>
                    <span class="status-value" id="gdfiLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">Theme set</span>
                    <span class="status-value">Resilience · volatility · fragmentation</span>
                  </div>
                </div>
              </div>
              <p class="small text-secondary mt-2 mb-0">
                KMRI (macro resilience), TPVI (policy volatility) and GDFI
                (geo-financial fragmentation) together provide a high-level backdrop
                for the crowd-flow and sector-level panels.
              </p>
            </div>
          </div>
        </div>

      </div>

      <!-- extra main multiview charts -->
      <div class="row g-4 chart-grid mt-3">
        <div class="col-lg-6 chart-block">
          <div class="terminal-shell">
            <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <div class="terminal-top">
              <span class="terminal-top-title">Core vs headline vs income spread</span>
              <span class="terminal-top-meta">Macro spread panel · 0–1</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-legend">
                <div class="terminal-legend-title">Macro spread lines</div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#38bdf8;"></span>
                    <span>Core inflation composite</span>
                  </div>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#f97316;"></span>
                    <span>Headline basket</span>
                  </div>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#22c55e;"></span>
                    <span>Labour income momentum</span>
                  </div>
                </div>
              </div>
              <div class="terminal-chart" style="height:230px;">
                <canvas id="macroSpreadChart"></canvas>
              </div>
            </div>
            <div class="terminal-status">
              <div>
                <span class="status-label">Use</span>
                <span class="status-value">Price vs income alignment</span>
              </div>
              <div>
                <span class="status-label">View</span>
                <span class="status-value">Medium-horizon panel</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6 chart-block">
          <div class="terminal-shell">
            <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <div class="terminal-top">
              <span class="terminal-top-title">Policy mix & financial conditions</span>
              <span class="terminal-top-meta">TPVI · conditions · ForumFlow overlay</span>
            </div>
            <div class="terminal-body">
              <div class="terminal-legend">
                <div class="terminal-legend-title">Policy-conditions lines</div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#f97316;"></span>
                    <span>TPVI policy volatility</span>
                  </div>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#38bdf8;"></span>
                    <span>Financial conditions</span>
                  </div>
                </div>
                <div class="legend-row">
                  <div class="legend-left">
                    <span class="legend-color" style="background:#a855f7;"></span>
                    <span>ForumFlow-WSB (scaled)</span>
                  </div>
                </div>
              </div>
              <div class="terminal-chart" style="height:230px;">
                <canvas id="policyMixChart"></canvas>
              </div>
            </div>
            <div class="terminal-status">
              <div>
                <span class="status-label">Use</span>
                <span class="status-value">Narrative on policy stance</span>
              </div>
              <div>
                <span class="status-label">View</span>
                <span class="status-value">Overlay with crowd response</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- ForumFlow-WSB SECTION -->
  <section id="forumflow" class="pb-4 pt-1">
    <div class="container">
      <div class="row g-4 chart-grid">
        <div class="col-lg-7 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">ForumFlow-WSB crowd strip</span>
                <span class="indicator-chip">
                  <i class="bi bi-people"></i>
                  <span>Crowd tone · −1 … +1</span>
                </span>
              </div>
              <p class="small mb-3">
                ForumFlow-WSB is a synthetic crowd-tone index summarising the balance
                between high-risk positioning and capital on the sidelines. Values
                near +1 indicate broad risk-seeking behaviour; values near −1 reflect
                sustained de-risking. Intraday dynamics emulate short-horizon flow,
                while weekly and monthly views capture regimes and cycles.
              </p>

              <div class="terminal-shell">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title" id="wsbTitle">ForumFlow-WSB · Intraday tape</span>
                  <span class="terminal-top-meta" id="wsbMeta">Linked to crowd-flow strip · −1…+1</span>
                </div>
                <div class="terminal-toolbar">
                  <span class="toolbar-label">Horizon</span>
                  <button class="toolbar-btn wsb-btn active-range" data-mode="intraday">Intraday</button>
                  <button class="toolbar-btn wsb-btn" data-mode="week">1W regime</button>
                  <button class="toolbar-btn wsb-btn" data-mode="month">1M cycle</button>
                  <span class="toolbar-label ms-2">Tone</span>
                  <span id="wsbToneLabel" style="font-size:.7rem;letter-spacing:.14em;">Calibrating…</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">ForumFlow sentiment</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#a855f7;"></span>
                        <span>Index level</span>
                      </div>
                      <span class="legend-val" id="wsbLast">0.00</span>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#4ade80;"></span>
                        <span>Risk-seeking threshold</span>
                      </div>
                      <span class="legend-val">+0.40</span>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#f97316;"></span>
                        <span>De-risking threshold</span>
                      </div>
                      <span class="legend-val">−0.40</span>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:230px;">
                    <canvas id="wsbChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Mode</span>
                    <span class="status-value" id="wsbStatusMode">Intraday tape · linked</span>
                  </div>
                  <div>
                    <span class="status-label">Last refresh</span>
                    <span class="status-value" id="wsbUpdated"></span>
                  </div>
                </div>
              </div>

              <!-- Extra gauge: Participation-Conviction -->
              <div class="terminal-shell mt-3" style="box-shadow:none;border-radius:.9rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">Participation-Conviction Gauge</span>
                  <span class="terminal-top-meta">Flow intensity vs conviction · proxy for chase behaviour</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Gauge series</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#4ade80;"></span>
                        <span>Participation-conviction level</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:160px;">
                    <canvas id="pcgChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Gauge</span>
                    <span class="status-value" id="pcgLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">Interpretation</span>
                    <span class="status-value" id="pcgInterpret">Neutral participation</span>
                  </div>
                </div>
              </div>

              <p class="small text-secondary mt-2 mb-0">
                The Participation-Conviction Gauge highlights phases where flows and
                conviction reinforce each other – the episodes often described
                informally as “fear of missing out” or “all-in” conditions – in a
                more neutral, researchable format.
              </p>
            </div>
          </div>
        </div>

        <!-- Cross-asset ForumFlow snapshot -->
        <div class="col-lg-5 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">ForumFlow cross-asset snapshot</span>
                <span class="indicator-chip">
                  <i class="bi bi-grid-3x3-gap"></i>
                  <span>Current crowd tilts & mixes</span>
                </span>
              </div>
              <p class="small mb-2">
                Stylised allocation snapshot across broad themes: growth/tech,
                cyclicals, defensives, digital assets and macro hedges – linked to
                the active ForumFlow-WSB horizon.
              </p>

              <div class="terminal-shell" style="box-shadow:none;border-radius:.9rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">ForumFlow cross-asset bias</span>
                  <span class="terminal-top-meta">Bars · linked to crowd strip</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Tilts</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#22c55e;"></span>
                        <span>Overweight (positive)</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#f97316;"></span>
                        <span>Underweight (negative)</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:220px;">
                    <canvas id="sentimentChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Scale</span>
                    <span class="status-value">−1 = net underweight · +1 = net overweight</span>
                  </div>
                  <div>
                    <span class="status-label">Linked horizon</span>
                    <span class="status-value" id="sentimentLinked">Intraday</span>
                  </div>
                </div>
              </div>

              <!-- NEW: ForumFlow activity & volume stream -->
              <div class="terminal-shell mt-3" style="box-shadow:none;border-radius:.9rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">ForumFlow activity & volume</span>
                  <span class="terminal-top-meta">Daily / weekly / monthly stream</span>
                </div>
                <div class="terminal-toolbar">
                  <span class="toolbar-label">Horizon</span>
                  <button class="toolbar-btn sent-act-btn active-range" data-mode="daily">Daily</button>
                  <button class="toolbar-btn sent-act-btn" data-mode="weekly">Weekly</button>
                  <button class="toolbar-btn sent-act-btn" data-mode="monthly">Monthly</button>
                  <span class="toolbar-label ms-2">Linked</span>
                  <span id="sentActLinkedLabel" style="font-size:.7rem;letter-spacing:.14em;">
                    ForumFlow configuration
                  </span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Activity streams</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#38bdf8;"></span>
                        <span>Volume (bars)</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#22c55e;"></span>
                        <span>Activity line</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:180px;">
                    <canvas id="sentActChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Last volume</span>
                    <span class="status-value" id="sentActVolLast">0</span>
                    <span class="status-label ms-2">Activity</span>
                    <span class="status-value" id="sentActActLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">Mode</span>
                    <span class="status-value" id="sentActModeLabel">Daily strip</span>
                  </div>
                </div>
              </div>

              <p class="small text-secondary mt-2 mb-0">
                Bars move with the active ForumFlow mode: intraday updates every few
                seconds, while weekly and monthly settings emphasise persistence
                rather than noise. The activity stream adds a clean map of
                participation and flow over daily, weekly and monthly horizons.
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- EXTRA MULTI-VIEW ROW -->
  <section id="extras" class="pb-4 pt-1">
    <div class="container">
      <div class="section-label mb-2">Additional indicator views</div>
      <div class="row g-4 chart-grid">
        <div class="col-lg-4 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">RSAC stress channel</span>
                <span class="indicator-chip">
                  <i class="bi bi-activity"></i>
                  <span>RSAC mini-panel</span>
                </span>
              </div>
              <div class="terminal-shell" style="box-shadow:none;border-radius:.8rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">RSAC · Regional stress & adjustment</span>
                  <span class="terminal-top-meta">Normalised · 0–1</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">RSAC</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#f97316;"></span>
                        <span>Stress channel</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:160px;">
                    <canvas id="rsacChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">RSAC</span>
                    <span class="status-value" id="rsacLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">Signal</span>
                    <span class="status-value">Higher values = more stress</span>
                  </div>
                </div>
              </div>
              <p class="small text-secondary mt-2 mb-0">
                RSAC captures regional strain vs adjustment capacity –
                useful alongside KMRI and GDFI when scanning for non-linear risks.
              </p>
            </div>
          </div>
        </div>

        <div class="col-lg-4 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">Housing & cost-of-living</span>
                <span class="indicator-chip">
                  <i class="bi bi-house-door"></i>
                  <span>Housing vs living costs</span>
                </span>
              </div>
              <div class="terminal-shell" style="box-shadow:none;border-radius:.8rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">Housing pressure vs cost-of-living</span>
                  <span class="terminal-top-meta">Two-line comparison</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Affordability lines</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#38bdf8;"></span>
                        <span>Housing pressure</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#a855f7;"></span>
                        <span>Cost-of-living composite</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:160px;">
                    <canvas id="housingChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Housing</span>
                    <span class="status-value" id="housingLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">Cost-of-living</span>
                    <span class="status-value" id="colLast">0.00</span>
                  </div>
                </div>
              </div>
              <p class="small text-secondary mt-2 mb-0">
                Alignment or divergence between housing pressure and broader
                cost-of-living indicators helps anchor affordability narratives.
              </p>
            </div>
          </div>
        </div>

        <div class="col-lg-4 chart-block">
          <div class="card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="section-label mb-0">Labour & income dynamics</span>
                <span class="indicator-chip">
                  <i class="bi bi-briefcase"></i>
                  <span>Income vs resilience</span>
                </span>
              </div>
              <div class="terminal-shell" style="box-shadow:none;border-radius:.8rem;">
                <button class="fullscreen-btn" type="button" title="Toggle fullscreen">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <div class="terminal-top">
                  <span class="terminal-top-title">Labour income vs KMRI</span>
                  <span class="terminal-top-meta">Co-movement gauge</span>
                </div>
                <div class="terminal-body">
                  <div class="terminal-legend">
                    <div class="terminal-legend-title">Income & resilience</div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#22c55e;"></span>
                        <span>Labour income momentum</span>
                      </div>
                    </div>
                    <div class="legend-row">
                      <div class="legend-left">
                        <span class="legend-color" style="background:#facc15;"></span>
                        <span>KMRI overlay</span>
                      </div>
                    </div>
                  </div>
                  <div class="terminal-chart" style="height:160px;">
                    <canvas id="labourChart"></canvas>
                  </div>
                </div>
                <div class="terminal-status">
                  <div>
                    <span class="status-label">Income</span>
                    <span class="status-value" id="labourLast">0.00</span>
                  </div>
                  <div>
                    <span class="status-label">KMRI overlay</span>
                    <span class="status-value" id="labourKmriLast">0.00</span>
                  </div>
                </div>
              </div>
              <p class="small text-secondary mt-2 mb-0">
                Labour-income momentum relative to KMRI provides a quick sense of
                how households experience macro resilience on the ground.
              </p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container d-flex flex-column flex-md-row justify-content-between gap-2">
    <span>© <span id="year"></span> Benjamin Koch. All rights reserved.</span>
    <span>Research view for projected indicators · No cookies, no trackers, no analytics.</span>
  </div>
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>


/* Bloomberg-style canvas charts (proxy-free) for BK Macro Terminal
   - Deterministic “moc” historical shapes per series (stable across range selection)
   - Auto-updating last point
   - Crosshair, tooltip, pan/zoom, double-click reset
   - Future space + last-price extension + orange reference line
   - Fullscreen toggle for main chart (and any chart via Alt+Click)
*/

(function(){
  const $ = (id)=>document.getElementById(id);

  // ---------- time / formatting ----------
  const pad2 = (n)=> (n<10?"0":"")+n;
  const fmtDateUTC = (d)=>{
    const mm=pad2(d.getUTCMonth()+1), dd=pad2(d.getUTCDate()), yy=String(d.getUTCFullYear()).slice(-2);
    return `${mm}/${dd}/${yy}`;
  };
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
  const round3 = (x)=> (Math.round(x*1000)/1000).toFixed(3);
  const dpr = ()=> Math.max(1, window.devicePixelRatio || 1);

  // ---------- deterministic generator ----------
  function hashSeed(str){
    let h=2166136261>>>0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h>>>0;
  }
  function seeded(seed){
    let x = seed|0;
    return ()=>{ x ^= x<<13; x ^= x>>>17; x ^= x<<5; return (x>>>0)/4294967296; };
  }
  function makeSeries({seedStr, days=365*10, base=100, drift=0.01, vol=0.8, shockAt=0.72, shock=-2.2, meanRev=0.0012,
                     shockMode="down", cycleAmp=0, cyclePeriod=180, jumpProb=0, jumpScale=1.0}){
    const rnd = seeded(hashSeed(seedStr));
    const end = new Date();
    const start = new Date(end.getTime() - days*24*60*60*1000);
    let x = base;
    const anchor = base;
    const out = [];

    // deterministic "macro texture": gentle cycle + rare jumps + regime shock
    for(let i=0;i<=days;i++){
      const t = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()+i));
      const eps = (rnd()*2-1)*vol;

      const cyc = cycleAmp ? (cycleAmp * Math.sin((2*Math.PI*i)/Math.max(10, cyclePeriod))) : 0;

      let jump = 0;
      if(jumpProb && rnd() < jumpProb){
        const sign = (rnd() < 0.5 ? -1 : 1);
        jump = sign * jumpScale * (0.5 + rnd());
      }

      // late-regime "shock" (can be down-only or two-sided)
      let s = 0;
      if(i/days > shockAt){
        const mag = Math.abs(shock) * (rnd()*0.6 + 0.4);
        if(String(shockMode||"down") === "both"){
          s = (rnd() < 0.5 ? -mag : mag);
        }else if(String(shockMode||"down") === "up"){
          s = +mag;
        }else{
          s = -mag; // default down
        }
      }

      x = x + drift + eps + cyc + jump + s - meanRev*(x-anchor);
      out.push({t, v:x});
    }
    return out;
  }

  // ---------- ticks ----------
  function niceTicks(min, max, target=6){
    const span = (max-min) || 1;
    const raw = span/target;
    const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const steps = [1,2,2.5,5,10];
    let step = steps[0]*pow;
    for(const s of steps){
      const cand = s*pow;
      if(raw<=cand){ step=cand; break; }
    }
    const start = Math.floor(min/step)*step;
    const end   = Math.ceil(max/step)*step;
    const ticks=[];
    for(let v=start; v<=end+1e-12; v+=step) ticks.push(v);
    return ticks;
  }

  // ---------- chart core ----------
  class BloombergCanvasChart{
    constructor(canvas, {title="", unit="", seedStr="SERIES", base=100, drift=0.01, vol=0.8, shockAt=0.72, shock=-2.2, meanRev=0.0012,
      shockMode="down", cycleAmp=0, cyclePeriod=180, jumpProb=0, jumpScale=1.0,
      kind="standard", overlays=[], volumeSpec=null,
      compares=[], compareEnabled=[]}){

      this.canvas = canvas;
      this.ctx = canvas.getContext("2d", {alpha:false});
      this.title = title;
      this.unit = unit;

      // ---------- real-time streaming microstructure ----------
      // Per-chart state so each panel has distinct “personality” (smooth vs jumpy), while remaining realistic.
      this.rt = {
        enabled: true,
        // how fast the x-axis moves: smaller => faster tape. tuned to feel “terminal-like” without tearing.
        pointStepMs: 520,       // ~1.9 “points” per second (visual density), independent of tick cadence
        xOffset: 0,             // fractional progress towards next index (0..1)
        lastAdvanceTs: performance.now(),
        // volatility regime: mean-reverting sigma + occasional jumps
        sigmaBase: Math.max(1e-9, (Math.abs(base)||1) * (0.00055 + 0.00055*Math.min(2.5, Math.abs(vol)||1))),
        sigmaNow:  0,
        driftTick: (drift||0) * 0.02, // tiny per-tick drift
        trend: 0,
        jumpProb: Math.max(0, Math.min(0.025, (jumpProb||0)*0.08 + 0.004)),
        jumpScale: Math.max(0.6, Math.min(3.8, (jumpScale||1.0))),
        smoothness: Math.max(0.55, Math.min(0.92, 0.82 - 0.08*Math.min(2.5, Math.abs(vol)||1))), // higher = smoother
        // deterministic RNG stream for tick noise (per chart)
        tickSeed: 0,
      };
      this.rt.sigmaNow = this.rt.sigmaBase;
      this.rt.tickSeed = hashSeed("TICK|" + seedStr);

      // Gaussian helper (Box–Muller) using seeded uniform RNG.
      this._gauss = (u1,u2)=>{
        u1 = Math.max(1e-12, u1);
        return Math.sqrt(-2*Math.log(u1)) * Math.cos(2*Math.PI*u2);
      };

      // rendering mode: standard | strip | priceVolume
      this.kind = kind || "standard";
      this.overlays = Array.isArray(overlays) ? overlays : [];
      this.volumeSpec = volumeSpec;

      // per-chart toggle for threshold/regime overlays
      this.overlaysEnabled = true; // {seedStr, base, drift, vol, shock, meanRev}

      this.seedStr = seedStr;
      this.base=base; this.drift=drift; this.vol=vol; this.shock=shock; this.meanRev=meanRev;
      this.shockAt=shockAt; this.shockMode=shockMode; this.cycleAmp=cycleAmp; this.cyclePeriod=cyclePeriod; this.jumpProb=jumpProb; this.jumpScale=jumpScale;
      // comparison overlays (toggleable)
      this.compares = Array.isArray(compares) ? compares : [];
      this.compareEnabled = new Set(Array.isArray(compareEnabled) ? compareEnabled : []);
      if(this.compareEnabled.size===0){
        for(const c of this.compares){ if(c && c.key) this.compareEnabled.add(c.key); }
      }
      this.compareSeries = new Map();
      this._rebuildCompares();


      this.futurePadPx = 90;
      this.points = makeSeries({seedStr, base, drift, vol, shockAt, shock, meanRev, shockMode, cycleAmp, cyclePeriod, jumpProb, jumpScale});

      // streaming tween state (Bloomberg-feel continuous tail drawing)
      this.stream = {
        enabled: true,            // ALWAYS stream (no hover gating)
        tickIntervalMs: 50,       // driven externally by scheduler; kept for reference
        tweenMs: 120,             // tail animation duration (<= tick interval)
        pointStepMs: Math.round(380 + 320*this.rt.smoothness), // per-chart cadence (smoother charts scroll slower)
        xOffset: 0,               // fractional scroll between points
        lastAdvanceTs: performance.now(),
        prevLast: null,
        nextLast: null,
        tweenStartTs: performance.now(),
        isPrimed: false
      };

      // optional volume track (used by priceVolume panels)
      if(this.kind === "priceVolume"){
        const vs = this.volumeSpec || {};
        const vSeed = vs.seedStr || (seedStr + "|VOL");
        const vBase = vs.base ?? 1_000_000;
        const vDrift = vs.drift ?? 80;
        const vVol = vs.vol ?? 20_000;
        const vShock = vs.shock ?? 60_000;
        const vMeanRev = vs.meanRev ?? 0.0008;
        this.volumePoints = makeSeries({seedStr: vSeed, base: vBase, drift: vDrift, vol: vVol, shock: vShock, meanRev: vMeanRev});
      } else {
        this.volumePoints = null;
      }
      this.rangeKey = "3M";
      this.view = {i0:0, i1:this.points.length, y0:0, y1:0, dragging:false, dragX:0, dragI0:0, dragI1:0, hoverX:null, hoverY:null};
      this.hoverIndex = null;
      this.hoverValue = null;
      this.applyRange(this.rangeKey, true);

      this.tooltip = this._ensureTooltip();
      this.resize();
      this.bind();
      this.render();
    }

    
    _rebuildCompares(){
      this.compareSeries.clear();
      for(const c of this.compares){
        const seedStr = c.seedStr || ("CMP|" + c.key);
        const base = (c.base ?? this.base);
        const drift = (c.drift ?? this.drift);
        const vol = (c.vol ?? this.vol);
        const shock = (c.shock ?? this.shock);
        const meanRev = (c.meanRev ?? this.meanRev);
        const pts = makeSeries({seedStr, base, drift, vol, shock, meanRev});
        this.compareSeries.set(c.key, pts);
      }
    }

    setCompareEnabled(key, on){
      if(on) this.compareEnabled.add(key);
      else this.compareEnabled.delete(key);
      this.render();
    }


    setOverlaysEnabled(on){
      this.overlaysEnabled = !!on;
      this.render();
    }

    replaceCompares(compares){
      this.compares = Array.isArray(compares) ? compares : [];
      this.compareEnabled = new Set();
      for(const c of this.compares){ if(c.defaultOn) this.compareEnabled.add(c.key); }
      this._rebuildCompares();
      this.applyRange(this.rangeKey, true);
      this.render();
    }
_ensureTooltip(){
      // reuse existing tooltip container if present (parent .overlay .tooltip), else create minimal
      const wrap = this.canvas.parentElement;
      let tt = wrap?.querySelector?.(".tooltip");
      if(tt) return tt;

      const ov = document.createElement("div");
      ov.style.position="absolute";
      ov.style.inset="0";
      ov.style.pointerEvents="none";
      ov.innerHTML = `<div class="tooltip" style="
        position:absolute; display:none; min-width:240px;
        background:rgba(10,11,13,.92); border:1px solid #232838; border-radius:10px;
        padding:10px; font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        color:#e9e9e9; box-shadow:0 10px 24px rgba(0,0,0,.35);
      "></div>`;
      wrap.style.position = wrap.style.position || "relative";
      wrap.appendChild(ov);
      return ov.querySelector(".tooltip");
    }

    resize(){
      const rect = this.canvas.getBoundingClientRect();
      const W = Math.max(10, Math.floor(rect.width));
      const H = Math.max(10, Math.floor(rect.height));
      const scale = dpr();
      this.W=W; this.H=H;
      this.canvas.width = Math.floor(W*scale);
      this.canvas.height = Math.floor(H*scale);
      this.ctx.setTransform(scale,0,0,scale,0,0);
      this.render();
    }

    applyRange(key, silent=false){
      this.rangeKey = key;
      const pts = this.points;
      const lastT = pts[pts.length-1].t;
      let days;
      let startT;
      if(key==="1D"){ days=1; startT = new Date(lastT.getTime() - 1*24*60*60*1000); }
      else if(key==="1W"){ days=7; startT = new Date(lastT.getTime() - 7*24*60*60*1000); }
      else if(key==="1M"){ days=30; startT = new Date(lastT.getTime() - 30*24*60*60*1000); }
      else if(key==="3M"){ days=92; startT = new Date(lastT.getTime() - 92*24*60*60*1000); }
      else if(key==="6M"){ days=182; startT = new Date(lastT.getTime() - 182*24*60*60*1000); }
      else if(key==="YTD"){ startT = new Date(Date.UTC(lastT.getUTCFullYear(),0,1,0,0,0)); }
      else if(key==="1Y"){ days=365; startT = new Date(lastT.getTime() - 365*24*60*60*1000); }
      else if(key==="5Y"){ days=365*5; startT = new Date(lastT.getTime() - (365*5)*24*60*60*1000); }
      else if(key==="10Y"){ days=365*10; startT = new Date(lastT.getTime() - (365*10)*24*60*60*1000); }
      else if(key==="MAX" || key==="ALL"){ startT = pts[0]?.t || new Date(lastT.getTime() - (365*10)*24*60*60*1000); }
      else { days=92; startT = new Date(lastT.getTime() - 92*24*60*60*1000); }

      let i0=0;
      while(i0<pts.length && pts[i0].t < startT) i0++;
      this.view.i0 = clamp(i0, 0, Math.max(0, pts.length-2));
      this.view.i1 = pts.length;
      this.recomputeY();
      if(!silent) this.render();
    }

    recomputeY(){
      const pts=this.points;
      const {i0,i1}=this.view;

      let lo=Infinity, hi=-Infinity;

      // primary series
      for(let i=i0;i<i1;i++){
        const v=pts[i].v;
        if(v<lo) lo=v;
        if(v>hi) hi=v;
      }

      // include enabled compare overlays so they are never clipped
      if(this.compares.length){
        for(const c of this.compares){
          if(!this.compareEnabled.has(c.key)) continue;
          const cpts = this.compareSeries.get(c.key);
          if(!cpts || cpts.length<2) continue;
          const j0 = Math.min(i0, cpts.length-2);
          const j1 = Math.min(i1, cpts.length);
          for(let j=j0;j<j1;j++){
            const v=cpts[j].v;
            if(v<lo) lo=v;
            if(v>hi) hi=v;
          }
        }
      }

      const pad=(hi-lo)*0.10 || (Math.abs(hi)||1)*0.02;
      this.view.y0 = lo - pad;
      this.view.y1 = hi + pad;
    }

    dataRightX(){
      const padR=52;
      return (this.W-padR) - this.futurePadPx;
    }
    fullRightX(){
      const padR=52;
      return (this.W-padR);
    }
    mapX(i){
      const {i0,i1}=this.view;
      const padL=16;
      const x0=padL;
      const x1=this.dataRightX();
      // Continuous time-scroll: we shift the x-mapping by a fractional offset that advances with real time.
      // This creates the Bloomberg-like “tape” motion without redrawing jitter/flicker.
      const off = (this.rt && isFinite(this.rt.xOffset)) ? this.rt.xOffset : 0;
      const t=( (i - i0) - off )/Math.max(1,(i1-i0-1));
      return x0 + t*(x1-x0);
    }
    mapY(v){
      const {y0,y1}=this.view;
      const padT=12, padB=24;
      const yTop=padT, yBot=this.H-padB;
      const t=(v-y0)/(y1-y0||1);
      return yBot - t*(yBot-yTop);
    }
    nearestIndexFromX(x){
      const {i0,i1}=this.view;
      const padL=16;
      const x0=padL, x1=this.dataRightX();
      const t=(x-x0)/(x1-x0);
      const i=Math.round(i0 + clamp(t,0,1)*(i1-i0-1));
      return clamp(i,i0,i1-1);
    }

    showTooltip(mx,my){
      const pts=this.points;
      const i=this.nearestIndexFromX(mx);
      const p=pts[i];
      const px=this.mapX(i);
      const py=this.mapY(p.v);

      this.view.hoverX=px; this.view.hoverY=py;

      this.hoverIndex = i;
      this.hoverValue = p.v;

      const ref = pts[this.view.i0]?.v ?? pts[0].v;
      const chg = p.v - ref;
      const pct = (chg/ref)*100;

      const tt=this.tooltip;
      tt.style.display="block";
      tt.innerHTML = `
        <div style="color:#a7a7a7">${this.title || "Series"}</div>
        <div style="margin-top:6px;"><span style="color:#7c7c7c">Date</span> ${fmtDateUTC(p.t)} <span style="color:#7c7c7c">UTC</span></div>
        <div><span style="color:#7c7c7c">Value</span> ${round3(p.v)} ${this.unit||""}</div>
        <div><span style="color:#7c7c7c">Δ vs ref</span> ${(chg>=0?"+":"") + round3(chg)} (${(pct>=0?"+":"") + (Math.round(pct*100)/100).toFixed(2)}%)</div>
      `;
      const tw=260, th=92;
      const ox = (px < this.W/2) ? px + 12 : px - (tw + 12);
      const oy = clamp(py - th/2, 8, this.H - th - 8);
      tt.style.transform = `translate(${ox}px, ${oy}px)`;

      this.render();
    }

    hideTooltip(){
      this.tooltip.style.display="none";
      this.view.hoverX=null; this.view.hoverY=null;
      this.hoverIndex = null;
      this.hoverValue = null;
      this.render();
    }

    bind(){
      // hover
      this.canvas.addEventListener("mousemove",(e)=>{
        const r=this.canvas.getBoundingClientRect();
        const x=e.clientX-r.left;
        const y=e.clientY-r.top;

        if(this.view.dragging){
          const dx=x-this.view.dragX;
          const span=this.view.dragI1 - this.view.dragI0;
          const padL=16;
          const x0=padL, x1=this.dataRightX();
          const frac = dx/(x1-x0);
          const shift = Math.round(-frac*span);

          const pts=this.points;
          let ni0=this.view.dragI0+shift;
          let ni1=this.view.dragI1+shift;
          if(ni0<0){ ni1-=ni0; ni0=0; }
          if(ni1>pts.length){
            const over=ni1-pts.length;
            ni0-=over; ni1=pts.length; ni0=Math.max(0,ni0);
          }
          if(ni1-ni0<30) return;

          this.view.i0=ni0; this.view.i1=ni1;
          this.recomputeY();
          this.showTooltip(x,y);
          return;
        }

        this.showTooltip(x,y);
      });
      this.canvas.addEventListener("mouseleave",()=>this.hideTooltip());

      // pan
      this.canvas.addEventListener("mousedown",(e)=>{
        const r=this.canvas.getBoundingClientRect();
        this.view.dragging=true;
        this.view.dragX = e.clientX-r.left;
        this.view.dragI0 = this.view.i0;
        this.view.dragI1 = this.view.i1;
      });
      window.addEventListener("mouseup",()=>{ this.view.dragging=false; });

      // zoom
      this.canvas.addEventListener("wheel",(e)=>{
        e.preventDefault();
        const r=this.canvas.getBoundingClientRect();
        const x=e.clientX-r.left;
        const iCenter=this.nearestIndexFromX(x);
        const pts=this.points;
        const span=this.view.i1 - this.view.i0;
        const zoom = (e.deltaY>0) ? 1.18 : 0.85;
        let newSpan=Math.round(span*zoom);
        newSpan=clamp(newSpan, 60, pts.length);

        const frac=(iCenter - this.view.i0)/span;
        let ni0=Math.round(iCenter - frac*newSpan);
        let ni1=ni0+newSpan;
        if(ni0<0){ ni1-=ni0; ni0=0; }
        if(ni1>pts.length){
          const over=ni1-pts.length;
          ni0-=over; ni1=pts.length; ni0=Math.max(0,ni0);
        }
        if(ni1-ni0<30) return;

        this.view.i0=ni0; this.view.i1=ni1;
        this.recomputeY();
        this.render();
      }, {passive:false});

      // reset
      this.canvas.addEventListener("dblclick",()=> this.applyRange(this.rangeKey));
    }

    _tailValue(){
      const s = this.stream;
      if(!s || !s.isPrimed || s.prevLast==null || s.nextLast==null) return null;
      const t = (performance.now() - s.tweenStartTs) / (s.tweenMs || 1);
      const tt = 1 - Math.pow(1 - Math.max(0, Math.min(1, t)), 3); // easeOutCubic
      return s.prevLast + (s.nextLast - s.prevLast) * tt;
    }
    _isTweening(){
      const s = this.stream;
      if(!s || !s.isPrimed) return false;
      return (performance.now() - s.tweenStartTs) < (s.tweenMs || 0);
    }
    _primeTail(target){
      const s = this.stream;
      if(!s) return;
      const current = this._tailValue();
      const fallback = this.points?.length ? this.points[this.points.length-1].v : target;
      s.prevLast = (current!=null) ? current : fallback;
      s.nextLast = target;
      s.tweenStartTs = performance.now();
      s.isPrimed = true;
    }


    // Advance the “tape” continuously based on real time (not tick cadence).
    // Returns true if the chart should repaint this frame.
    advance(now){
      const s = this.stream;
      if(!s || !s.enabled) return false;
      if(document.hidden){
        s.lastAdvanceTs = now;
        return false;
      }
      const dt = Math.max(0, now - (s.lastAdvanceTs || now));
      s.lastAdvanceTs = now;

      // x-axis continuous scroll
      s.xOffset += dt / Math.max(120, s.pointStepMs);

      // When we pass an index boundary, shift the window by one point and append a fresh point.
      // This makes the line *grow* and *move* like a true real-time chart.
      let shifted = false;
      while(s.xOffset >= 1){
        s.xOffset -= 1;
        const pts = this.points;
        if(pts && pts.length > 2){
          const last = pts[pts.length-1];
          const prev = pts[pts.length-2];

          // Keep time moving forward (UTC), but we mostly use it for cursor labels.
          const tPrev = last.t instanceof Date ? last.t : new Date();
          const tNew = new Date(tPrev.getTime() + 60*1000); // “1 minute per point” visual cadence

          // Start new point at the last value (the tick engine will move it immediately).
          const vNew = last.v;

          pts.push({t: tNew, v: vNew});
          pts.shift();

          // shift volume series (if any)
          if(this.volumePoints && this.volumePoints.length === pts.length){
            // already shifted by virtue of pts length changes, but keep consistent
          }else if(this.volumePoints && this.volumePoints.length){
            // keep volume aligned: append, shift
            const vpts = this.volumePoints;
            const tvPrev = vpts[vpts.length-1]?.t || tPrev;
            const tvNew = new Date((tvPrev instanceof Date ? tvPrev : new Date()).getTime() + 60*1000);
            const vvNew = vpts[vpts.length-1]?.v ?? 0;
            vpts.push({t: tvNew, v: vvNew});
            vpts.shift();
          }

          // When the window shifts, recompute view bounds more often to avoid sudden rescale flicker.
          this._recalcViewBounds(true);
          shifted = true;
        }
      }

      // repaint while: tail tweening, tick flash decaying, or xOffset moving (always non-zero during scroll)
      const needs = shifted || this._isTweening() || (this._tickFlashTs && (now-this._tickFlashTs)<260) || (s.xOffset>0.0001);
      return needs;
    }

    tickUpdate(){
      this._tickN = (this._tickN || 0) + 1;
      // tick flash (Bloomberg “right-edge” pulse)
      this._tickFlashTs = performance.now();
      this._tickFlashN = (this._tickFlashN || 0) + 1;
      // streaming update: set a new target for the last point; the renderer interpolates the tail continuously
      const pts=this.points;
      if(pts.length<10) return;
      const last=pts[pts.length-1];
      const prev=pts[pts.length-2];
      const st = this.rt;
      // Deterministic per-chart RNG stream (but evolving each tick)
      st.tickSeed = (st.tickSeed + 0x9e3779b9 + (this._tickN|0)) >>> 0;
      const r1 = seeded(st.tickSeed)();
      const r2 = seeded(st.tickSeed ^ 0xA5A5A5A5)();
      const z  = this._gauss(r1, r2);

      // Slow-moving volatility regime + weak trend (adds realism: clusters + mean reversion)
      st.trend = (st.trend * 0.985) + (z * st.sigmaBase * 0.018);
      st.sigmaNow = (st.sigmaNow * 0.992) + (st.sigmaBase * 0.008) + (Math.abs(z) * st.sigmaBase * 0.006);

      
      // --- realism layers: session regimes + volatility waves + order-flow imbalance + close/print accel ---
      const nowDt = new Date();
      const hr = nowDt.getHours() + nowDt.getMinutes()/60;
      // Rough global session profile (Berlin local): Asia (1-7), Europe (8-16), US overlap (15-21), after-hours (22-24/0)
      let session = 0.65;
      if(hr>=1 && hr<7) session = 0.75;          // Asia: steadier
      else if(hr>=7 && hr<15) session = 0.95;    // Europe morning: active
      else if(hr>=15 && hr<21) session = 1.15;   // US overlap: most volatile
      else session = 0.60;                       // late: calmer

      // Volatility clustering wave (slow sinusoid + random walk envelope)
      st._volPhase = (st._volPhase==null) ? seeded(hashSeed("VP|" + this.seedStr))()*Math.PI*2 : st._volPhase;
      st._volPhase += 0.012 + 0.004*seeded(st.tickSeed ^ 0xBADC0DE)(); // slow drift
      const wave = 0.78 + 0.35*Math.sin(st._volPhase) + 0.10*Math.sin(st._volPhase*0.27);
      st._volEnv = (st._volEnv==null) ? wave : (st._volEnv*0.992 + wave*0.008);

      // Order-flow imbalance (OFI) random walk that skews micro-moves (bid/ask pressure illusion)
      st._ofi = (st._ofi==null) ? 0 : st._ofi;
      const ofStep = (seeded(st.tickSeed ^ 0xFACEFEED)()*2-1) * 0.10;
      st._ofi = clamp(st._ofi*0.985 + ofStep, -1, 1);

      // End-of-minute “print” acceleration: last ~4.5s slightly faster/jerkier (Bloomberg-y)
      const ms = performance.now() % 60000;
      const accel = (ms > 55500) ? (1 + (ms-55500)/4500 * 0.55) : 1.0;
      // Spread microstructure (bid/ask ladder illusion): spread widens with vol and compresses in calm regimes.
      // Stored for rendering as a subtle right-edge band + bid/ask stubs (Bloomberg feel, low-flicker).
      st._sprBase = (st._sprBase==null) ? (this.base * 0.0012) : st._sprBase; // ~12bp baseline (scaled)
      const volScale = clamp((st.sigmaNow / Math.max(1e-9, st.sigmaBase)), 0.7, 2.2);
      const sprWave = 0.75 + 0.55*st._volEnv;
      const sprSess = 0.85 + 0.35*(session-0.6); // slightly wider in active sessions
      const sprAcc  = 0.90 + 0.25*(accel-1.0);
      const spread = st._sprBase * volScale * sprWave * sprSess * sprAcc;

      // Bid/ask mid oscillation with OFI skew
      const micro = (seeded(st.tickSeed ^ 0xC001D00D)()*2-1) * spread * 0.22;
      const ofiSkew = st._ofi * spread * 0.18;
      this._bbSpread = spread;
      this._bbMidSkew = ofiSkew;
      this._bbMicro = micro;

// Occasional jumps (rare, but visible)
      let jump = 0;
      const rj = seeded(st.tickSeed ^ 0x1337BEEF)();
      if(rj < st.jumpProb){
        const sign = (seeded(st.tickSeed ^ 0xDEADBEEF)() < 0.5) ? -1 : 1;
        jump = sign * st.jumpScale * st.sigmaBase * (0.6 + 1.2*seeded(st.tickSeed ^ 0xC0FFEE)());
      }

      // Micro move with smoothing (prevents flicker; terminal-like continuous tape)
      const rawMove = ((st.driftTick + st.trend) + (st._ofi * st.sigmaBase * 0.12)) + (z * st.sigmaNow * session * st._volEnv * accel) + jump;
      const prevTarget = (this.stream && this.stream.nextLast!=null) ? this.stream.nextLast : prev.v;
      const target = prevTarget + rawMove * (0.55 + 0.9*(1 - st.smoothness));
      // Derive a synthetic bid/ask around the evolving last (mid) with micro + OFI skew.
      const mid = target + (this._bbMicro||0) + (this._bbMidSkew||0);
      this._bbBid = mid - (this._bbSpread||0)/2;
      this._bbAsk = mid + (this._bbSpread||0)/2;
      this._bbBAts = performance.now();


      this._primeTail(target);
      // keep the stored last value equal to the target so y-scaling includes it
      last.v = target;

      // volume track update (if present) tied to absolute return (more realistic microstructure)
      if(this.volumePoints && this.volumePoints.length === pts.length){
        const vpts = this.volumePoints;
        const vlast = vpts[vpts.length-1];
        const vprev = vpts[vpts.length-2];
        const ret = Math.abs((last.v - prev.v) / (Math.abs(prev.v) || 1));
        const vs = seeded(hashSeed("VOL|" + this.seedStr + "|" + this._tickN + "|" + Math.floor(performance.now())))();
        const vj = (vs*2-1) * (Math.abs(vprev.v)*0.0012);
        // spike volume on bigger moves, with mild mean reversion
        vlast.v = Math.max(0, vprev.v + vj + (ret * (Math.abs(vprev.v) * 2.5)));
      }

      // update compare overlays (keep them “alive” too)
      for(const [k, cpts] of this.compareSeries.entries()){
        if(cpts.length<10) continue;
        const clast=cpts[cpts.length-1];
        const cprev=cpts[cpts.length-2];
        const cs = seeded(hashSeed((k||"CMP") + "|" + this.seedStr + "|" + this._tickN + "|" + Math.floor(performance.now())))();
        const cj = (cs*2-1) * (Math.abs(cprev.v)*0.0006);
        clast.v = cprev.v + cj;
      }

      // keep y-scaling stable; recompute occasionally or if we approach bounds
      const pad = (this.view.y1 - this.view.y0) * 0.03;
      const vNow = last.v;
      if((this._tickN % 8 === 0) || vNow < (this.view.y0 + pad) || vNow > (this.view.y1 - pad)){
        this.recomputeY();
      }
      // No immediate render here: RAF loop repaints continuously while tweening.
    }

    render(){
      const ctx=this.ctx, W=this.W, H=this.H, pts=this.points;
      // base
      ctx.fillStyle="#0a0b0d";
      ctx.fillRect(0,0,W,H);
      if(!pts || pts.length<2) return;

      const {i0,i1,y0,y1}=this.view;
      const tailOverride = this._tailValue();
      const padL=16, padR=52, padT=12, padB=24;
      const x0=padL, xRight=this.fullRightX();
      const yTop=padT, yBot=H-padB;

      // vertical grid
      ctx.lineWidth=1;
      ctx.strokeStyle="#1c1f26";
      ctx.beginPath();
      const vCount=10;
      for(let k=0;k<=vCount;k++){
        const x=x0 + (xRight-x0)*(k/vCount);
        ctx.moveTo(x,yTop); ctx.lineTo(x,yBot);
      }
      ctx.stroke();

      // horizontal grid
      const yticks=niceTicks(y0,y1,7);
      ctx.strokeStyle="#161820";
      ctx.beginPath();
      for(const tv of yticks){
        const y=this.mapY(tv);
        ctx.moveTo(x0,y); ctx.lineTo(xRight,y);
      }
      ctx.stroke();

      // right labels
      ctx.fillStyle="#a9a9a9";
      ctx.font=`12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
      ctx.textAlign="left"; ctx.textBaseline="middle";
      for(const tv of yticks){
        const y=this.mapY(tv);
        const label=(Math.abs(tv)>=1000)?Math.round(tv).toString():tv.toFixed(2);
        ctx.fillText(label, xRight+8, y);
      }

      // orange ref line (period open)
      const ref=pts[i0]?.v ?? pts[0].v;
      const yRef=this.mapY(ref);
      ctx.strokeStyle="#ff9f1a";
      ctx.setLineDash([2,3]);
      ctx.beginPath(); ctx.moveTo(x0,yRef); ctx.lineTo(xRight,yRef); ctx.stroke();
      ctx.setLineDash([]);

      // additional overlays (threshold bands, regime markers, etc.)
      if(this.overlaysEnabled && this.overlays && this.overlays.length){
        ctx.font=`11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
        ctx.textAlign="left"; ctx.textBaseline="middle";
        for(const ol of this.overlays){
          if(!ol) continue;
          const y = this.mapY(ol.y);
          ctx.strokeStyle = ol.color || "rgba(255,255,255,.22)";
          ctx.lineWidth = 1;
          ctx.setLineDash(ol.dash || [4,4]);
          ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(xRight,y); ctx.stroke();
          ctx.setLineDash([]);
          if(ol.label){
            const txt = String(ol.label);
            const tw = ctx.measureText(txt).width;
            ctx.fillStyle="rgba(10,11,13,.85)";
            ctx.fillRect(x0+6, y-9, tw+10, 18);
            ctx.strokeStyle="rgba(255,255,255,.14)";
            ctx.strokeRect(x0+6, y-9, tw+10, 18);
            ctx.fillStyle=ol.textColor || "#cfcfcf";
            ctx.fillText(txt, x0+11, y);
          }
        }
      }

      // render modes
      if(this.kind === "strip"){
        // ForumFlow-style strip: centered baseline, signed bars (cyan for positive, red for negative)
        const mid = (yTop + yBot) / 2;
        // midline
        ctx.strokeStyle = "rgba(255,255,255,.16)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(x0, mid); ctx.lineTo(xRight, mid); ctx.stroke();

        // bars
        const amp = (yBot - yTop) * 0.40;
        for(let i=i0;i<i1;i++){
          const x = this.mapX(i);
          const v = pts[i].v;
          const dv = v - ref; // ref acts as baseline anchor
          const h = clamp(dv / (Math.abs(ref)||1), -1, 1) * amp;
          ctx.strokeStyle = (h>=0) ? "rgba(56,189,248,.85)" : "rgba(248,113,113,.75)";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, mid);
          ctx.lineTo(x, mid - h);
          ctx.stroke();
        }

        // last marker + extension
        const lastV = (tailOverride!=null)?tailOverride:pts[i1-1].v;
        const dvLast = lastV - ref;
        const hLast = clamp(dvLast / (Math.abs(ref)||1), -1, 1) * amp;
        const yLast = mid - hLast;
        const lastX = this.mapX(i1-1);

        ctx.strokeStyle="rgba(243,245,247,.85)";
        ctx.lineWidth=1.0;
        ctx.beginPath(); ctx.moveTo(lastX,yLast); ctx.lineTo(xRight,yLast); ctx.stroke();

        // last label (shows strip value)
        const label = round3(lastV);
        ctx.font=`12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
        const tw = ctx.measureText(label).width;
        const boxW = tw+16, boxH=18;
        const bx = xRight+2;
        const by = clamp(yLast-boxH/2, yTop+2, yBot-boxH-2);
        ctx.fillStyle="rgba(10,11,13,.95)";
        ctx.fillRect(bx,by,boxW,boxH);
        ctx.strokeStyle="rgba(255,255,255,.18)";
        ctx.strokeRect(bx,by,boxW,boxH);
        ctx.fillStyle="#f3f5f7";
        ctx.textAlign="left"; ctx.textBaseline="middle";
        ctx.fillText(label, bx+8, by+boxH/2);

      } else {

      ctx.beginPath();
      for(let i=i0;i<i1;i++){
        const x=this.mapX(i);
        const y=this.mapY((i===i1-1 && tailOverride!=null)?tailOverride:pts[i].v);
        if(i===i0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      const lastX=this.mapX(i1-1);
      ctx.lineTo(lastX,yBot);
      ctx.lineTo(this.mapX(i0), yBot);
      ctx.closePath();

      const g=ctx.createLinearGradient(0,yTop,0,yBot);
      g.addColorStop(0,"#0b2a5a");
      g.addColorStop(1,"#08224a");
      ctx.fillStyle=g;
      ctx.globalAlpha=0.92;
      ctx.fill();
      ctx.globalAlpha=1;

      // white line
      ctx.beginPath();
      for(let i=i0;i<i1;i++){
        const x=this.mapX(i);
        const y=this.mapY((i===i1-1 && tailOverride!=null)?tailOverride:pts[i].v);
        if(i===i0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle="#f3f5f7";
      ctx.lineWidth=1.2;
      ctx.stroke();

      // comparison overlays (toggleable) — mapped as % change vs window ref (so lines are visible & comparable)
      if(this.compares.length){
        const palette = ["rgba(56,189,248,.85)","rgba(168,85,247,.75)","rgba(34,211,238,.70)","rgba(250,204,21,.55)","rgba(248,113,113,.65)"];
        let pi=0;

        const refP = (pts[i0]?.v ?? pts[0].v);
        for(const c of this.compares){
          if(!this.compareEnabled.has(c.key)) continue;
          const cpts = this.compareSeries.get(c.key);
          if(!cpts || cpts.length<2) continue;

          // align by index (same synthetic calendar); if lengths differ, clamp
          const j0 = Math.min(i0, cpts.length-2);
          const j1 = Math.min(i1, cpts.length);

          const refC = (cpts[j0]?.v ?? cpts[0].v);
          if(!isFinite(refC) || refC===0) continue;

          ctx.beginPath();
          for(let j=j0;j<j1;j++){
            const x=this.mapX(j);
            const pct = (cpts[j].v - refC) / refC;
            const vMapped = refP * (1 + pct);     // map compare into main price space
            const y=this.mapY(vMapped);
            if(j===j0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.strokeStyle = c.color || palette[pi % palette.length];
          ctx.lineWidth = 1.05;
          ctx.stroke();
          pi++;
        }
      }

ctx.stroke();

      // extend last price into future space
      const lastV=(tailOverride!=null)?tailOverride:pts[i1-1].v;
      const yLast=this.mapY(lastV);
      ctx.strokeStyle="rgba(243,245,247,.85)";
      ctx.lineWidth=1.0;
      ctx.beginPath();
      ctx.moveTo(lastX,yLast);
      ctx.lineTo(xRight,yLast);
      ctx.stroke();

      // last price label box
      const label=round3(lastV);
      ctx.font=`12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
      const tw=ctx.measureText(label).width;
      const boxW=tw+16, boxH=18;
      const bx=xRight+2;
      const by=clamp(yLast-boxH/2, yTop+2, yBot-boxH-2);
      ctx.fillStyle="rgba(10,11,13,.95)";
      ctx.fillRect(bx,by,boxW,boxH);
      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.strokeRect(bx,by,boxW,boxH);
      ctx.fillStyle="#f3f5f7";
      ctx.textAlign="left"; ctx.textBaseline="middle";
      ctx.fillText(label, bx+8, by+boxH/2);

      // volume bars (priceVolume panels)
      if(this.kind === "priceVolume" && this.volumePoints && this.volumePoints.length){
        const vpts = this.volumePoints;
        // compute range
        let vlo=Infinity, vhi=-Infinity;
        for(let i=i0;i<i1;i++){
          const v=vpts[i]?.v;
          if(v==null) continue;
          if(v<vlo) vlo=v;
          if(v>vhi) vhi=v;
        }
        const vPad = (vhi-vlo)*0.10 || (Math.abs(vhi)||1)*0.05;
        vlo -= vPad; vhi += vPad;

        const volTop = yBot - Math.round((yBot-yTop)*0.22);
        const volBot = yBot;

        // separator
        ctx.strokeStyle="rgba(255,255,255,.12)";
        ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(x0, volTop); ctx.lineTo(xRight, volTop); ctx.stroke();

        // bars
        const barW = Math.max(1, (this.mapX(i0+1) - this.mapX(i0)) * 0.65);
        for(let i=i0;i<i1;i++){
          const x = this.mapX(i) - barW/2;
          const vv = vpts[i]?.v ?? 0;
          const t = (vv - vlo) / (vhi - vlo || 1);
          const h = clamp(t,0,1) * (volBot - volTop - 6);
          // neutral gray-blue, but brighten on “up” days
          const up = (i>0 ? (pts[i].v - pts[i-1].v) : 0) >= 0;
          ctx.fillStyle = up ? "rgba(56,189,248,.22)" : "rgba(248,113,113,.18)";
          ctx.fillRect(x, volBot - h, barW, h);
        }

        // volume label (left)
        ctx.font=`11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
        ctx.fillStyle="#8a8a8a";
        ctx.textAlign="left"; ctx.textBaseline="top";
        ctx.fillText("VOL", x0+2, volTop+3);
      }


      }

      // bottom date labels
      ctx.fillStyle="#8a8a8a";
      ctx.textAlign="center"; ctx.textBaseline="top";
      const tCount=6;
      for(let k=0;k<=tCount;k++){
        const i=Math.round(i0 + (i1-i0-1)*(k/tCount));
        const x=this.mapX(i);
        ctx.fillText(fmtDateUTC(pts[i].t), x, yBot+6);
      }


      // --- right-edge "last tick" pulse (Bloomberg-style, low-flicker) ---
      // Multi-stroke glow with exponential decay: readable ticks without “strobing”.
      if(this._tickFlashTs){
        const age = performance.now() - this._tickFlashTs;
        if(age < 320){
          const a = Math.exp(-age/110); // smooth decay
          const xPulse = xRight + 0.5;
          const yLast = this.mapY(this._tailValue(), yTop, yBot);
          // Subtle bid/ask band + stubs (no flicker): decays with the same pulse envelope.
          if(this._bbBid!=null && this._bbAsk!=null){
            const yBid = this.mapY(this._bbBid, yTop, yBot);
            const yAsk = this.mapY(this._bbAsk, yTop, yBot);
            const bandTop = Math.min(yBid, yAsk);
            const bandBot = Math.max(yBid, yAsk);

            ctx.fillStyle = `rgba(243,245,247,${0.02 + 0.06*a})`;
            ctx.fillRect(xRight - 36, bandTop, 36, Math.max(1, bandBot-bandTop));

            // bid/ask stubs
            ctx.strokeStyle = `rgba(243,245,247,${0.08 + 0.22*a})`;
            ctx.lineWidth = 1.2;
            ctx.beginPath(); ctx.moveTo(xRight - 22, yBid); ctx.lineTo(xRight, yBid); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(xRight - 22, yAsk); ctx.lineTo(xRight, yAsk); ctx.stroke();
          }


          ctx.save();

          // vertical glow (3 passes: wide -> thin)
          ctx.strokeStyle = `rgba(243,245,247,${0.08 + 0.18*a})`;
          ctx.lineWidth = 3.5;
          ctx.beginPath(); ctx.moveTo(xPulse, yTop); ctx.lineTo(xPulse, yBot); ctx.stroke();

          ctx.strokeStyle = `rgba(243,245,247,${0.10 + 0.34*a})`;
          ctx.lineWidth = 2.0;
          ctx.beginPath(); ctx.moveTo(xPulse, yTop); ctx.lineTo(xPulse, yBot); ctx.stroke();

          ctx.strokeStyle = `rgba(243,245,247,${0.14 + 0.62*a})`;
          ctx.lineWidth = 1.1;
          ctx.beginPath(); ctx.moveTo(xPulse, yTop); ctx.lineTo(xPulse, yBot); ctx.stroke();

          // last-price stub (2 passes) to “prove” the refresh happened
          ctx.strokeStyle = `rgba(243,245,247,${0.06 + 0.26*a})`;
          ctx.lineWidth = 2.0;
          ctx.beginPath(); ctx.moveTo(xRight - 28, yLast); ctx.lineTo(xRight, yLast); ctx.stroke();

          ctx.strokeStyle = `rgba(243,245,247,${0.10 + 0.50*a})`;
          ctx.lineWidth = 1.0;
          ctx.beginPath(); ctx.moveTo(xRight - 22, yLast); ctx.lineTo(xRight, yLast); ctx.stroke();

          ctx.restore();
        }
      }

      // crosshair + Bloomberg-style cursor labels
      if(this.view.hoverX!==null){
        ctx.strokeStyle="rgba(243,245,247,.28)";
        ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(this.view.hoverX,yTop); ctx.lineTo(this.view.hoverX,yBot); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x0,this.view.hoverY); ctx.lineTo(xRight,this.view.hoverY); ctx.stroke();

        // top date label (above cursor)
        const idx = (this.hoverIndex!=null) ? this.hoverIndex : this.nearestIndexFromX(this.view.hoverX);
        const dp = pts[idx];
        if(dp){
          const dateTxt = fmtDateUTC(dp.t) + " UTC";
          ctx.font=`11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace`;
          const dtw = ctx.measureText(dateTxt).width;
          const bh = 18, bw = dtw + 16;
          const bx0 = clamp(this.view.hoverX - bw/2, x0, xRight - bw);
          const by0 = yTop + 2;
          ctx.fillStyle="rgba(10,11,13,.95)";
          ctx.fillRect(bx0, by0, bw, bh);
          ctx.strokeStyle="rgba(255,255,255,.18)";
          ctx.strokeRect(bx0, by0, bw, bh);
          ctx.fillStyle="#f3f5f7";
          ctx.textAlign="center"; ctx.textBaseline="middle";
          ctx.fillText(dateTxt, bx0 + bw/2, by0 + bh/2);

          // right value label at cursor (like Bloomberg)
          const vTxt = round3(dp.v) + (this.unit ? (" " + this.unit) : "");
          const vtw = ctx.measureText(vTxt).width;
          const vbw = vtw + 16, vbh = 18;
          const vbx = xRight + 2;
          const vby = clamp(this.view.hoverY - vbh/2, yTop+2, yBot - vbh - 2);
          ctx.fillStyle="rgba(10,11,13,.95)";
          ctx.fillRect(vbx, vby, vbw, vbh);
          ctx.strokeStyle="rgba(255,255,255,.18)";
          ctx.strokeRect(vbx, vby, vbw, vbh);
          ctx.fillStyle="#f3f5f7";
          ctx.textAlign="left"; ctx.textBaseline="middle";
          ctx.fillText(vTxt, vbx + 8, vby + vbh/2);
        }
      }
}
  }

  // ---------- fullscreen overlay (no layout changes) ----------
  function ensureFSOverlay(){
    if(document.getElementById("bkFsOverlay")) return;
    const style=document.createElement("style");
    style.textContent = `
      #bkFsOverlay{position:fixed; inset:0; background:#050607; z-index:9999; display:none;}
      #bkFsOverlay.on{display:block;}
      #bkFsInner{position:absolute; inset:10px; border:1px solid #141821; border-radius:14px; overflow:hidden; background:#0a0b0d;
        box-shadow:0 30px 90px rgba(0,0,0,.6);}
      #bkFsTop{padding:10px 12px; background:linear-gradient(180deg,#101118,#0b0c0e); border-bottom:1px solid #171a20;
        display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
      #bkFsTitle{font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; color:#dcdcdc;}
      #bkFsExit{font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;
        color:#cfcfcf; padding:8px 10px; border:1px solid #1c2030; background:rgba(255,255,255,.02); border-radius:8px; cursor:pointer;}
      #bkFsExit:hover{background:rgba(255,255,255,.04);}
      
      #bkFsControls{padding:8px 12px; border-bottom:1px solid #171a20; background:#0b0c0e; display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
      #bkFsRanges{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
      .bkRangeBtn{font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;
        color:#cfcfcf; padding:7px 8px; border:1px solid #1c2030; background:rgba(255,255,255,.02); border-radius:8px; cursor:pointer; user-select:none;}
      .bkRangeBtn:hover{background:rgba(255,255,255,.04);}
      .bkRangeBtn.active{border-color:#2b3550; box-shadow: inset 0 -2px 0 #ff9f1a;}
      #bkFsCompares{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
      .bkCmp{display:flex; gap:6px; align-items:center; font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; color:#cfcfcf;}
      .bkCmp input{accent-color:#ff9f1a;}

      #bkFsMount{position:relative;}
      #bkFsMount canvas{width:100% !important; height:calc(100vh - 140px) !important; display:block;}
    `;
    document.head.appendChild(style);

    const ov=document.createElement("div");
    ov.id="bkFsOverlay";
    ov.innerHTML = `
      <div id="bkFsInner">
        <div id="bkFsTop">
          <div id="bkFsTitle">—</div>
          <div id="bkFsExit">Exit Fullscreen (Esc)</div>
        </div>
        <div id="bkFsControls">
          <div id="bkFsRanges"></div>
          <div id="bkFsCompares"></div>
        </div>
        <div id="bkFsMount"></div>
      </div>
    `;
    document.body.appendChild(ov);

    const exit=()=>exitFS();
    ov.addEventListener("mousedown",(e)=>{ if(e.target===ov) exit(); });
    document.getElementById("bkFsExit").addEventListener("click", exit);
  }

  let fsState = {on:false, canvas:null, parent:null, next:null, chart:null, mount:null, titleEl:null};

  function enterFS(chart, title){
    ensureFSOverlay();
    const ov=document.getElementById("bkFsOverlay");
    const mount=document.getElementById("bkFsMount");
    const titleEl=document.getElementById("bkFsTitle");

    const canvas=chart.canvas;
    fsState = {
      on:true, canvas, parent: canvas.parentNode, next: canvas.nextSibling, chart,
      mount, titleEl
    };

    titleEl.textContent = title || chart.title || "Chart";
    // build fullscreen controls (range + compare toggles)
    const rangesEl = document.getElementById("bkFsRanges");
    const comparesEl = document.getElementById("bkFsCompares");
    if(rangesEl){
      const keys = ["1D","1W","1M","3M","6M","YTD","1Y","5Y","10Y","MAX"];
      rangesEl.innerHTML = keys.map(k=>`<div class="bkRangeBtn" data-r="${k}">${k}</div>`).join("");
      const setActive = ()=>{
        rangesEl.querySelectorAll(".bkRangeBtn").forEach(b=>{
          b.classList.toggle("active", b.getAttribute("data-r") === chart.rangeKey);
        });
      };
      rangesEl.querySelectorAll(".bkRangeBtn").forEach(b=>{
        b.addEventListener("click", ()=>{
          const r = b.getAttribute("data-r");
          chart.applyRange(r);
          setActive();
        });
      });
      setActive();
    }
    if(comparesEl){
      if(chart.compares && chart.compares.length){
        comparesEl.innerHTML = chart.compares.map((c,idx)=>`
          <label class="bkCmp" title="${c.label || c.key}">
            <input type="checkbox" data-k="${c.key}" ${chart.compareEnabled.has(c.key) ? "checked":""}/>
            <span>${c.label || c.key}</span>
          </label>
        `).join("");
        comparesEl.querySelectorAll("input[type=checkbox]").forEach(cb=>{
          cb.addEventListener("change", ()=>{
            chart.setCompareEnabled(cb.getAttribute("data-k"), cb.checked);
          });
        });
      }else{
        comparesEl.innerHTML = `<span style="color:#7c7c7c; font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;">Overlays: none</span>`;
      }
    }

    mount.innerHTML="";
    mount.appendChild(canvas);
    ov.classList.add("on");
    setTimeout(()=>chart.resize(), 60);
  }

  function exitFS(){
    if(!fsState.on) return;
    const ov=document.getElementById("bkFsOverlay");
    const {canvas,parent,next,chart}=fsState;

    if(next) parent.insertBefore(canvas, next);
    else parent.appendChild(canvas);

    ov.classList.remove("on");
    fsState = {on:false, canvas:null, parent:null, next:null, chart:null, mount:null, titleEl:null};

    setTimeout(()=>chart.resize(), 60);
  }

  // ---------- bind charts to existing canvases ----------
  const chartMap = new Map();
  const chartMeta = new Map(); // chart -> baseline params
  function registerMeta(chart, meta){ if(chart) chartMeta.set(chart, meta); }

  function bindChart(canvasId, cfg){
    const c = $(canvasId);
    if(!c) return null;
    const chart = new BloombergCanvasChart(c, cfg);
    chartMap.set(canvasId, chart);
    return chart;
  }

  // Use existing select values to seed main chart (stable drawing per selection)
  function currentScenario(){ return $("scenarioSelect")?.value || "baseline"; }
  function currentAsset(){ return $("assetSelect")?.value || "BK Macro Composite"; }
  function currentOverlay(){ return $("overlaySelect")?.value || "BK Policy Volatility Gauge"; }
  function currentTheme(){ return document.documentElement.getAttribute("data-theme") || "default"; }


  function scenarioParams(s){
    // multipliers tuned for visually realistic regime shifts
    switch(String(s||"baseline")){
      case "energy":  return {driftMul:0.90, volMul:1.45, shockMul:1.65, meanRevMul:0.95};
      case "easing":  return {driftMul:1.10, volMul:0.92, shockMul:0.85, meanRevMul:1.05};
      case "riskoff": return {driftMul:0.80, volMul:1.70, shockMul:1.95, meanRevMul:0.95};
      case "tech":    return {driftMul:1.25, volMul:1.10, shockMul:1.05, meanRevMul:0.98};
      case "baseline":
      default:        return {driftMul:1.00, volMul:1.00, shockMul:1.00, meanRevMul:1.00};
    }
  }

  
  function buildComparesFor(asset, overlay, scenario){
    // Toggleable comparison overlays: synthetic but stable; keyed to current selections
    const a = asset || "BK Macro Composite";
    const o = overlay || "Overlay";
    const s = scenario || "baseline";
    return [
      {key:"OVR", label:"Overlay", seedStr:`CMP|OVR|${s}|${a}|${o}`, base:100, drift:0.018, vol:0.50, shock:-1.2, meanRev:0.0012, defaultOn:true},
      {key:"TPVI", label:"TPVI", seedStr:`CMP|TPVI|${s}|${a}|${o}`, base:0.42, drift:0.0002, vol:0.006, shock:0.03, meanRev:0.03},
      {key:"GDFI", label:"GDFI", seedStr:`CMP|GDFI|${s}|${a}|${o}`, base:0.38, drift:0.0001, vol:0.005, shock:0.02, meanRev:0.03},
      {key:"WSB", label:"ForumFlow", seedStr:`CMP|WSB|${s}|${a}|${o}`, base:0.02, drift:0.0, vol:0.02, shock:0.06, meanRev:0.06},
      {key:"USD", label:"USD / DXY", seedStr:`CMP|USD|${s}|${a}`, base:98, drift:-0.002, vol:0.18, shock:-0.6, meanRev:0.0016},
      {key:"R10", label:"Rates / 10Y", seedStr:`CMP|R10|${s}|${a}`, base:4.5, drift:0.0004, vol:0.03, shock:0.08, meanRev:0.004},
      {key:"EQ",  label:"Equities", seedStr:`CMP|EQ|${s}|${a}`, base:100, drift:0.025, vol:0.65, shock:-2.0, meanRev:0.0011},
      {key:"CMD", label:"Commodities", seedStr:`CMP|CMD|${s}|${a}`, base:100, drift:0.012, vol:0.55, shock:1.4, meanRev:0.0013},
    ];
  }



  const mainChart = bindChart("mainChart", {
    title: "BK Macro Composite",
    seedStr: "MAIN|" + currentScenario() + "|" + currentAsset() + "|" + currentOverlay() + "|" + currentTheme(),
    base: 100, drift: 0.006, vol: 0.68, shock: 1.9, meanRev: 0.0016, shockMode: "both", cycleAmp: 0.22, cyclePeriod: 260, jumpProb: 0.012, jumpScale: 0.85,
    compares: buildComparesFor(currentAsset(), currentOverlay(), currentScenario())
  });

  registerMeta(mainChart, {key:"MAIN", base:100, drift:0.006, vol:0.68, shock:1.9, meanRev:0.0016, unit:"", shockMode:"both", cycleAmp:0.22, cyclePeriod:260, jumpProb:0.012, jumpScale:0.85});

  // Boot: main chart fully zoomed-out to horizon and overlays ON
  try{ mainChart?.applyRange("10Y", true); mainChart?.render(); }catch(e){}

  const priceVol = bindChart("priceVolumeChart", {
    title: "Price · Volume micro-panel",
    kind: "priceVolume",
    seedStr: "PV|" + currentScenario() + "|" + currentAsset(),
    base: 100, drift: 0.02, vol: 0.62, shock: -1.2, meanRev: 0.0012
  });

  registerMeta(priceVol, {key:"PV", base:100, drift:0.02, vol:0.62, shock:-1.2, meanRev:0.0012, unit:""});

  const kmri = bindChart("kmriChart", { title:"KMRI", seedStr:"KMRI", base:0.55, drift:0.0002, vol:0.004, shock:-0.02, meanRev:0.01,
    overlays:[
      {y:0.45,label:"LOW",color:"rgba(248,113,113,.55)",dash:[4,4]},
      {y:0.55,label:"MID",color:"rgba(255,159,26,.55)",dash:[4,4]},
      {y:0.65,label:"HIGH",color:"rgba(56,189,248,.45)",dash:[4,4]},
    ]
  });

  registerMeta(kmri, {key:"KMRI", base:0.55, drift:0.0002, vol:0.004, shock:-0.02, meanRev:0.01, unit:""});
  const spread = bindChart("macroSpreadChart", { title:"Core vs headline vs income spread", seedStr:"SPREAD", base:0.50, drift:0.0001, vol:0.004, shock:0.02, meanRev:0.01 });

  registerMeta(spread, {key:"SPREAD", base:0.5, drift:0.0001, vol:0.004, shock:0.02, meanRev:0.01, unit:""});
  const policy = bindChart("policyMixChart", { title:"Policy mix & financial conditions", seedStr:"POLICY", base:0.50, drift:0.0001, vol:0.004, shock:0.02, meanRev:0.01 });

  registerMeta(policy, {key:"POLICY", base:0.5, drift:0.0001, vol:0.004, shock:0.02, meanRev:0.01, unit:""});

  const wsb = bindChart("wsbChart", { title:"ForumFlow-WSB strip", kind:"strip", seedStr:"WSB", base:0.02, drift:0.0, vol:0.02, shock:0.06, meanRev:0.06 });

  registerMeta(wsb, {key:"WSB", base:0.02, drift:0.0, vol:0.02, shock:0.06, meanRev:0.06, unit:""});
  const pcg = bindChart("pcgChart", { title:"Participation-Conviction Gauge", seedStr:"PCG", base:0.25, drift:0.0002, vol:0.01, shock:0.03, meanRev:0.03 });

  registerMeta(pcg, {key:"PCG", base:0.25, drift:0.0002, vol:0.01, shock:0.03, meanRev:0.03, unit:""});
  const snap = bindChart("sentimentChart", { title:"ForumFlow cross-asset snapshot", seedStr:"SNAP", base:0.0, drift:0.0, vol:0.02, shock:0.04, meanRev:0.08 });

  registerMeta(snap, {key:"SNAP", base:0.0, drift:0.0, vol:0.02, shock:0.04, meanRev:0.08, unit:""});
  const act = bindChart("sentActChart", { title:"ForumFlow activity & volume", seedStr:"ACT", base:0.10, drift:0.0, vol:0.015, shock:0.04, meanRev:0.08 });

  registerMeta(act, {key:"ACT", base:0.1, drift:0.0, vol:0.015, shock:0.04, meanRev:0.08, unit:""});

  const rsac = bindChart("rsacChart", { title:"RSAC stress channel", seedStr:"RSAC", base:0.45, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02 });

  registerMeta(rsac, {key:"RSAC", base:0.45, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02, unit:""});
  const housing = bindChart("housingChart", { title:"Housing & cost-of-living", seedStr:"HOUSE", base:0.55, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02 });

  registerMeta(housing, {key:"HOUSE", base:0.55, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02, unit:""});
  const labour = bindChart("labourChart", { title:"Labour & income dynamics", seedStr:"LAB", base:0.50, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02 });

  registerMeta(labour, {key:"LAB", base:0.5, drift:0.0001, vol:0.004, shock:0.03, meanRev:0.02, unit:""});

  // initial scenario/theme sync
  refreshAllSeeds();

  // ---------- range buttons (existing data-range="3M|6M|1Y|5Y") ----------
  function setRangeAll(rangeKey){
    // keep behaviour focused on main + related panels (most visible), but safe to apply to all
    for(const ch of chartMap.values()){
      ch.applyRange(rangeKey, false);
    }
  }
  document.querySelectorAll("[data-range]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const r = btn.getAttribute("data-range");
      setRangeAll(r);
    });
  });
  // ---------- selectors update ALL charts (scenario + asset + overlay) ----------
  function refreshAllSeeds(){
    const s = currentScenario();
    const a = currentAsset();
    const o = currentOverlay();
    const sp = scenarioParams(s);

    // Scenario label (keeps your layout intact)
    const lbl = $("scenarioStatusLabel");
    if(lbl){
      const map = {baseline:"Baseline", energy:"Energy transition stress", easing:"Policy easing bias", riskoff:"Risk-off phase · fragmentation", tech:"Tech upcycle · growth tilt"};
      lbl.textContent = "Scenario: " + (map[s] || s);
    }

    for(const ch of chartMap.values()){
      const meta = chartMeta.get(ch);
      if(!meta) continue;

      // Every chart is tied to the same lens so the entire dashboard pivots coherently
      ch.seedStr = `${meta.key}|${s}|${a}|${o}`;

      const drift = (meta.drift ?? ch.drift) * sp.driftMul;
      const vol   = (meta.vol   ?? ch.vol)   * sp.volMul;
      const shock = (meta.shock ?? ch.shock) * sp.shockMul;
      const meanRev = (meta.meanRev ?? ch.meanRev) * sp.meanRevMul;

      let base = meta.base ?? ch.base;
      // subtle regime tilt for the primary “price” panels only
      if((meta.key==="MAIN" || meta.key==="PV")){
        if(s==="riskoff") base = base * 0.985;
        if(s==="tech")   base = base * 1.012;
        if(s==="energy") base = base * 0.995;
        if(s==="easing") base = base * 1.005;
      }

      ch.points = makeSeries({seedStr: ch.seedStr, base, drift, vol, shockAt: (ch.shockAt ?? 0.72), shock, meanRev, shockMode: (ch.shockMode ?? "down"), cycleAmp: (ch.cycleAmp ?? 0), cyclePeriod: (ch.cyclePeriod ?? 180), jumpProb: (ch.jumpProb ?? 0), jumpScale: (ch.jumpScale ?? 1.0)});
      ch.applyRange(ch.rangeKey, true);

      if(ch === mainChart){
        ch.title = a;
        ch.replaceCompares(buildComparesFor(a, o, s));
      }

      ch.resize();
      ch.render();
    }

    // status ribbon values (KMRI / TPVI / GDFI / RSAC)
    const setTxt = (id, val)=>{
      const el = $(id);
      if(el && val!=null && Number.isFinite(val)) el.textContent = round3(val);
    };
    setTxt("statusKMRI", kmri?.points?.[kmri.points.length-1]?.v);
    // prefer compare overlays from main chart for TPVI/GDFI if present
    const tpviV = mainChart?.compareSeries?.get?.("TPVI")?.at?.(-1)?.v;
    const gdfiV = mainChart?.compareSeries?.get?.("GDFI")?.at?.(-1)?.v;
    setTxt("statusTPVI", tpviV ?? null);
    setTxt("statusGDFI", gdfiV ?? null);

    const theme = $("mainThemeLabel");
    if(theme) theme.textContent = `KMRI · ${a}`;
  }

  $("scenarioSelect")?.addEventListener("change", refreshAllSeeds);
  $("assetSelect")?.addEventListener("change", refreshAllSeeds);
  $("overlaySelect")?.addEventListener("change", refreshAllSeeds);

  // ---------- popout / fullscreen ----------
  // existing button id in your page
  $("popoutMainBtn")?.addEventListener("click", ()=>{
    if(mainChart) enterFS(mainChart, `${currentAsset()} · ${currentOverlay()} · ${currentScenario()}`);
  });


  // Add unobtrusive per-chart fullscreen button (does not alter layout flow)
  (function addMiniFSButtons(){
    const css = document.createElement("style");
    css.textContent = `
      .bkMiniFsBtn{position:absolute; top:8px; right:8px; z-index:5;
        font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;
        color:#cfcfcf; padding:6px 8px; border:1px solid #1c2030; background:rgba(10,11,13,.65);
        border-radius:8px; cursor:pointer; user-select:none; backdrop-filter: blur(6px);}
      .bkMiniFsBtn:hover{background:rgba(10,11,13,.80);}
    `;
    document.head.appendChild(css);

    document.querySelectorAll("canvas").forEach(c=>{
      const wrap = c.parentElement;
      if(!wrap) return;
      wrap.style.position = wrap.style.position || "relative";
      if(wrap.querySelector(".bkMiniFsBtn")) return;
      const btn = document.createElement("div");
      btn.className="bkMiniFsBtn";
      btn.textContent="Fullscreen";
      btn.title="Fullscreen (Alt+Click also works)";
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        for(const [id,ch] of chartMap.entries()){
          if(ch.canvas===c){ enterFS(ch, ch.title); break; }
        }
      });
      wrap.appendChild(btn);
    });


// Per-chart overlay controls (local to each chart window)
(function addPerChartOverlayControls(){
  const css = document.createElement("style");
  css.textContent = `
    .bkOvBtn{position:absolute; top:8px; right:90px; z-index:6;
      font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;
      color:#cfcfcf; padding:6px 8px; border:1px solid #1c2030; background:rgba(10,11,13,.65);
      border-radius:8px; cursor:pointer; user-select:none; backdrop-filter: blur(6px);}
    .bkOvBtn:hover{background:rgba(10,11,13,.80);}
    .bkOvPanel{position:absolute; top:40px; right:8px; z-index:7; min-width:220px; max-width:260px;
      border:1px solid rgba(148,163,184,.22); background:rgba(2,6,23,.96); border-radius:12px;
      box-shadow: 0 12px 32px rgba(0,0,0,.55); padding:10px 10px 8px; display:none;}
    .bkOvPanel.on{display:block;}
    .bkOvHdr{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
    .bkOvTitle{font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; color:#e5e7eb; letter-spacing:.06em;}
    .bkOvClose{font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; color:#9ca3af; cursor:pointer;}
    .bkOvClose:hover{color:#e5e7eb;}
    .bkOvSec{margin-top:6px; padding-top:8px; border-top:1px solid rgba(148,163,184,.14);}
    .bkOvLbl{color:#a7a7a7; font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; letter-spacing:.08em; text-transform:uppercase; margin-bottom:6px;}
    .bkOvItem{display:flex; align-items:center; gap:8px; margin:6px 0;}
    .bkOvItem input{accent-color:#ff9f1a;}
    .bkOvItem span{color:#e5e7eb; font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;}
    .bkOvHint{color:#7c7c7c; font:11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; margin-top:6px;}
  `;
  document.head.appendChild(css);

  function chartForCanvas(c){
    for(const ch of chartMap.values()){ if(ch && ch.canvas===c) return ch; }
    return null;
  }

  function closeAll(){
    document.querySelectorAll(".bkOvPanel.on").forEach(p=>p.classList.remove("on"));
  }

  document.addEventListener("mousedown",(e)=>{
    const t = e.target;
    if(t.closest && (t.closest(".bkOvPanel") || t.closest(".bkOvBtn"))) return;
    closeAll();
  });

  document.querySelectorAll("canvas").forEach(c=>{
    const wrap = c.parentElement;
    if(!wrap) return;

    const ch = chartForCanvas(c);
    if(!ch) return;

    wrap.style.position = wrap.style.position || "relative";
    if(wrap.querySelector(".bkOvBtn")) return;

    const btn = document.createElement("div");
    btn.className="bkOvBtn";
    btn.textContent="Overlays";
    btn.title="Toggle overlays for this chart";

    const panel = document.createElement("div");
    panel.className="bkOvPanel";
    panel.innerHTML = `
      <div class="bkOvHdr">
        <div class="bkOvTitle">CHART OVERLAYS</div>
        <div class="bkOvClose">Close</div>
      </div>
      <div class="bkOvItem">
        <input type="checkbox" class="bkOvThresh"/>
        <span>Threshold / regime lines</span>
      </div>
      <div class="bkOvSec bkOvCmpSec">
        <div class="bkOvLbl">Compare</div>
        <div class="bkOvCmpList"></div>
        <div class="bkOvHint">These toggles are per-chart and persist while the page is open.</div>
      </div>
    `;

    const close = panel.querySelector(".bkOvClose");
    close.addEventListener("click", ()=> panel.classList.remove("on"));

    // Threshold overlays toggle
    const threshCb = panel.querySelector(".bkOvThresh");
    const hasThresh = Array.isArray(ch.overlays) && ch.overlays.length>0;
    threshCb.checked = !!ch.overlaysEnabled;
    threshCb.disabled = !hasThresh;
    if(!hasThresh){
      panel.querySelector(".bkOvItem span").textContent = "Threshold / regime lines (none)";
    }
    threshCb.addEventListener("change", ()=> ch.setOverlaysEnabled(threshCb.checked));

    // Compare overlays list
    const cmpSec = panel.querySelector(".bkOvCmpSec");
    const cmpList = panel.querySelector(".bkOvCmpList");
    if(Array.isArray(ch.compares) && ch.compares.length){
      cmpList.innerHTML = ch.compares.map(c=>`
        <label class="bkOvItem" title="${c.label || c.key}">
          <input type="checkbox" data-k="${c.key}">
          <span>${c.label || c.key}</span>
        </label>
      `).join("");

      cmpList.querySelectorAll("input[type=checkbox]").forEach(cb=>{
        const k = cb.getAttribute("data-k");
        cb.checked = ch.compareEnabled.has(k);
        cb.addEventListener("change", ()=> ch.setCompareEnabled(k, cb.checked));
      });
    }else{
      cmpSec.querySelector(".bkOvLbl").textContent = "Compare";
      cmpList.innerHTML = `<div class="bkOvHint">No compare overlays registered for this chart.</div>`;
    }

    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      // refresh checkbox states (in case they were toggled elsewhere, e.g. fullscreen)
      threshCb.checked = !!ch.overlaysEnabled;
      if(Array.isArray(ch.compares) && ch.compares.length){
        cmpList.querySelectorAll("input[type=checkbox]").forEach(cb=>{
          const k = cb.getAttribute("data-k");
          cb.checked = ch.compareEnabled.has(k);
        });
      }
      const isOn = panel.classList.contains("on");
      closeAll();
      if(!isOn) panel.classList.add("on");
    });

    wrap.appendChild(btn);
    wrap.appendChild(panel);
  });
})();

  })();

  // Alt+Click any canvas => fullscreen
  document.querySelectorAll("canvas").forEach(c=>{
    c.addEventListener("click",(e)=>{
      if(!e.altKey) return;
      for(const [id,ch] of chartMap.entries()){
        if(ch.canvas===c){ enterFS(ch, ch.title); break; }
      }
    });
  });

  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape") exitFS();
  });

  // ---------- realtime tick scheduler ----------
// Bloomberg-style: decouple tick generation from paint.
// Ticks: high-cadence “tape” updates. Paint: requestAnimationFrame (display refresh).
const BK_TICK_MS = 40; // ~25Hz tick tape (tune 30–120)
let bkLastTick = performance.now();

function bkTickAll(){
  for(const ch of chartMap.values()){
    if(ch && typeof ch.tickUpdate === "function") ch.tickUpdate();
  }
}

// Primary: requestAnimationFrame catch-up loop (smooth, drift-free)
function bkTickLoop(ts){
  // If the tab is backgrounded, avoid accumulating backlog.
  if(document.hidden){
    bkLastTick = ts;
    requestAnimationFrame(bkTickLoop);
    return;
  }

  // Catch-up loop: never “miss” ticks if a frame is late.
  // This keeps the tape feeling continuous and deterministic.
  let n=0;
  while((ts - bkLastTick) >= BK_TICK_MS && n < 6){
    bkLastTick += BK_TICK_MS;
    bkTickAll();
    n++;
  }
  requestAnimationFrame(bkTickLoop);
}
requestAnimationFrame(bkTickLoop);

// Fallback timers (guarantee autonomous streaming even if RAF is throttled)
// 1) Tick generation at BK_TICK_MS cadence
setInterval(()=>{
  if(document.hidden) return;
  try{ bkTickAll(); }catch(e){}
}, BK_TICK_MS);

// 2) Low-flicker paint heartbeat (~30fps max) so charts never depend on pointer events
setInterval(()=>{
  if(document.hidden) return;
  const now = performance.now();
  for(const ch of chartMap.values()){
    if(!ch) continue;
    try{
      if(typeof ch.advance === "function") ch.advance(now);
      ch.render();
    }catch(e){}
  }
}, 33);

// ---------- continuous render loop (Bloomberg-feel: smooth tape, low flicker) ----------
  (function animate(ts){
    const now = ts || performance.now();
    for(const ch of chartMap.values()){
      if(!ch) continue;
      // advance continuous time-scroll; repaint if anything is moving/decaying
      let needs = false;
      if(typeof ch.advance === "function") needs = !!ch.advance(now);
      // Always repaint while: tail tweening, tick flash pulse decaying, or continuous scroll fraction non-zero
      if(!needs && ch._isTweening && ch._isTweening()) needs = true;
      if(!needs && ch._tickFlashTs && (now - ch._tickFlashTs) < 260) needs = true;
      if(!needs && ch.stream && ch.stream.xOffset && ch.stream.xOffset > 0.0001) needs = true;
      if(needs){ ch.render(); }
    }
    requestAnimationFrame(animate);
  })(performance.now());



  // ---------- resize ----------
  window.addEventListener("resize", ()=>{
    for(const ch of chartMap.values()) ch.resize();
  });

})();


</script>
</body>
</html>
